<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="Linux, Programming, Emacs">
<meta name="viewport" content="width=device-width">
<title>Chen's blog (old posts, page 17) | Chen's blog</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link rel="alternate" type="application/rss+xml" title="RSS" href="rss.xml">
<link rel="canonical" href="http://blog.binchen.org/index-17.html">
<!--[if lt IE 9]><script src="/assets/js/html5.js"></script><![endif]-->
</head>
<body>
    <section class="social"><ul>
<li><a href="index.html" title="Home"><i class="icon-home"></i></a></li>
            <li><a href="archive.html" title="Archives"><i class="icon-folder-open-alt"></i></a></li>
            <li><a href="categories/index.html" title="Tags"><i class="icon-tags"></i></a></li>
            <li><a href="rss.xml" title="RSS"><i class="icon-rss"></i></a></li>
            <li><a href="stories/about.html" title="About me"><i class="icon-user"></i></a></li>
            <li><a href="https://twitter.com/chen_bin" title="My Twitter"><i class="icon-twitter"></i></a></li>
            <li><a href="https://github.com/redguardtoo" title="My Github"><i class="icon-github"></i></a></li>

        </ul></section><section class="page-content"><div class="content" rel="main">
            
        <div class="post">
            <h1 class="title"><a href="posts/my-emacs-skills-is-improved-after-3-years/">My Emacs skill is improved after 3 years</a></h1>
            <div class="meta">
                <div class="authordate">
                    <time class="timeago" datetime="2014-09-17T13:30:34+00:00">2014-09-17 13:30</time>
</div>
                <div class="stats">
                    
        
    <a href="posts/my-emacs-skills-is-improved-after-3-years/#disqus_thread" data-disqus-identifier="cache/posts/my-emacs-skills-is-improved-after-3-years.html">Comments</a>


                </div>
            
        <div itemprop="keywords" class="tags">
        <ul>
        Tags : 
           <li><a class="tag p-category" href="categories/emacs/" rel="tag">emacs</a></li>
           <li><a class="tag p-category" href="categories/en/" rel="tag">en</a></li>
           <li><a class="tag p-category" href="categories/skill/" rel="tag">skill</a></li>
        </ul>
</div>

            </div>
            <div class="body">
                <div>
<p>
This is <a href="http://blog.binchen.org/posts/you-yong-de-emacs-kuai-jie-jian.html">my note on useful commands/keybindings to memorize</a> three years ago.
</p>

<p>
Most are obsolete because I'm more skillful now.
</p>

<p>
Basically I use <b>fewer</b> but more powerful plugins. I write Emacs lisp if there is no suitable plugin.
</p>

<ul class="org-ul">
<li>Three years ago, column edit,</li>
</ul>
<pre class="example">
C-x r t yourstring RET (See "How to do select column then do editing in GNU Emacs ?"")
</pre>

<p>
Now I use <a href="http://www.emacswiki.org/emacs/Evil">Evil</a>
</p>

<ul class="org-ul">
<li>Three years ago, save current position to register and jump to the position,</li>
</ul>
<pre class="example">
C-r SPC to save, C-j to jump (better-registers.el required) 
</pre>

<p>
Now Evil.
</p>

<ul class="org-ul">
<li>Three years ago, save frame configuration to register,</li>
</ul>
<pre class="example">
C-r f (better-registers.el required) 
</pre>

<p>
Now <a href="https://github.com/pashinin/workgroups2">workgroups2.</a>
</p>

<ul class="org-ul">
<li>Three year ago, (un)comment line,</li>
</ul>
<pre class="example">
M-; (qiang-comment-dwim-line required)
</pre>

<p>
Now <a href="https://github.com/redguardtoo/evil-nerd-commenter">evil-nerd-commenter.</a>
</p>

<ul class="org-ul">
<li>Three years ago for visiting the next/previous error message after compiling,</li>
</ul>
<pre class="example">
"M-g M-n" or "M-g M-p"
</pre>

<p>
I'm still using it.
</p>

<ul class="org-ul">
<li>Three years ago, find-tag/pop-tag-mark</li>
</ul>
<pre class="example">
"M-." and "M-*"
</pre>

<p>
Now Evil
</p>

<ul class="org-ul">
<li>Three years ago, grep current work directory only or all sub-directories</li>
</ul>
<pre class="example">
M-x lgrep/rgrep
</pre>

<p>
Now grep in shell plus <a href="https://github.com/mooz/percol">percol</a>
</p>

<ul class="org-ul">
<li>Three years ago, visit multiple tags table</li>
</ul>
<pre class="example">
M-x visit-tags-table
</pre>

<p>
<a href="http://blog.binchen.org/posts/how-to-use-ctags-in-emacs-effectively-3.html">hack tags-table-list directly</a> might be simpler.
</p>

<ul class="org-ul">
<li>Three years ago, set countdown timer</li>
</ul>
<pre class="example">
M-x org-timer-set-timer, C-c C-x ;
</pre>

<p>
Now I don't push myself with the timer thing.
</p>

<ul class="org-ul">
<li>Three years ago, mark subtree in org-mode</li>
</ul>
<pre class="example">
M-x org-mark-subtree
</pre>

<p>
It was used to select the text to post to my blog.
</p>

<p>
Now I use <a href="https://github.com/redguardtoo/org2nikola">org2nikola</a>. The org-mark-subtree is hardcoded into org2nikola.
</p>
</div>
            </div>
        </div>
        <div class="post">
            <h1 class="title"><a href="posts/how-to-accept-the-github-pull-request-efficiently/">How to accept the github pull request efficiently</a></h1>
            <div class="meta">
                <div class="authordate">
                    <time class="timeago" datetime="2014-08-01T13:52:18+00:00">2014-08-01 13:52</time>
</div>
                <div class="stats">
                    
        
    <a href="posts/how-to-accept-the-github-pull-request-efficiently/#disqus_thread" data-disqus-identifier="cache/posts/how-to-accept-the-github-pull-request-efficiently.html">Comments</a>


                </div>
            
        <div itemprop="keywords" class="tags">
        <ul>
        Tags : 
           <li><a class="tag p-category" href="categories/emacs/" rel="tag">emacs</a></li>
           <li><a class="tag p-category" href="categories/en/" rel="tag">en</a></li>
           <li><a class="tag p-category" href="categories/git/" rel="tag">git</a></li>
        </ul>
</div>

            </div>
            <div class="body">
                <div>
<p>
I use keyboard only in order to maximize my productivity.
</p>

<div id="outline-container-orgd36daa0" class="outline-2">
<h3 id="orgd36daa0">Preparation</h3>
<div class="outline-text-2" id="text-orgd36daa0">
<p>
Install Firefox addon <a href="https://github.com/mooz/keysnail/wiki">Keysnail</a> and its plugin <a href="https://github.com/mooz/keysnail/wiki/plugin">HOK</a>. From now on, all the web browsing is done ONLY in keyboard.
</p>
</div>
</div>

<div id="outline-container-org0f44341" class="outline-2">
<h3 id="org0f44341">Step 1</h3>
<div class="outline-text-2" id="text-org0f44341">
<p>
Open pull request page at github.com, click the link "command line".
</p>

<p>
In a real world project, I rarely accept a pull request without some modification. So I usually avoid pressing the big green button "merge pull request" on that page.
</p>

<p>
In the "command line" page, github is kind enough to list the command lines to "check out a new branch and test the changes" from the pull request. The command lines are like:
</p>
<div class="org-src-container">

<pre><code class="lang-sh">git checkout -b her-master master
git pull git@github.com:her/myproject.git master
</code></pre>

</div>
<p>
I have installed a Greasemonkey user script <a href="https://github.com/redguardtoo/NinjaWebCoder">NinjaWebCoder</a> in order to <b>use keyboard</b> to copy those command lines from the browser into clipboard. Then I paste the command lines into terminal.
</p>
</div>
</div>

<div id="outline-container-org703bf47" class="outline-2">
<h3 id="org703bf47">Step 2</h3>
<div class="outline-text-2" id="text-org703bf47">
<p>
I open the code file with Emacs.
</p>

<p>
There is an Emacs addon called <a href="https://github.com/syohex/emacs-git-gutter">git-gutter</a>. I use its command "git-gutter:next-hunk" to move the cursor to the next "diff hunk".
</p>

<p>
Let me explain what's the diff hunk. When you edit some code under git's control, you code has some difference with the HEAD version. Every difference corresponds to the pair of a file name and a line number. That file-name-line-number pair is defined as a "diff hunk".
</p>

<p>
Now comes <b>the most important part of this article</b>. Since version 0.71, git-gutter added a new command "git-gutter:set-start-version". If I "git-gutter:set-start-revision" to the "HEAD^" version. I can jump to "diff hunk" of the difference between "HEAD" and "HEAD^".
</p>

<p>
In short, I can <b>review the latest commit and change the code in one step</b>.
</p>
</div>
</div>

<div id="outline-container-orga35a2e2" class="outline-2">
<h3 id="orga35a2e2">Done</h3>
<div class="outline-text-2" id="text-orga35a2e2">
<p>
After review and code change, the remaining book-keeping things (git-commit/git-merge/git-push) are easy.
</p>

<p>
Every operation in previous steps is optimized with some shortcut. For example, in shell I use alias "g" instead of full command line "git status".
</p>

<p>
Please enlighten me if the work flow could be improved.</p>
</div>
</div>
</div>
            </div>
        </div>
        <div class="post">
            <h1 class="title"><a href="posts/how-to-do-the-file-navigation-efficiently/">How to do the file navigation efficiently</a></h1>
            <div class="meta">
                <div class="authordate">
                    <time class="timeago" datetime="2014-06-15T13:51:02+00:00">2014-06-15 13:51</time>
</div>
                <div class="stats">
                    
        
    <a href="posts/how-to-do-the-file-navigation-efficiently/#disqus_thread" data-disqus-identifier="cache/posts/how-to-do-the-file-navigation-efficiently.html">Comments</a>


                </div>
            
        <div itemprop="keywords" class="tags">
        <ul>
        Tags : 
           <li><a class="tag p-category" href="categories/emacs/" rel="tag">emacs</a></li>
           <li><a class="tag p-category" href="categories/en/" rel="tag">en</a></li>
        </ul>
</div>

            </div>
            <div class="body">
                <div>
<p>
CREATED: <span class="timestamp-wrapper"><span class="timestamp">&lt;2014-06-15 Sun&gt;</span></span>
</p>

<p>
UPDATED: <span class="timestamp-wrapper"><span class="timestamp">&lt;2015-02-21 Sat&gt;</span></span>
</p>

<p>
The solutin is based on the ideas of top geeks. I only did the implementation.
</p>

<p>
Mendel Cooper provided the original design in <a href="http://www.tldp.org/LDP/abs/html/index.html">Advanced Bash-Scripting Guide</a>. Masafumi Oyamada (AKA mooz) added the missing piece by creating <a href="https://github.com/mooz/percol">percol</a>.
</p>

<div id="outline-container-org782482b" class="outline-2">
<h3 id="org782482b">Problem</h3>
<div class="outline-text-2" id="text-org782482b">
<p>
How to find full path of a file by fuzz search?
</p>

<p>
The path should be shared easily to other application like Emacs.
</p>
</div>
</div>

<div id="outline-container-org30e9a4f" class="outline-2">
<h3 id="org30e9a4f">Installation</h3>
<div class="outline-text-2" id="text-org30e9a4f">
</div>
<div id="outline-container-orgf5c507e" class="outline-3">
<h4 id="orgf5c507e">Step 1, Install percol</h4>
<div class="outline-text-3" id="text-orgf5c507e">
<p>
<a href="https://github.com/mooz/percol/archive/master.zip">Download the package</a> and extract it. Place the sub-directory named "percol/" into the directory "~/bin". Rename the program "percol" in sub-directory "bin" into "percol.py". Put the percol.py also into "~/bin".
</p>
</div>
</div>

<div id="outline-container-orga0dc215" class="outline-3">
<h4 id="orga0dc215">Step 2, Insert below code into ~/.bashrc:</h4>
<div class="outline-text-3" id="text-orga0dc215">
<div class="org-src-container">

<pre><code class="lang-sh">[ $(uname -s | grep -c CYGWIN) -eq 1 ] &amp;&amp; OS_NAME="CYGWIN" || OS_NAME=`uname -s`
function pclip() {
    if [ $OS_NAME == CYGWIN ]; then
        putclip $@;
    elif [ $OS_NAME == Darwin ]; then
        pbcopy $@;
    else
        if [ -x /usr/bin/xsel ]; then
            xsel -ib $@;
        else
            if [ -x /usr/bin/xclip ]; then
                xclip -selection c $@;
            else
                echo "Neither xsel or xclip is installed!"
            fi
        fi
    fi
}

# search the file and pop up dialog, then put the full path in clipboard
function baseff()
{
    local fullpath=$*
    local filename=${fullpath##*/} # remove "/" from the beginning
    filename=${filename##*./} # remove  ".../" from the beginning
    # Only the filename without path is needed
    # filename should be reasonable
    local cli=`find . -not -iwholename '*/vendor/*' -not -iwholename '*/bower_components/*' -not -iwholename '*/node_modules/*' -not -iwholename '*/target/*' -not -iwholename '*.svn*' -not -iwholename '*.git*' -not -iwholename '*.sass-cache*' -not -iwholename '*.hg*' -type f -path '*'${filename}'*' -print | ~/bin/percol.py`
    # convert relative path to full path
    echo $(cd $(dirname $cli); pwd)/$(basename $cli)
}

function ff()
{
    local cli=`baseff $*`
    #echo ${cli} | sed 's%^'${HOME}'%~%'
    #echo -n ${cli}  | sed 's%^'${HOME}'%~%' | pclip
    echo ${cli}
    echo -n ${cli} | pclip
}

function cf()
{
    local cli=`baseff $*`
    local p=`cygpath -w $cli`
    echo ${p}
    echo -n ${p} | pclip;
}
</code></pre>

</div>

<p>
`cf` is similar to `ff`. It will output Windows path under cygwin.
</p>
</div>
</div>
</div>

<div id="outline-container-org1b51339" class="outline-2">
<h3 id="org1b51339">Usage</h3>
<div class="outline-text-2" id="text-org1b51339">
<p>
Type "ff partials-of-file-path" in shell. A filter window popups. You can filter and scroll down/up to select one file. The full path will be copied into system clipboard automatically (under Linux, either xsel or xclip are required for clipboard access).
</p>

<p>
The paritials-of-file-path could contain wildcard character.
</p>

<p>
For example, <b>for "/home/cb/projs/web-portal/app/styles/bootstrap/main.css", you can type either of below command</b>:
</p>
<div class="org-src-container">

<pre><code class="lang-sh">ff .../grunt-docs/*bootstrap*css
ff web-port*ma*css
ff styles
</code></pre>

</div>

<p>
Here is the screen shot when I type "ff el" in my ~/.emacs.d:
<img src="wp-content/use-ff-in-shell.png" alt="use-ff-in-shell.png"></p>

<p>
You will notice that I input the string "inflect" to filter the result.
</p>

<p>
I can scroll up/down (press Ctrl-P or Ctrl-N) to select the exact file.
</p>

<p>
In Emacs community, people try to embed a file explorer into Emacs (Sr speedbar, for example). This solution may make embedded file explorer unnecessary.
</p>
</div>
</div>

<div id="outline-container-org77c1c00" class="outline-2">
<h3 id="org77c1c00">Advanced usage</h3>
<div class="outline-text-2" id="text-org77c1c00">
<p>
More examples follow.
</p>
</div>

<div id="outline-container-orgf4ac0c3" class="outline-3">
<h4 id="orgf4ac0c3">Search the bash history.</h4>
<div class="outline-text-3" id="text-orgf4ac0c3">
<p>
Code to insert ~/.bashrc:
</p>
<div class="org-src-container">

<pre><code class="lang-sh">function h () {
    # reverse history, pick up one line, remove new line characters and put it into clipboard
    if [ -z "$1" ]; then
        history | sed '1!G;h;$!d' | ~/bin/percol.py | sed -n 's/^ *[0-9][0-9]* *\(.*\)$/\1/p'| tr -d '\n' | pclip
    else
        history | grep "$1" | sed '1!G;h;$!d' | ~/bin/percol.py | sed -n 's/^ *[0-9][0-9]* *\(.*\)$/\1/p'| tr -d '\n' | pclip
    fi
}
</code></pre>

</div>

<p>
Though grep is quick enough for me, it can be replaced by <a href="https://github.com/ggreer/the_silver_searcher">Silver Searcher</a>.
</p>

<p>
Screenshot:
<img src="wp-content/use-h-in-shell.png" alt="use-h-in-shell.png"></p>
</div>
</div>

<div id="outline-container-org4a9f9dc" class="outline-3">
<h4 id="org4a9f9dc">Select a file in git commit</h4>
<div class="outline-text-3" id="text-org4a9f9dc">
<p>
Code to insert ~/.bashrc:
</p>
<div class="org-src-container">

<pre><code class="lang-sh">function glsf () {
    local str=`git --no-pager log --oneline --stat $* |  ~/bin/percol.py`
    if [[ $str =~ ^[[:space:]]*([a-z0-9A-Z_.\/-]*).*$ ]]; then
        echo -n ${BASH_REMATCH[1]} |pclip;
        echo ${BASH_REMATCH[1]}
    fi
}
</code></pre>

</div>

<p>
Screenshot:
<img src="wp-content/use-glsf-in-shell.png" alt="use-glsf-in-shell.png"></p>
</div>
</div>
</div>

<div id="outline-container-org85914c9" class="outline-2">
<h3 id="org85914c9">Summary</h3>
<div class="outline-text-2" id="text-org85914c9">
<p>
The key idea is that I have full freedom to get job done in any way. Emacs is nothing more than a tool to help me achieve more power and more freedom. For example, I find mooz's percol because I like his Emacs plugin <a href="https://github.com/mooz/js2-mode">js2-mode</a> and I want to check his other works. 
</p>
</div>
</div>
</div>
            </div>
        </div>
        <div class="post">
            <h1 class="title"><a href="posts/install-emacs-into-home-directory-from-source/">Install multiple versions of Emacs into $HOME directory from source</a></h1>
            <div class="meta">
                <div class="authordate">
                    <time class="timeago" datetime="2014-05-31T03:47:53+00:00">2014-05-31 03:47</time>
</div>
                <div class="stats">
                    
        
    <a href="posts/install-emacs-into-home-directory-from-source/#disqus_thread" data-disqus-identifier="cache/posts/install-emacs-into-home-directory-from-source.html">Comments</a>


                </div>
            
        <div itemprop="keywords" class="tags">
        <ul>
        Tags : 
           <li><a class="tag p-category" href="categories/emacs/" rel="tag">emacs</a></li>
           <li><a class="tag p-category" href="categories/en/" rel="tag">en</a></li>
        </ul>
</div>

            </div>
            <div class="body">
                <div>
<p>
CREATED: <span class="timestamp-wrapper"><span class="timestamp">&lt;2014-05-31 Sat&gt;</span></span>
</p>

<p>
UPDATED: <span class="timestamp-wrapper"><span class="timestamp">&lt;2016-10-05 Wed&gt;</span></span>
</p>

<p>
Here is the script <code>install-emacs.sh</code>,
</p>

<div class="org-src-container">

<pre><code class="lang-sh">#!/bin/bash
[ -z "$EMACS_VERSION" ] &amp;&amp; echo "Usage: EMACS_VERSION=24.3 install-emacs.sh" &amp;&amp; exit 1
[ -z "$EMACS_URL" ] &amp;&amp; EMACS_URL="http://mirror.aarnet.edu.au/pub/gnu/emacs/"
# I've assign 12G memory to /tmp as ramdisk
[ -z "$EMACS_TMP" ] &amp;&amp; EMACS_TMP="/tmp"

# configure: WARNING: unrecognized options: --without-gtk3, --without-aqua, --without-alsa, --without-aqua
echo "curl $EMACS_URL/emacs-$EMACS_VERSION.tar.gz"
curl $EMACS_URL/emacs-$EMACS_VERSION.tar.gz | tar xvz -C $EMACS_TMP
# @see http://wiki.gentoo.org/wiki/Project:Emacs/GNU_Emacs_developer_guide
# @see http://packages.gentoo.org/package/app-editors/emacs for info on Gentoo Linux
# --without-gtk and --without-gtk3 is optional
if [[ $EUID -ne 0 ]]; then
    echo "Installing Emacs as normal user ..."
    cd $EMACS_TMP/emacs-$EMACS_VERSION;mkdir -p $HOME/myemacs/$EMACS_VERSION;rm -rf $HOME/myemacs/$EMACS_VERSION/*;./configure --prefix=$HOME/myemacs/$EMACS_VERSION --without-x --without-dbus --without-sound &amp;&amp; make &amp;&amp; make install
    rm -rf $EMACS_TMP/emacs-$EMACS_VERSION
    echo "Emacs $EMACS_VERSION installed!"
else
    echo "Installing Emacs as sudoer ..."
    cd $EMACS_TMP/emacs-$EMACS_VERSION;./configure --without-x --without-dbus --without-sound &amp;&amp; make &amp;&amp; make install
    echo "Emacs $EMACS_VERSION installed! Please remove $EMACS_TMP/emacs-$EMACS_VERSION"
fi
</code></pre>

</div>

<p>
Usage of the script is as simple as running <code>EMACS_VERSION=24.3 ./install-emacs</code>
</p>

<p>
The emacs will be installed into the directory <code>~/myemacs/24.3</code>.
</p>
</div>
            </div>
        </div>
        <div class="post">
            <h1 class="title"><a href="posts/how-to-manage-the-file-path-in-big-project/">How to manage the file path in big project</a></h1>
            <div class="meta">
                <div class="authordate">
                    <time class="timeago" datetime="2014-05-29T01:31:35+00:00">2014-05-29 01:31</time>
</div>
                <div class="stats">
                    
        
    <a href="posts/how-to-manage-the-file-path-in-big-project/#disqus_thread" data-disqus-identifier="cache/posts/how-to-manage-the-file-path-in-big-project.html">Comments</a>


                </div>
            
        <div itemprop="keywords" class="tags">
        <ul>
        Tags : 
           <li><a class="tag p-category" href="categories/bash/" rel="tag">bash</a></li>
           <li><a class="tag p-category" href="categories/en/" rel="tag">en</a></li>
           <li><a class="tag p-category" href="categories/engineering/" rel="tag">engineering</a></li>
           <li><a class="tag p-category" href="categories/software/" rel="tag">software</a></li>
        </ul>
</div>

            </div>
            <div class="body">
                <div>
<p>
It's not good practice to use relative path in big project.
</p>

<p>
Reasons:
</p>

<ul class="org-ul">
<li>If file B refer to file A with "../A". Then B's position in the project *CANNOT be changed. Or else its reference to A will be wrong.</li>
<li>Relative path is not intuitive when debugging.</li>
<li>If the dependency is complex. Figure out the right path is mission impossible. For example, file A refer to file B with "./a/../../B" and file B refer to file C  "../../b/C".</li>
</ul>
<p>
So you should <b>ALWAYS use the absolute path</b>.
</p>

<p>
Absolute path is tedious to type and not portable.
</p>

<p>
It could be improved a little bit be use an environment variable to replace the common prefix of the full path.
</p>

<p>
For example, we can replace absolute path "/home/cb/projects/app1/src/test.c" with "$TTAGROOT/src/test.c", if the value of environment variable TTAGROOT is "/home/cb/projects/app1".
</p>

<p>
Insert below code into ~/.bashrc so TTAGROOT value is set when you logged into bash:
</p>

<div class="org-src-container">

<pre><code class="lang-sh">export TTAGROOT="/home/cb/projects/app1"
</code></pre>

</div>

<p>
In you script to do the real job, you could make TTAGROOT optional and still use your full path happily. It's just one bash liner.
</p>

<p>
Here is a sample file named test.sh:
</p>

<div class="org-src-container">

<pre><code class="lang-sh">#!/bin/bash
[ -z "$TTAGROOT" ] &amp;&amp; TTAGROOT="hard-coded-full-path"
echo "TTAGROOT = $TTAGROOT"
</code></pre>

</div>

<p>
You could use test.sh without $TTAGROOT. Or you can set up default value of $TTAGROOT in ~/.bashrc as I already mentioned.
</p>

<p>
Or you can override the TTAGROOT value when you executing "test.sh":
</p>

<div class="org-src-container">

<pre><code class="lang-sh">TTAGROOT="hello" ./test.sh
</code></pre>

</div>

<p>
BTW, don't abuse this technique. Set <b>one environment variable</b> for the root directory of project is enough.
</p>
</div>
            </div>
        </div>
        <div class="post">
            <h1 class="title"><a href="posts/ccjava-code-indentation-in-emacs/">C/C++/Java code indentation in Emacs</a></h1>
            <div class="meta">
                <div class="authordate">
                    <time class="timeago" datetime="2014-05-09T09:19:18+00:00">2014-05-09 09:19</time>
</div>
                <div class="stats">
                    
        
    <a href="posts/ccjava-code-indentation-in-emacs/#disqus_thread" data-disqus-identifier="cache/posts/ccjava-code-indentation-in-emacs.html">Comments</a>


                </div>
            
        <div itemprop="keywords" class="tags">
        <ul>
        Tags : 
           <li><a class="tag p-category" href="categories/c/" rel="tag">c</a></li>
           <li><a class="tag p-category" href="categories/emacs/" rel="tag">emacs</a></li>
           <li><a class="tag p-category" href="categories/en/" rel="tag">en</a></li>
           <li><a class="tag p-category" href="categories/java/" rel="tag">java</a></li>
        </ul>
</div>

            </div>
            <div class="body">
                <div>
<div id="outline-container-org56bd006" class="outline-2">
<h3 id="org56bd006">Problem</h3>
<div class="outline-text-2" id="text-org56bd006">
<p>
There are two styles when insert curly braces in C like languages.
</p>

<p>
Style 1:
</p>
<div class="org-src-container">

<pre><code class="lang-c">if(true) {
    printf("hello world\n");
}
</code></pre>

</div>

<p>
Style 2:
</p>
<div class="org-src-container">

<pre><code class="lang-c">if(true)
{
    printf("hello world\n");
}
</code></pre>

</div>

<p>
Whatever style I use, I expect Emacs will properly handle the indentation for me.
</p>

<p>
In "Style 1", when I press ENTER key after "{" at first line, I expect the new line will indent four spaces.
</p>

<p>
In "Style 2", when I press ENTER key after ")" at first line, I expect the new line will NOT indent.
</p>
</div>
</div>

<div id="outline-container-org8b5f9bd" class="outline-2">
<h3 id="org8b5f9bd">Solution</h3>
<div class="outline-text-2" id="text-org8b5f9bd">
<p>
Insert below code into ~/.emacs:
</p>
<div class="org-src-container">

<pre><code class="lang-lisp">(defun fix-c-indent-offset-according-to-syntax-context (key val)
  ;; remove the old element
  (setq c-offsets-alist (delq (assoc key c-offsets-alist) c-offsets-alist))
  ;; new value
  (add-to-list 'c-offsets-alist '(key . val)))

(add-hook 'c-mode-common-hook
          (lambda ()
            (when (derived-mode-p 'c-mode 'c++-mode 'java-mode)
              ;; indent
              (fix-c-indent-offset-according-to-syntax-context 'substatement 0)
              (fix-c-indent-offset-according-to-syntax-context 'func-decl-cont 0))
            ))

</code></pre>

</div>

<p>
That's it.
</p>
</div>
</div>

<div id="outline-container-org382e944" class="outline-2">
<h3 id="org382e944">Explanation</h3>
<div class="outline-text-2" id="text-org382e944">
<p>
When you press the ENTER key, the function <b>c-indent-line</b> will be called.
</p>

<p>
That function will do some simple syntax analysis and decide current syntactic context..
</p>

<p>
It will use that syntactic context to look up a global variable c-offsets-alist and decide how many spaces the new line will indent.
</p>

<p>
For example, the context <b>substatement</b> corresponds to the code like below:
</p>
<div class="org-src-container">

<pre><code class="lang-c">if(true) // press ENTER here
</code></pre>

</div>

<p>
And the context <b>func-decl-cont</b> corresponds to:
</p>
<div class="org-src-container">

<pre><code class="lang-c">void fn () //press ENTER here
</code></pre>

</div>
</div>
</div>

<div id="outline-container-org4ef7b93" class="outline-2">
<h3 id="org4ef7b93">Technical details</h3>
<div class="outline-text-2" id="text-org4ef7b93">
<p>
When you press ENTER key, the new line will be inserted. Then the function <b>indent-according-to-mode</b> will always be called
</p>

<p>
<b>indent-according-to-mode</b> will call function object <b>indent-line-function</b> if it's not nil.
</p>

<p>
In C/C++/Java, that object is actually <b>c-indent-line</b>.
</p>

<p>
<b>c-indent-line</b> is defined in /usr/share/emacs/24.3/lisp/progmodes/cc-cmds.el (I use Emacs 24.3 on Gentoo Linux).
</p>

<p>
In that function, just below the code line:
</p>
<div class="org-src-container">

<pre><code class="lang-lisp">(setq c-syntactic-context (c-guess-basic-syntax))
</code></pre>

</div>

<p>
You can insert log code as below:
</p>
<div class="org-src-container">

<pre><code class="lang-lisp">(message "c-syntactic-context=%s" c-syntactic-context)
</code></pre>

</div>

<p>
You will know the current syntactic context when you press ENTER key through the output of log code.
</p>

<p>
<a href="http://www.emacswiki.org/emacs/IndentingC">EmacsWiki</a> says you can run command "c-set-offset", whose hot key is "C-x C-o", in order to "see the syntax at point". As I tested, it does not work as expected. My way may seem a little bit intrusive but is reliable.
</p>

<p>
For example, the context <b>statement-cont</b> corresponds to the use case like this:
</p>
<div class="org-src-container">

<pre><code class="lang-c">int a=3, // press ENTER here
</code></pre>

</div>

<p>
Please note syntax analysis in c-indent-line is turned on if and <b>only if</b> the global flag <b>c-syntactic-indentation</b> is true.
</p>

<p>
Thanks for <a href="https://github.com/chengyi">chengyi</a> for <a href="https://github.com/redguardtoo/emacs.d/issues/98">reporting the issue and suggesting the fix</a>.
</p>

<p>
BTW, <a href="http://www.emacswiki.org/emacs/IndentingC">EmacsWiki has a section</a> to discuss the indenting in C. You may not need it if you have read this article and can read the Emacs lisp code.
</p>
</div>
</div>
</div>
            </div>
        </div>
        <div class="post">
            <h1 class="title"><a href="posts/what-s-aop-in-java/">What's AOP in Java</a></h1>
            <div class="meta">
                <div class="authordate">
                    <time class="timeago" datetime="2014-05-03T06:21:31+00:00">2014-05-03 06:21</time>
</div>
                <div class="stats">
                    
        
    <a href="posts/what-s-aop-in-java/#disqus_thread" data-disqus-identifier="cache/posts/what-s-aop-in-java.html">Comments</a>


                </div>
            
        <div itemprop="keywords" class="tags">
        <ul>
        Tags : 
           <li><a class="tag p-category" href="categories/emacs/" rel="tag">emacs</a></li>
           <li><a class="tag p-category" href="categories/en/" rel="tag">en</a></li>
           <li><a class="tag p-category" href="categories/java/" rel="tag">java</a></li>
           <li><a class="tag p-category" href="categories/lisp/" rel="tag">lisp</a></li>
        </ul>
</div>

            </div>
            <div class="body">
                <div>
<p>
Yesterday in a interview I was asked what's AOP and how to use it. The two interviewers
</p>

<p>
I was wordless then so I came back to read the documentation.
</p>

<p>
It turns out AOP is simple. It's like emacs lisp's defadvice but less powerful. I've been using this since day one on different languages.
</p>

<p>
Please read <a href="http://developers.slashdot.org/story/05/04/24/0343224/aspect-oriented-programming-considered-harmful">slashdot discussion</a> about AOP.
</p>

<p>
Here is the comment from MarkusQ,
</p>

<pre class="example">
 by MarkusQ (450076) on Sunday April 24, 2005 @11:01PM (#12333504) Journal

Exactly.

When I implemented this sort of thing for a project in Ruby a few years back, I just grabbed all the CLOS nomenclature because I was familiar with it. I didn't even realize I was using "AOP with funny names" until someone reading the code mentioned it. When he asked why I didn't use the "standard" terminology, I lent him a copy of "Object Oriented Programing in Common Lisp" (c) 1988, and asked why the AOP people had to invent new words for everything.

I have yet to get an answer.

--MarkusQ
</pre>

<p>
So it's just some enterprise guy inventing new buzz words (<a href="http://en.wikipedia.org/wiki/Cross-cutting_concern">cross-cutting concern</a>, for example) on some old idea.
</p>

<p>
Now as guy who got seven years academical training on system design (Bachelor and Master degree in system controlling major from <a href="http://en.wikipedia.org/wiki/Shanghai_Jiao_Tong_University">best engineering school in China</a>), I will give you some precious advice on how to use this thing (AOP in java, API hook in C, defadvice in Emacs lisp or whatever the buzz word is):
</p>

<p>
<b>DO NOT USE IT IN ANY REAL SYSTEM OR APPLICATION!</b>
</p>

<p>
Here are the reasons:
</p>

<ul class="org-ul">
<li>The code change an external API's behavior</li>
<li>The code's location is not close to the API's</li>
<li>The system being corrupt quickly with those AOP things</li>
</ul>
</div>
            </div>
        </div>
        <div class="post">
            <h1 class="title"><a href="posts/why-gnus-is-better-than-gmail/">Why Gnus is better than Gmail</a></h1>
            <div class="meta">
                <div class="authordate">
                    <time class="timeago" datetime="2014-04-30T12:46:31+00:00">2014-04-30 12:46</time>
</div>
                <div class="stats">
                    
        
    <a href="posts/why-gnus-is-better-than-gmail/#disqus_thread" data-disqus-identifier="cache/posts/why-gnus-is-better-than-gmail.html">Comments</a>


                </div>
            
        <div itemprop="keywords" class="tags">
        <ul>
        Tags : 
           <li><a class="tag p-category" href="categories/emacs/" rel="tag">emacs</a></li>
           <li><a class="tag p-category" href="categories/email/" rel="tag">email</a></li>
           <li><a class="tag p-category" href="categories/en/" rel="tag">en</a></li>
           <li><a class="tag p-category" href="categories/gnus/" rel="tag">gnus</a></li>
        </ul>
</div>

            </div>
            <div class="body">
                <div>
<p>
Here is my use case. My agent notify me that there is a potential contract from a company named "FF".
</p>

<p>
My first reaction is to reply the email with "Great! Please forward my CV".
</p>

<p>
Before I press the "Send" button, it occurs to me that other agents have possibly <b>already</b> submitted my CV to FF since it is a big organization. I need double check.
</p>

<p>
I save current email as draft, search all the mails containing "FF" and forward them to the original email I've not sent yet. Then my agent could figure out whether other guys have already represented me for the same opportunity.
</p>

<p>
This operation is doable in desktop application like Outlook. I need search emails in a new dialog box. Select emails. Then drag them to the original email.
</p>

<p>
It's hard to do this thing in Gmail.
</p>

<p>
In Emacs, the job can be done easily:
</p>

<ul class="org-ul">
<li>Step 1, Switch to Groups buffer (the buffer which lists email folder). press key <code>G G</code> or run command <code>M-x gnus-group-make-nnir-group</code>, input the keyword "FF" to start search</li>
<li>Step 2, Mark the emails I want to forward with hot key <code>#</code>
</li>
<li>Step 3, Press key <code>C-c C-f</code> or run command <code>M-x gnus-summary-mail-forward</code>. A new buffer is created. It contains a big chuck of xml string wrapped by either "&lt;#multipart&gt;" tag or "&lt;#mml&gt;" tag.</li>
<li>Step 4, Select and copy that string into you original email. Done!</li>
</ul>
<p>
Step 4 could be improved.
</p>

<p>
Insert below code into <code>~/.emacs</code>:
</p>

<div class="org-src-container">

<pre><code class="lang-lisp">(defun message-select-forwarded-email-tags ()
  "Select the &lt;#mml-or-what-ever&gt; tags in message-mode."
  (interactive)
  (let (start rlt)
    (when (search-forward "&lt;#")
      (setq start (point))
      (push-mark (point) t t)
      (goto-char (point-max))
      (search-backward "&gt;")
      (forward-char)
      (setq rlt t))
    rlt))

(defun message-copy-select-forwarded-email-tags ()
  "Copy the &lt;#mml-or-what-ever&gt; tags in message-mode."
  (interactive)
  (save-excursion
    (cond
     ((message-select-forwarded-email-tags)
      (copy-region-as-kill (region-beginning) (region-end))
      (message "forwarded email tags copied!"))
     (t (message "NO forwarded email tags found!")))))
</code></pre>

</div>

<p>
All you need is "M-x message-copy-select-forwarded-email-tags" to copy the tags into kill-ring.
</p>

<p>
UPDATE:
This is only a case study. My complete guide on Gnus is at <a href="http://blog.binchen.org/posts/notes-on-using-gnus.html">http://blog.binchen.org/posts/notes-on-using-gnus.html</a>.
</p>
</div>
            </div>
        </div>
        <div class="post">
            <h1 class="title"><a href="posts/migrate-blog-from-wordpress-into-nikola/">Migrate blog from wordpress into nikola</a></h1>
            <div class="meta">
                <div class="authordate">
                    <time class="timeago" datetime="2014-04-22T09:09:21+00:00">2014-04-22 09:09</time>
</div>
                <div class="stats">
                    
        
    <a href="posts/migrate-blog-from-wordpress-into-nikola/#disqus_thread" data-disqus-identifier="cache/posts/migrate-blog-from-wordpress-into-nikola.html">Comments</a>


                </div>
            
        <div itemprop="keywords" class="tags">
        <ul>
        Tags : 
           <li><a class="tag p-category" href="categories/blog/" rel="tag">blog</a></li>
           <li><a class="tag p-category" href="categories/en/" rel="tag">en</a></li>
           <li><a class="tag p-category" href="categories/migrate/" rel="tag">migrate</a></li>
           <li><a class="tag p-category" href="categories/nikola/" rel="tag">nikola</a></li>
           <li><a class="tag p-category" href="categories/wordpress/" rel="tag">wordpress</a></li>
        </ul>
</div>

            </div>
            <div class="body">
                <div>
<p>
CREATED: <span class="timestamp-wrapper"><span class="timestamp">&lt;2014-04-22 Tue&gt;</span></span>
</p>

<p>
UPDATED: <span class="timestamp-wrapper"><span class="timestamp">&lt;2017-06-28 Wed&gt;</span></span>
</p>

<p>
If you are only interested in web page optimization, start from the second section of the article.
</p>

<div id="outline-container-org6b4ad79" class="outline-2">
<h3 id="org6b4ad79">Migrate from WordPress to Nikola</h3>
<div class="outline-text-2" id="text-org6b4ad79">
<div class="org-src-container">

<pre><code class="lang-sh"># you might need need `sudo apt-get install python-gdbm` on Debian
# install python2 and make sure sqlite is supported
sudo USE="sqlite" emerge -a =python-2* # Gentoo Linux

# one debian/ubuntu, you need: `apt-get install libxml2-dev libxslt1-dev python-dev libjpeg-dev` for lxml

# Not to mess up with root
export PATH=$PATH:$HOME/.local/bin

# Best way to get latest pip,
# see https://packaging.python.org/installing/#install-pip-setuptools-and-wheel
python ~/bin/get-pip.py --user # ~/.local/bin/pip

# install dependencies (requests is required by zen theme)
# sudo pip install markdown webassets phpserialize nikola requests
# "sudo pip install" could screw up my python setup on Gentoo Linux
# @see https://forums.gentoo.org/viewtopic-t-1006044-view-next.html?sid=931f7be2c16ac99fd85eb2940c0bf82b
# so install the python packages in my HOME directory might be better
# @see http://stackoverflow.com/questions/2915471/install-a-python-package-into-a-different-directory-using-pip
pip install --user markdown webassets phpserialize nikola requests

# create root directory of nikola
mkdir -p ~/.config/nikola;cd ~/.config/nikola

# import from wordpress dump
nicola import_wordpress my_wordpress_dump.xml

# since I use zen theme, I need install lessc
# obviously NodeJS is required
npm install -g less # use portable nodejs in $HOME is better

# I use zen theme, before intalling new theme, clean the legacy theme at first
rm -rf themes/zen/;nikola install_theme zen
# or rm -rf themes/zen/; http_proxy=http://127.0.0.1:8087 nikola install_theme zen at mainland China

# build the web site
nikola build
</code></pre>

</div>

<p>
Use below command to fix embedded code in HTML files:
</p>
<div class="org-src-container">

<pre><code class="lang-sh">find -name '*.wp' -exec grep -l "\[sourcecode.*\&lt;diff\&gt;.*\]" {} \; |xargs sed -i 's/\[sourcecode.*\&lt;diff\&gt;.*\]/&lt;pre class="brush: diff;"&gt;/g
find -name '*.wp' -exec grep -l "~~~~~~~~~~~~" {} \;|xargs sed -i "s%~~~~~~~~~~~~%&lt;/pre&gt;%g"
</code></pre>

</div>

<p>
Manually fixed those articles with Chinese title in url_map.csv
</p>

<p>
Use below script to fixed the xml dumped from wordpress:
</p>
<div class="org-src-container">

<pre><code class="lang-python">#!/usr/bin/python
import getopt, sys, csv
def usage():
    print '''
NAME
    fix url mapping when migrate wordpress blog into nikola
Usage
    python fix-url-map.py [options]
'''[1:-1]

if __name__ == '__main__':
    try:
        opts, args = getopt.getopt(sys.argv[1:], "hf:x:", ["help", "file=","xml="])
    except getopt.GetoptError as err:
        # print help information and exit:
        print str(err) # will print something like "option -a not recognized"
        usage()
        sys.exit(2)

    file=""
    xml=""

    for o, a in opts:
        if o in ("-h", "--help"):
            usage()
            sys.exit()
        elif o in ("-f", "--file"):
            file= a
        elif o in ("-x", "--xml"):
            xml=a
        else:
            assert False, "unhandled option"

    with open(xml, 'r') as content_file:
        content = content_file.read()

    with open(file, 'rb') as csvfile:
         spamreader = csv.reader(csvfile, delimiter=',')
         for row in spamreader:
             content=content.replace("&gt;"+row[0]+"&lt;","&gt;"+row[1]+"&lt;")

    print content
</code></pre>

</div>

<p>
Import the xml into <a href="http://disqus.com">http://disqus.com</a>.
</p>

<p>
You can use javascript to re-direct the URL, so your old article links are still valid. Ask at <a href="http://stackoverflow.com">http://stackoverflow.com</a> or contact your local Javascript developers on how to do it. It's simple task but a little boring.
</p>
</div>
</div>

<div id="outline-container-orga01ad10" class="outline-2">
<h3 id="orga01ad10">Optimization</h3>
<div class="outline-text-2" id="text-orga01ad10">
<p>
I developed <a href="https://github.com/redguardtoo/org2nikola">org2nikola</a> to convert Org subtree into Nikola page. 
</p>

<p>
Instead of hacking conf.py, I <b>tweak the theme's javascript/html/css directly</b>. It's simpler and more flexible.
</p>

<p>
For example, the <a href="https://themes.getnikola.com/v7/zen/">Zen theme</a> uses JQuery plugins to format time. I replace JQuery with <a href="https://momentjs.com/">Moment.js v1.0</a> which is much smaller. 
</p>

<p>
Since only a few icons from <a href="http://fontawesome.io/">Font Awesome</a> is used by Zen theme.. We can use NodeJS plugin <a href="https://github.com/aui/font-spider">font-spider</a> to trim down the font file.
</p>

<p>
Other conventional front end tricks like static assets concatenating/minifying can also be used. These tricks are introduced everywhere. So I won't waste time on details.
</p>

<p>
In order to see the real example of optimization, please visit <a href="http://blog.binchen.org">http://blog.binchen.org</a>. Watching through the browser's developer tool, you can see my web page is 90% smaller than pages without optimization.
</p>

<p>
<a href="https://highlightjs.org/">highlight.js</a> is the best solution for code syntax highlighting. I customized the <code>highlight.js</code> to render only the programming languages I use.
</p>

<p>
My static blog is hosted at <a href="https://pages.github.com/">GitHub Pages</a>.
</p>
</div>
</div>
</div>
            </div>
        </div>
        <div class="post">
            <h1 class="title"><a href="posts/what-s-the-best-spell-check-set-up-in-emacs/">What's the best spell check setup in emacs</a></h1>
            <div class="meta">
                <div class="authordate">
                    <time class="timeago" datetime="2014-04-21T08:25:20+00:00">2014-04-21 08:25</time>
</div>
                <div class="stats">
                    
        
    <a href="posts/what-s-the-best-spell-check-set-up-in-emacs/#disqus_thread" data-disqus-identifier="cache/posts/what-s-the-best-spell-check-set-up-in-emacs.html">Comments</a>


                </div>
            
        <div itemprop="keywords" class="tags">
        <ul>
        Tags : 
           <li><a class="tag p-category" href="categories/aspell/" rel="tag">aspell</a></li>
           <li><a class="tag p-category" href="categories/check/" rel="tag">check</a></li>
           <li><a class="tag p-category" href="categories/emacs/" rel="tag">emacs</a></li>
           <li><a class="tag p-category" href="categories/en/" rel="tag">en</a></li>
           <li><a class="tag p-category" href="categories/hunspell/" rel="tag">hunspell</a></li>
           <li><a class="tag p-category" href="categories/ispell/" rel="tag">ispell</a></li>
           <li><a class="tag p-category" href="categories/spell/" rel="tag">spell</a></li>
        </ul>
</div>

            </div>
            <div class="body">
                <div>
<p>
UPDATED: <span class="timestamp-wrapper"><span class="timestamp">&lt;2020-09-12 Sat&gt;</span></span>
</p>

<p>
CREATED: <span class="timestamp-wrapper"><span class="timestamp">&lt;2014-04-26 Sat&gt;</span></span>
</p>

<p>
I will show the minimum set up and explain details.
</p>

<p>
Topics covered in official manual (<code>flyspell-mode-predicate</code>, for example) are NOT discussed here.
</p>

<p>
But you can see my <b>complete</b> configuration <a href="https://github.com/redguardtoo/emacs.d/blob/master/lisp/init-spelling.el">HERE</a>.
</p>

<div id="outline-container-orgdb3d868" class="outline-2">
<h3 id="orgdb3d868">Suggestion for non-programmers</h3>
<div class="outline-text-2" id="text-orgdb3d868">
<p>
Emacs finds the right dictionary by querying your locale.
</p>

<p>
You can run the command <code>locale</code> in the shell to get current locale.
</p>

<p>
If you want to force Emacs use the dictionary "en_US", insert below code into your <code>~/.emacs</code>:
</p>
<div class="org-src-container">

<pre><code class="lang-lisp">;; find aspell and hunspell automatically
(cond
 ;; try hunspell at first
  ;; if hunspell does NOT exist, use aspell
 ((executable-find "hunspell")
  (setq ispell-program-name "hunspell")
  (setq ispell-local-dictionary "en_US")
  (setq ispell-local-dictionary-alist
        ;; Please note the list `("-d" "en_US")` contains ACTUAL parameters passed to hunspell
        ;; You could use `("-d" "en_US,en_US-med")` to check with multiple dictionaries
        '(("en_US" "[[:alpha:]]" "[^[:alpha:]]" "[']" nil ("-d" "en_US") nil utf-8)))

  ;; new variable `ispell-hunspell-dictionary-alist' is defined in Emacs
  ;; If it's nil, Emacs tries to automatically set up the dictionaries.
  (when (boundp 'ispell-hunspell-dictionary-alist)
    (setq ispell-hunspell-dictionary-alist ispell-local-dictionary-alist)))

 ((executable-find "aspell")
  (setq ispell-program-name "aspell")
  ;; Please note ispell-extra-args contains ACTUAL parameters passed to aspell
  (setq ispell-extra-args '("--sug-mode=ultra" "--lang=en_US"))))
</code></pre>

</div>

<p>
That's it!
</p>

<p>
Some people prefer hunspell to aspell because <b>hunspell gives better suggestions for typo fix</b>. We can run both in shell to demonstrate that,
</p>
<div class="org-src-container">

<pre><code class="lang-sh">echo htink | aspell -a --sug-mode=ultra --lang=en_US
echo htink | hunspell -a -d en_US
</code></pre>

</div>

<p>
Run <code>man aspell</code> or <code>man hunspell</code> in shell if you have more questions. I've nothing more to say.
</p>
</div>
</div>

<div id="outline-container-org0830a6c" class="outline-2">
<h3 id="org0830a6c">Suggestion for programmers</h3>
<div class="outline-text-2" id="text-org0830a6c">
<p>
I strongly recommend aspell instead of hunspell (Though hunspell is fine).
</p>

<p>
Please insert below code into your <code>~/.emacs</code>:
</p>

<div class="org-src-container">

<pre><code class="lang-lisp">;; if (aspell installed) { use aspell}
;; else if (hunspell installed) { use hunspell }
;; whatever spell checker I use, I always use English dictionary
;; I prefer use aspell because:
;; 1. aspell is older
;; 2. looks Kevin Atkinson still get some road map for aspell:
;; @see http://lists.gnu.org/archive/html/aspell-announce/2011-09/msg00000.html
(defun flyspell-detect-ispell-args (&amp;optional run-together)
  "if RUN-TOGETHER is true, spell check the CamelCase words."
  (let (args)
    (cond
     ((string-match  "aspell$" ispell-program-name)
      ;; Force the English dictionary for aspell
      ;; Support Camel Case spelling check (tested with aspell 0.6)
      (setq args (list "--sug-mode=ultra" "--lang=en_US"))
      (when run-together
        (cond
         ;; Kevin Atkinson said now aspell supports camel case directly
         ;; https://github.com/redguardtoo/emacs.d/issues/796
         ((string-match-p "--camel-case"
                          (shell-command-to-string (concat ispell-program-name " --help")))
          (setq args (append args '("--camel-case"))))

         ;; old aspell uses "--run-together". Please note we are not dependent on this option
         ;; to check camel case word. wucuo is the final solution. This aspell options is just
         ;; some extra check to speed up the whole process.
         (t
          (setq args (append args '("--run-together" "--run-together-limit=16")))))))
     ((string-match "hunspell$" ispell-program-name)
      ;; Force the English dictionary for hunspell
      (setq args "-d en_US")))
    args))

(cond
 ((executable-find "aspell")
  ;; you may also need `ispell-extra-args'
  (setq ispell-program-name "aspell"))
 ((executable-find "hunspell")
  (setq ispell-program-name "hunspell")

  ;; Please note that `ispell-local-dictionary' itself will be passed to hunspell cli with "-d"
  ;; it's also used as the key to lookup `ispell-local-dictionary-alist'
  ;; if we use different dictionary
  (setq ispell-local-dictionary "en_US")
  (setq ispell-local-dictionary-alist
        '(("en_US" "[[:alpha:]]" "[^[:alpha:]]" "[']" nil ("-d" "en_US") nil utf-8)))
  ;; new variable `ispell-hunspell-dictionary-alist' is defined in Emacs
  ;; If it's nil, Emacs tries to automatically set up the dictionaries.
  (when (boundp 'ispell-hunspell-dictionary-alist)
    (setq ispell-hunspell-dictionary-alist ispell-local-dictionary-alist)))

 (t (setq ispell-program-name nil)))

;; `ispell-cmd-args' is useless, it's the list of *extra* arguments we will append to the ispell process when `ispell-word' is called.
;; `ispell-extra-args' is the command arguments which will *always* be used when start ispell process
;; Please note when you use hunspell, `ispell-extra-args' will NOT be used.
;; Hack `ispell-local-dictionary-alist' instead.
(setq-default ispell-extra-args (flyspell-detect-ispell-args t))

(defun my-ispell-word-hack (orig-func &amp;rest args)
  "Use Emacs original arguments when calling `ispell-word'.
When fixing a typo, avoid pass camel case option to cli program."
  (let* ((old-ispell-extra-args ispell-extra-args))
    (ispell-kill-ispell t)
    ;; use emacs original argument
    (setq ispell-extra-args (my-detect-ispell-args))
    (apply orig-func args)
    ;; restore our own ispell arguments
    (setq ispell-extra-args old-ispell-extra-args)
    (ispell-kill-ispell t)))
(advice-add 'ispell-word :around #'my-ispell-word-hack)
(advice-add 'flyspell-auto-correct-word :around #'my-ispell-word-hack)

(defun text-mode-hook-setup ()
  ;; Turn off RUN-TOGETHER option when spell check text-mode
  (setq-local ispell-extra-args (flyspell-detect-ispell-args)))
(add-hook 'text-mode-hook 'text-mode-hook-setup)
</code></pre>

</div>

<p>
There is only one minor issue in this setup. If a camel case word contains correct two character sub-word. Aspell will regard the word as typo. So aspell might produce some noise (Future aspell has new option <code>--camel-case</code> which solves this problem completely).
</p>

<p>
See <a href="https://github.com/redguardtoo/emacs.d/blob/master/lisp/init-spelling.el">https://github.com/redguardtoo/emacs.d/blob/master/lisp/init-spelling.el</a> for the solution. 
</p>
</div>
</div>

<div id="outline-container-org9400073" class="outline-2">
<h3 id="org9400073">Why</h3>
<div class="outline-text-2" id="text-org9400073">
</div>
<div id="outline-container-org4e9d24a" class="outline-3">
<h4 id="org4e9d24a">Aspell</h4>
<div class="outline-text-3" id="text-org4e9d24a">
<p>
aspell is recommended because its option <code>--run-together</code>. That option could check the <b>camel case word</b>. Variable name often uses camel case naming convention these days. Read my <a href="http://blog.binchen.org/?p=950">Effective spell check in Emacs</a> for advanced tips.
</p>

<p>
If Emacs starts an aspell process with "–run-together" option, that process is not closed so it can be re-used by other commands.
</p>

<p>
This behavior will be a problem if you want Emacs/aspell correct the typo by running the command "ispell-word" because an aspell process with "–run-together" will produce too much noise.
</p>

<p>
For example, for a typo "helle" Emacs will give you extra candidates. It's hard to find the desired word "hello":
<img src="wp-content/aspell-camelcase-suggest-nq8.png" alt="aspell-camelcase-suggest-nq8.png"></p>

<p>
The better solution is before running "M-x ispell-word", we'd better restart the aspell process without the argument "–run-together".
</p>

<p>
Here is the screen shot after we applying this fix:
<img src="wp-content/aspell-normal-suggest-nq8.png" alt="aspell-normal-suggest-nq8.png"></p>

<p>
As I mentioned, the global variable <code>ispell-extra-args</code> contains arguments Emacs will always append to a spell checker process (aspell or hunspell). That's the <b>only variable</b> you need care about.
</p>

<p>
There is another variable <code>ispell-cmd-args</code>. It is actually some <b>extra</b> arguments Emacs could send to the <b>existing</b> spell checker process when you "M-x ispell-word". In my opinion, it's useless. I mention it because its name is confusing. <code>ispell-extra-args</code> contains command line arguments the spell checker <b>always</b> uses. The <code>ispell-cmd-args</code> contains the extra arguments which <b>might</b> be used.
</p>
</div>
</div>
<div id="outline-container-orgedaf11d" class="outline-3">
<h4 id="orgedaf11d">Hunspell</h4>
<div class="outline-text-3" id="text-orgedaf11d">
<p>
I cannot find hunspell option to check camel case words. Please enlighten me if you know the option.
</p>

<p>
Hunspell has some design flaw. It always checks the environment variable LC_ALL, LC_MESSAGES and LANG <b>at first</b> to find the default dictionary unless you give it the dictionary in the command line. If it cannot find the default dictionary, the spell checker process won't start. Aspell does not have this issue, if it cannot find the zh_CN dictionary, it will fall back into English dictionary.
</p>

<p>
Specify the <code>ispell-extra-args</code> <b>won NOT stop hunspell to search for the default dictionary</b> at the beginning because <code>ispell-extra-args</code> is NOT used by hunspell.
</p>

<p>
For example, I am a Chinese and my locale is <code>zh_CN.utf-8</code>. So hunspell always searches the dictionary zh_CN. Even I'm only interested in English spell checking.
</p>

<p>
To specify the dictionary explicitly, I need hack the Emacs code which is kind of mess.
</p>

<p>
Finally, I figured out,
</p>
<div class="org-src-container">

<pre><code class="lang-lisp">(setq ispell-program-name "hunspell")
;; below two lines reset the the hunspell to it STOPS querying locale!
(setq ispell-local-dictionary "en_US") ; "en_US" is key to lookup in `ispell-local-dictionary-alist`
(setq ispell-local-dictionary-alist
      '(("en_US" "[[:alpha:]]" "[^[:alpha:]]" "[']" nil ("-d" "en_US") nil utf-8)))
</code></pre>

</div>

<p>
You can pass the extra arguments to the hunspell by tweaking <code>ispell-local-dictionary-alist</code>.
</p>
</div>
</div>
</div>

<div id="outline-container-orgadeeec3" class="outline-2">
<h3 id="orgadeeec3">FAQ</h3>
<div class="outline-text-2" id="text-orgadeeec3">
</div>
<div id="outline-container-org5512326" class="outline-3">
<h4 id="org5512326">How to setup Hunspell</h4>
<div class="outline-text-3" id="text-org5512326">
<p>
The easiest way is to set up environment variable <code>DICPATH</code>,
</p>
<div class="org-src-container">

<pre><code class="lang-sh">export DICPATH=/Applications/LibreOffice.app/Contents/Resources/extensions/dict-en:/Applications/LibreOffice.app/Contents/Resources/extensions/dict-es
hunspell -D # list available/loaded dictionaries
</code></pre>

</div>

<p>
You can also run <code>hunspell -D</code> in shell to figure out where hunspell actually searches dictionaries.
</p>
</div>
</div>
</div>
</div>
            </div>
        </div>
    
        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-18.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-16.html" rel="next">Older posts</a>
            </li>
        </ul></nav><script>var disqus_shortname="chenbin0";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script><footer id="footer"><p>Contents © 2020         <a href="mailto:chenbin.sh@gmail.com">Chen Bin</a> - Powered by         <a href="http://getnikola.com" rel="nofollow">Nikola</a>         </p>
            
        </footer>
</div>
    </section><script src="assets/js/all-nocdn.js" type="text/javascript"></script><script type="text/javascript">
         document.addEventListener('DOMContentLoaded', function() {
           var items = document.getElementsByClassName('timeago'), e, pd;
           for (var i = 0; i < items.length; i++) {
             e = items[i];
             pd = moment(new Date(e.getAttribute('datetime')));
             e.innerHTML = pd.fromNow();
             e.setAttribute('title', pd.format('LLLL'));
           }
         });
        </script>
</body>
</html>
