<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="Linux, Programming, Emacs">
<meta name="viewport" content="width=device-width">
<title>Chen's blog (old posts, page 18) | Chen's blog</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link rel="alternate" type="application/rss+xml" title="RSS" href="rss.xml">
<link rel="canonical" href="http://blog.binchen.org/index-18.html">
<!--[if lt IE 9]><script src="/assets/js/html5.js"></script><![endif]-->
</head>
<body>
    <section class="social"><ul>
<li><a href="index.html" title="Home"><i class="icon-home"></i></a></li>
            <li><a href="archive.html" title="Archives"><i class="icon-folder-open-alt"></i></a></li>
            <li><a href="categories/index.html" title="Tags"><i class="icon-tags"></i></a></li>
            <li><a href="rss.xml" title="RSS"><i class="icon-rss"></i></a></li>
            <li><a href="stories/about.html" title="About me"><i class="icon-user"></i></a></li>
            <li><a href="https://twitter.com/chen_bin" title="My Twitter"><i class="icon-twitter"></i></a></li>
            <li><a href="https://github.com/redguardtoo" title="My Github"><i class="icon-github"></i></a></li>

        </ul></section><section class="page-content"><div class="content" rel="main">
            
        <div class="post">
            <h1 class="title"><a href="posts/how-to-validate-html5-code-with-flymake-effectively/">How to validate HTML5 code with Flymake effectively</a></h1>
            <div class="meta">
                <div class="authordate">
                    <time class="timeago" datetime="2014-12-05T13:00:31+00:00">2014-12-05 13:00</time>
</div>
                <div class="stats">
                    
        
    <a href="posts/how-to-validate-html5-code-with-flymake-effectively/#disqus_thread" data-disqus-identifier="cache/posts/how-to-validate-html5-code-with-flymake-effectively.html">Comments</a>


                </div>
            
        <div itemprop="keywords" class="tags">
        <ul>
        Tags : 
           <li><a class="tag p-category" href="categories/emacs/" rel="tag">emacs</a></li>
           <li><a class="tag p-category" href="categories/en/" rel="tag">en</a></li>
           <li><a class="tag p-category" href="categories/html/" rel="tag">html</a></li>
           <li><a class="tag p-category" href="categories/tidy/" rel="tag">tidy</a></li>
           <li><a class="tag p-category" href="categories/validation/" rel="tag">validation</a></li>
        </ul>
</div>

            </div>
            <div class="body">
                <div>
<p>
UPDATED: <span class="timestamp-wrapper"><span class="timestamp">&lt;2014-12-11 Thu&gt; </span></span> 
</p>

<p>
CREATED: <span class="timestamp-wrapper"><span class="timestamp">&lt;2014-12-05 Fri&gt;</span></span>
</p>

<p>
Here is the <a href="http://www.emacswiki.org/emacs/FlymakeHtml">solution from EmacsWiki</a>.
</p>

<p>
I found it not effective because <a href="https://github.com/w3c/tidy-html5">tidy</a> is too strict to HTML5 and produces too much noise.
</p>

<p>
I only need validation of missing open/closed html tag(s). Nothing more!
</p>

<p>
So here is my complete solution:
</p>

<div class="org-src-container">

<pre><code class="lang-lisp">(defun flymake-html-init ()
       (let* ((temp-file (flymake-init-create-temp-buffer-copy
                          'flymake-create-temp-inplace))
              (local-file (file-relative-name
                           temp-file
                           (file-name-directory buffer-file-name))))
         (list "tidy" (list local-file))))

(defun flymake-html-load ()
  (interactive)
  (when (and (not (null buffer-file-name)) (file-writable-p buffer-file-name))
    (set (make-local-variable 'flymake-allowed-file-name-masks)
         '(("\\.html\\|\\.ctp\\|\\.ftl\\|\\.jsp\\|\\.php\\|\\.erb\\|\\.rhtml" flymake-html-init))
         )
    (set (make-local-variable 'flymake-err-line-patterns)
         ;; only validate missing html tags
         '(("line \\([0-9]+\\) column \\([0-9]+\\) - \\(Warning\\|Error\\): \\(missing &lt;\/[a-z0-9A-Z]+&gt;.*\\|discarding unexpected.*\\)" nil 1 2 4))
         )
    (flymake-mode t)))

(add-hook 'web-mode-hook 'flymake-html-load)
(add-hook 'html-mode-hook 'flymake-html-load)
(add-hook 'nxml-mode-hook 'flymake-html-load)
(add-hook 'php-mode-hook 'flymake-html-load)
</code></pre>

</div>

<p>
The only difference from EmacsWiki is only one line:
</p>

<div class="org-src-container">

<pre><code class="lang-lisp">'(("line \\([0-9]+\\) column \\([0-9]+\\) - \\(Warning\\|Error\\): \\(missing &lt;\/[a-z0-9A-Z]+&gt;.*\\|discarding unexpected.*\\)" nil 1 2 4))
</code></pre>

</div>
</div>
            </div>
        </div>
        <div class="post">
            <h1 class="title"><a href="posts/advanced-tip-on-using-mozrepl-to-automatically-refresh-browser/">Advanced tip on using mozrepl to automatically refresh browser</a></h1>
            <div class="meta">
                <div class="authordate">
                    <time class="timeago" datetime="2014-12-03T08:44:27+00:00">2014-12-03 08:44</time>
</div>
                <div class="stats">
                    
        
    <a href="posts/advanced-tip-on-using-mozrepl-to-automatically-refresh-browser/#disqus_thread" data-disqus-identifier="cache/posts/advanced-tip-on-using-mozrepl-to-automatically-refresh-browser.html">Comments</a>


                </div>
            
        <div itemprop="keywords" class="tags">
        <ul>
        Tags : 
           <li><a class="tag p-category" href="categories/emacs/" rel="tag">emacs</a></li>
           <li><a class="tag p-category" href="categories/en/" rel="tag">en</a></li>
           <li><a class="tag p-category" href="categories/firefox/" rel="tag">firefox</a></li>
           <li><a class="tag p-category" href="categories/mozrepl/" rel="tag">mozrepl</a></li>
        </ul>
</div>

            </div>
            <div class="body">
                <div>
<p>
Here is <a href="http://www.emacswiki.org/emacs/MozRepl">the setup on Emacswiki</a>.
</p>

<p>
I find it annoying instead of helpful in real world usage.
</p>

<p>
The mozrepl trick basically will refresh the <b>current active page</b> in Firefox. It's not smart enough. When developing a web application, I will open many stackoverflow pages to look for technical solution. I don't like my stackoverflow page being refreshed when I'm saving the HTML code for some web application.
</p>

<p>
So here is my improved solution:
</p>

<div class="org-src-container">

<pre><code class="lang-lisp">(defun my-moz-refresh-browser-condition (current-file)
  "Should return a boolean javascript expression or nil"
  (let (rlt)
    (cond
     ((string-match "\\(beeta\\|cb_tutorial\\)" current-file)
      (setq rlt "content.document.location.href.indexOf(':8001')!==-1"))
     (t
      (setq rlt nil)))
    rlt))

;; {{ mozrepl auto-refresh browser
(defun moz-reload-browser ()
  (interactive)
  (let (js-cond cmd)
    (if (fboundp 'my-moz-refresh-browser-condition)
        (setq js-cond (funcall 'my-moz-refresh-browser-condition (buffer-file-name))))
    (cond
     (js-cond
      (setq cmd (concat "if(" js-cond "){setTimeout(function(){content.document.location.reload(true);}, '500');}")))
     (t
      (setq cmd "setTimeout(function(){content.document.location.reload(true);}, '500');")))
    (comint-send-string (inferior-moz-process) cmd)
    ))

(defun moz-after-save ()
  (interactive)
  (when (memq major-mode '(web-mode html-mode nxml-mode nxhml-mode php-mode))
    (moz-reload-browser)))

(add-hook 'after-save-hook
              'moz-after-save
              'append 'local)
;; }}
</code></pre>

</div>
</div>
            </div>
        </div>
        <div class="post">
            <h1 class="title"><a href="posts/tips-on-using-ctags-with-emacs/">Tips on using Ctags with Emacs</a></h1>
            <div class="meta">
                <div class="authordate">
                    <time class="timeago" datetime="2014-11-28T05:13:11+00:00">2014-11-28 05:13</time>
</div>
                <div class="stats">
                    
        
    <a href="posts/tips-on-using-ctags-with-emacs/#disqus_thread" data-disqus-identifier="cache/posts/tips-on-using-ctags-with-emacs.html">Comments</a>


                </div>
            
        <div itemprop="keywords" class="tags">
        <ul>
        Tags : 
           <li><a class="tag p-category" href="categories/ctags/" rel="tag">ctags</a></li>
           <li><a class="tag p-category" href="categories/emacs/" rel="tag">emacs</a></li>
           <li><a class="tag p-category" href="categories/en/" rel="tag">en</a></li>
           <li><a class="tag p-category" href="categories/javascript/" rel="tag">javascript</a></li>
        </ul>
</div>

            </div>
            <div class="body">
                <div>
<p>
<a href="http://ctags.sourceforge.net/">Ctags</a> is critical to my web projects. I use it for code navigation by <code>M-x find-tag</code> and code auto-completion by using <a href="https://github.com/redguardtoo/company-ctags">company-ctags</a> plus <a href="http://company-mode.github.io/">company-mode</a>.
</p>

<p>
The first tip is to use global variable <code>tags-table-list</code> instead of <code>tags-file-name</code>.  The Emacs documentation says you should NOT set both. <code>tags-table-list</code> is better because it's a list, where you can store multiple tag files.
</p>

<p>
Here is the value of <code>tags-table-list</code> for one project:
</p>

<div class="org-src-container">

<pre><code class="lang-lisp">("/Users/cb/projs/their-project/test/cdn/test/assets/test/js/TAGS" "/Users/cb/projs/their-project/test/app/TAGS")
</code></pre>

</div>

<p>
The purpose to use multiple tag files in sub-folders instead of one tag file in root folder is to scan <b>less</b> code files.
</p>

<p>
The second tip is we can avoid feeding big js files to ctags. Currently one of my client's project is not managed well. They place the concatenated js files, third party js libraries, and normal code file into one folder. The naming of files is a mess. So I can not tell which is which from file name or file path. The tag file created from those big concatenated js files will <a href="https://github.com/company-mode/company-mode/issues/243">crash my Emacs</a>.
</p>

<p>
Changing the ctags command line  will solve the problem. Here is the actual liner to create a tag file:
</p>

<div class="org-src-container">

<pre><code class="lang-sh">find proj-dir -type f -not -iwholename '*TAGS' -not -size +16k | ctags -f ~/proj/output/TAGS -e -L -
</code></pre>

</div>

<p>
The point is the option <code>-not -size +16k</code>. It means only handle files less thank 16k.
</p>

<p>
Here is the Emacs lisp function to wrap above shell command:
</p>

<div class="org-src-container">

<pre><code class="lang-lisp">(defun my-create-tags-if-needed (SRC-DIR CTAGS-OPTS &amp;optional FORCE)
  "return the full path of tags file"
  ;; TODO save the CTAGS-OPTS into hash
  (let ((dir (file-name-as-directory (file-truename SRC-DIR)) )
       file
       cmd)
    (setq file (concat dir "TAGS"))
    (when (or FORCE (not (file-exists-p file)))
      (setq cmd (format "find %s -type f -not -iwholename '*TAGS' -not -size +24k | ctags -f %s -e  %s -L -" dir file CTAGS-OPTS))
      (shell-command cmd))
    file))
</code></pre>

</div>

<p>
BTW, here is my <a href="https://gist.github.com/redguardtoo/b12ddae3b8010a276e9b#file-ctags">~/.ctags</a>.
</p>

<p>
UPDATE:
</p>

<ol class="org-ol">
<li>My tags file management strategy is described at <a href="http://blog.binchen.org/posts/how-to-use-ctags-in-emacs-effectively-3.html">How to use ctags in Emacs effectively</a>. It's effective to me. But it may be not generic enough to apply to others' use cases.</li>

<li>I do use <a href="http://www.gnu.org/software/global/">Gnu Global</a> for <b>C/C++/Java</b> code. I use it exactly in the <b>same way</b> as ctags. Please <code>man global</code> for the details. Hint, all you need care is the environment variable <b>GTAGSLIBPATH</b>.</li>
</ol>
</div>
            </div>
        </div>
        <div class="post">
            <h1 class="title"><a href="posts/debug-efficiently-in-emacs/">Debug efficiently in Emacs</a></h1>
            <div class="meta">
                <div class="authordate">
                    <time class="timeago" datetime="2014-11-23T12:45:18+00:00">2014-11-23 12:45</time>
</div>
                <div class="stats">
                    
        
    <a href="posts/debug-efficiently-in-emacs/#disqus_thread" data-disqus-identifier="cache/posts/debug-efficiently-in-emacs.html">Comments</a>


                </div>
            
        <div itemprop="keywords" class="tags">
        <ul>
        Tags : 
           <li><a class="tag p-category" href="categories/emacs/" rel="tag">emacs</a></li>
           <li><a class="tag p-category" href="categories/en/" rel="tag">en</a></li>
           <li><a class="tag p-category" href="categories/javascript/" rel="tag">javascript</a></li>
        </ul>
</div>

            </div>
            <div class="body">
                <div>
<p>
Please note:
</p>

<ul class="org-ul">
<li>I use javascript as a use case. The solution is <b>generic</b> enough to be applied to <b>any language</b>. At the end of the article, Emacs Lisp is used as another example.</li>
<li>I'm good at most debuggers. The point of this article is to deal with <b>more difficult issues</b> the debugger can not handle.</li>
<li>My code quality is fine. It handles all the corner cases I've met. For example, single quote and double quotes will be escaped properly.</li>
</ul>
<div id="outline-container-orga1fd159" class="outline-2">
<h3 id="orga1fd159">Problem</h3>
<div class="outline-text-2" id="text-orga1fd159">
<p>
As a freelancer I am often required to debug legacy javascript code from some huge "enterprise"" applications.
</p>

<p>
The only way to debug such application is to insert as many as possible logging code, watch the output, and think.
</p>

<p>
So my problem is how to insert logging code as quickly as possible.
</p>
</div>
</div>

<div id="outline-container-org9e880d6" class="outline-2">
<h3 id="org9e880d6">Solution</h3>
<div class="outline-text-2" id="text-org9e880d6">
<p>
My solution is <a href="https://github.com/capitaomorte/yasnippet">Yasnippet</a>. Yasnippet allow me to insert executable Emacs Lisp code in its snippet. I will Sotake full advantage of that feature. 
</p>
</div>
</div>

<div id="outline-container-org868be1f" class="outline-2">
<h3 id="org868be1f">Logging simple JS variable</h3>
<div class="outline-text-2" id="text-org868be1f">
<p>
Given a variable name like "var1", I need insert javascript code as below:
</p>
<div class="org-src-container">

<pre><code class="lang-javascript">console.log("var1=", var1)
</code></pre>

</div>

<p>
Snippet:
<a href="https://github.com/redguardtoo/emacs.d/blob/master/snippets/js-mode/logobject.yasnippet">https://github.com/redguardtoo/emacs.d/blob/master/snippets/js-mode/logobject.yasnippet</a>
</p>

<p>
This snippet need you input variable name once.
</p>
</div>
</div>

<div id="outline-container-org0f1b662" class="outline-2">
<h3 id="org0f1b662">Logging complex JS variable</h3>
<div class="outline-text-2" id="text-org0f1b662">
<p>
In real world, the JS variable is often a string like "MyController.servicea.find('.class').attr1" which I hate to type.
</p>

<p>
So the solution is that I copy the JS variable into kill ring where my snippet will read the variable name.
</p>

<p>
Snippet:
<a href="https://github.com/redguardtoo/emacs.d/blob/master/snippets/js-mode/log-recent-kill-ring.yasnippet">https://github.com/redguardtoo/emacs.d/blob/master/snippets/js-mode/log-recent-kill-ring.yasnippet</a>
</p>
</div>
</div>

<div id="outline-container-org974034a" class="outline-2">
<h3 id="org974034a">Logging JS function name when it's called</h3>
<div class="outline-text-2" id="text-org974034a">
<p>
In below example, I need insert  "console.log('hello is called');" in function "hello":
</p>
<div class="org-src-container">

<pre><code class="lang-javascript">function hello() {
  console.log('hello is called');
}
</code></pre>

</div>

<p>
Snippet:
<a href="https://github.com/redguardtoo/emacs.d/blob/master/snippets/js-mode/log-which-function.yasnippet">https://github.com/redguardtoo/emacs.d/blob/master/snippets/js-mode/log-which-function.yasnippet</a>
</p>

<p>
This snippet use the Emacs command `which-function`. If you read the code of `which-function`, you will find that it's <a href="http://www.emacswiki.org/emacs/ImenuMode">Imenu-mode</a>
who actually extracts the function name. But Imenu-mode requires you pre-define <b>enough regular expressions</b>. 
</p>

<p>
Please check <a href="https://github.com/redguardtoo/emacs.d/blob/master/lisp/init-javascript.el">https://github.com/redguardtoo/emacs.d/blob/master/lisp/init-javascript.el</a>. I have defined many regular expressions for <a href="https://angularjs.org/">AngularJS</a> and JQuery.
</p>

<p>
The regular expressions could be used in <b>both</b> js-mode and js2-mode.
</p>
</div>
</div>

<div id="outline-container-orgf5f57b3" class="outline-2">
<h3 id="orgf5f57b3">Logging JS function name with its parameters</h3>
<div class="outline-text-2" id="text-orgf5f57b3">
<p>
JS example:
</p>
<div class="org-src-container">

<pre><code class="lang-javascript">function hello(v1, v2,
               v3, v4) {
  console.log("v1=", v1, "v2=", v2, "v3=", v3, "v4=", v4);
}
</code></pre>

</div>

<p>
I copy the parameter of JS function named "hello". It's just the content between "hello(" and ")", then Emacs Lisp code embedded in the snippet will parse and output the right content from kill ring.
</p>

<p>
Snippet:
<a href="https://github.com/redguardtoo/emacs.d/blob/master/snippets/js-mode/log-which-function-with-para.yasnippet">https://github.com/redguardtoo/emacs.d/blob/master/snippets/js-mode/log-which-function-with-para.yasnippet</a>
</p>

<p>
BTW, since I use <a href="http://www.emacswiki.org/Evil">Evil</a>, copy the parameter into kill-ring is as simple as pressing "yi(".
</p>
</div>
</div>

<div id="outline-container-org7200bf3" class="outline-2">
<h3 id="org7200bf3">Insert JS debugger statement</h3>
<div class="outline-text-2" id="text-org7200bf3">
<p>
@cjk provided this tip. The debugger like Firebug will pause at the debugger statement. It saves me the time to locate JS file, to go to the specific line and set breakpoint after re-deploying the application.
</p>

<p>
Snippets:
<a href="https://github.com/redguardtoo/emacs.d/blob/master/snippets/js-mode/debugger.yasnippet">https://github.com/redguardtoo/emacs.d/blob/master/snippets/js-mode/debugger.yasnippet</a>
</p>

<p>
<a href="https://github.com/redguardtoo/emacs.d/blob/master/snippets/js-mode/debugger-cond-breakpoint-from-kill-ring.yasnippet">https://github.com/redguardtoo/emacs.d/blob/master/snippets/js-mode/debugger-cond-breakpoint-from-kill-ring.yasnippet</a>
</p>
</div>
</div>

<div id="outline-container-orge824e2b" class="outline-2">
<h3 id="orge824e2b">Bonus</h3>
<div class="outline-text-2" id="text-orge824e2b">
<p>
Similar snippets for Emacs Lisp are defined <a href="https://github.com/redguardtoo/emacs.d/tree/master/snippets/emacs-lisp-mode">HERE</a>.
</p>
</div>
</div>
</div>
            </div>
        </div>
        <div class="post">
            <h1 class="title"><a href="posts/use-bootstrapfont-awesomejquery-for-ie7-web-application/">Use bootstrap+font-awesome+jquery for IE7 web application</a></h1>
            <div class="meta">
                <div class="authordate">
                    <time class="timeago" datetime="2014-11-23T07:37:10+00:00">2014-11-23 07:37</time>
</div>
                <div class="stats">
                    
        
    <a href="posts/use-bootstrapfont-awesomejquery-for-ie7-web-application/#disqus_thread" data-disqus-identifier="cache/posts/use-bootstrapfont-awesomejquery-for-ie7-web-application.html">Comments</a>


                </div>
            
        <div itemprop="keywords" class="tags">
        <ul>
        Tags : 
           <li><a class="tag p-category" href="categories/css/" rel="tag">css</a></li>
           <li><a class="tag p-category" href="categories/en/" rel="tag">en</a></li>
           <li><a class="tag p-category" href="categories/ie/" rel="tag">ie</a></li>
           <li><a class="tag p-category" href="categories/javascript/" rel="tag">javascript</a></li>
        </ul>
</div>

            </div>
            <div class="body">
                <div>
<p>
Live demo:
<a href="http://binchen.org/schools/">http://binchen.org/schools/</a>
</p>

<p>
Screenshot:
<img src="https://cloud.githubusercontent.com/assets/184553/5156904/e86f11a6-733c-11e4-8312-a6c8ad2b17be.png" alt="e86f11a6-733c-11e4-8312-a6c8ad2b17be.png"></p>

<div id="outline-container-orgcc6e39f" class="outline-2">
<h3 id="orgcc6e39f">Environment</h3>
<div class="outline-text-2" id="text-orgcc6e39f">
<ul class="org-ul">
<li>Bootstrap 2.3.2</li>
<li>font-awesome 3.2.1</li>
<li>JQuery 1.8.2</li>
</ul>
<p>
I only use the grid layout from bootstrap and minimum API from jQuery.
</p>
</div>
</div>

<div id="outline-container-org728da9e" class="outline-2">
<h3 id="org728da9e">Notes</h3>
<div class="outline-text-2" id="text-org728da9e">
<ul class="org-ul">
<li>IE7 does not support media query. So I abandon "mobile first" strategy, new strategy is "IE7 first".</li>
<li>IE7 does not support inline-block properly, I need below css code hack:</li>
</ul>
<div class="org-src-container">

<pre><code class="lang-css">.myclass {
  display: inline-block;
  /* ie7*/
  *display: inline;
  zoom: 1;
}
</code></pre>

</div>
<ul class="org-ul">
<li>bootstrap's row-fluid has issues in IE7. I use row-fluid in this case, but have to hard code the row width sometimes.</li>
<li>add below code into javascript so that I can hack IE7-only css code:</li>
</ul>
<div class="org-src-container">

<pre><code class="lang-javascript">if($.browser.msie &amp;&amp; parseFloat($.browser.version) &lt; 8){
  that.ie7 = true;
  $('body').addClass('ie7');
}
</code></pre>

</div>
</div>
</div>
</div>
            </div>
        </div>
        <div class="post">
            <h1 class="title"><a href="posts/make-web-mode-support-html-with-angularjs-data-binding/">Make web-mode support HTML with AngularJS data-binding</a></h1>
            <div class="meta">
                <div class="authordate">
                    <time class="timeago" datetime="2014-11-21T11:45:24+00:00">2014-11-21 11:45</time>
</div>
                <div class="stats">
                    
        
    <a href="posts/make-web-mode-support-html-with-angularjs-data-binding/#disqus_thread" data-disqus-identifier="cache/posts/make-web-mode-support-html-with-angularjs-data-binding.html">Comments</a>


                </div>
            
        <div itemprop="keywords" class="tags">
        <ul>
        Tags : 
           <li><a class="tag p-category" href="categories/angular/" rel="tag">angular</a></li>
           <li><a class="tag p-category" href="categories/emacs/" rel="tag">emacs</a></li>
           <li><a class="tag p-category" href="categories/en/" rel="tag">en</a></li>
           <li><a class="tag p-category" href="categories/html/" rel="tag">html</a></li>
        </ul>
</div>

            </div>
            <div class="body">
                <div>
<p>
I find it very useful to use `M-x imenu` to jump to the  <a href="http://angularjs.org">AngularJS</a> binding point of one HTML file.
</p>

<p>
Insert below code into ~/.emacs:
</p>

<div class="org-src-container">

<pre><code class="lang-lisp">(with-eval-after-load 'web-mode
  ;; angular imenu
  (add-to-list 'web-mode-imenu-regexp-list
               '(" \\(ng-[a-z]*\\)=\"\\([a-zA-Z0-9]*\\)" 1 2 "=")))
</code></pre>

</div>
</div>
            </div>
        </div>
        <div class="post">
            <h1 class="title"><a href="posts/export-org-file-embedded-with-code-snippets/">Export org file embedded with code snippets</a></h1>
            <div class="meta">
                <div class="authordate">
                    <time class="timeago" datetime="2014-11-20T12:22:17+00:00">2014-11-20 12:22</time>
</div>
                <div class="stats">
                    
        
    <a href="posts/export-org-file-embedded-with-code-snippets/#disqus_thread" data-disqus-identifier="cache/posts/export-org-file-embedded-with-code-snippets.html">Comments</a>


                </div>
            
        <div itemprop="keywords" class="tags">
        <ul>
        Tags : 
           <li><a class="tag p-category" href="categories/emacs/" rel="tag">emacs</a></li>
           <li><a class="tag p-category" href="categories/en/" rel="tag">en</a></li>
           <li><a class="tag p-category" href="categories/export/" rel="tag">export</a></li>
           <li><a class="tag p-category" href="categories/html/" rel="tag">html</a></li>
           <li><a class="tag p-category" href="categories/org/" rel="tag">org</a></li>
        </ul>
</div>

            </div>
            <div class="body">
                <div>
<p>
CREATED: <span class="timestamp-wrapper"><span class="timestamp">&lt;2014-11-20 Thu&gt;</span></span>
</p>

<p>
UPDATED: <span class="timestamp-wrapper"><span class="timestamp">&lt;2015-06-06 Sat&gt;</span></span>
</p>

<div id="outline-container-org18052cb" class="outline-2">
<h3 id="org18052cb">problem</h3>
<div class="outline-text-2" id="text-org18052cb">
<p>
I use <a href="http://orgmode.org/">Org-mode</a> to record all my notes.
</p>

<p>
As a developer, I place code snippets from many programming languages into one org file.
</p>

<p>
The issue is when exporting the org file, major mode for each language will be loaded to render the code snippet.
</p>

<p>
It means the hooks of the major modes will be executed. Since I put lots of heavy weight setup things in those hooks, my exporting is extremely slow.
</p>

<p>
My hooks are also dependent on third party tools. So if anyone else uses my setup without those tools, his/her exporting will <a href="https://github.com/redguardtoo/emacs.d/issues/316">fail</a>.
</p>
</div>
</div>

<div id="outline-container-org2a3cb0e" class="outline-2">
<h3 id="org2a3cb0e">Solution</h3>
<div class="outline-text-2" id="text-org2a3cb0e">
</div>
<div id="outline-container-orgfaf9513" class="outline-3">
<h4 id="orgfaf9513">Setup</h4>
<div class="outline-text-3" id="text-orgfaf9513">
<p>
In order to solve the issue, I write a small function which will be called at the beginning of each major mode hook.
</p>

<p>
The function basically check whether the `(buffer-file-name)` is the temporary file created by Org-mode or the output HTML converted from org file. If answer is "YES", then code in major mode hook will not be executed.
</p>

<div class="org-src-container">

<pre><code class="lang-lisp">(defvar load-user-customized-major-mode-hook t)
(defvar cached-normal-file-full-path nil)
(defun is-buffer-file-temp ()
  (interactive)
  "If (buffer-file-name) is nil or a temp file or HTML file converted from org file"
  (let ((f (buffer-file-name))
        org
        (rlt t))
    (cond
     ((not load-user-customized-major-mode-hook) t)
     ((not f)
      ;; file does not exist at all
      (setq rlt t))
     ((string= f cached-normal-file-full-path)
      (setq rlt nil))
     ((string-match (concat "^" temporary-file-directory) f)
      ;; file is create from temp directory
      (setq rlt t))
     ((and (string-match "\.html$" f)
           (file-exists-p (setq org (replace-regexp-in-string "\.html$" ".org" f))))
      ;; file is a html file exported from org-mode
      (setq rlt t))
     (t
      ;; avoid calling to file-exists-p too often for performance reason
      (setq cached-normal-file-full-path f)
      (setq rlt nil)))
    rlt))
</code></pre>

</div>
</div>
</div>
<div id="outline-container-org1edcb8c" class="outline-3">
<h4 id="org1edcb8c">Usage</h4>
<div class="outline-text-3" id="text-org1edcb8c">
<p>
I use python-mode-hook setup as an example:
</p>
<div class="org-src-container">

<pre><code class="lang-lisp">(add-hook 'python-mode-hook
          '(lambda ()
             (unless (is-buffer-file-temp)
               (anaconda-mode)
               (eldoc-mode)
               (if (executable-find "pyflakes")
                   (flymake-python-pyflakes-load))
               (setq electric-indent-chars (delq ?: electric-indent-chars))
               )))
</code></pre>

</div>
</div>
</div>
</div>

<div id="outline-container-org6312645" class="outline-2">
<h3 id="org6312645">Tips</h3>
<div class="outline-text-2" id="text-org6312645">
</div>
<div id="outline-container-orgf68de3f" class="outline-3">
<h4 id="orgf68de3f">Export shell code</h4>
<div class="outline-text-3" id="text-orgf68de3f">
<p>
Exporting shell code will fail if `sh-mode` is loaded. So I use "bash" instead. Since there is no "bash-mode", exporting will be fine.
</p>
</div>
</div>
<div id="outline-container-org814c356" class="outline-3">
<h4 id="org814c356">Yasnippet setup</h4>
<div class="outline-text-3" id="text-org814c356">
<p>
To avoid loading yasnippets when exporting, I have to <a href="https://github.com/capitaomorte/yasnippet#use-yas-minor-mode-on-a-per-buffer-basis">"use yas-minor-mode on a per-buffer basis"</a>.
</p>
</div>
</div>
<div id="outline-container-orgab94bfe" class="outline-3">
<h4 id="orgab94bfe">Manually turn off the major-mode hook</h4>
<div class="outline-text-3" id="text-orgab94bfe">
<p>
It's controlled by global flag `load-user-customized-major-mode-hook`, as you can see from the "Setup" section.
</p>

<p>
Say I want to turn off the major mode hooks when `M-x org-publish`, here is the setup:
</p>
<div class="org-src-container">

<pre><code class="lang-lisp">(defadvice org-publish (around org-publish-advice activate)
  "Stop running major-mode hook when org-publish"
  (let ((old load-user-customized-major-mode-hook))
    (setq load-user-customized-major-mode-hook nil)
    ad-do-it
    (setq load-user-customized-major-mode-hook old)))
</code></pre>

</div>
</div>
</div>
<div id="outline-container-org32ae52a" class="outline-3">
<h4 id="org32ae52a">after-save-hook</h4>
<div class="outline-text-3" id="text-org32ae52a">
<p>
`after-save-hook` is the "Normal hook that is run after a buffer is saved to its file". You may also need tweak it up because it will be called when exporting org files
</p>
</div>
</div>
</div>
</div>
            </div>
        </div>
        <div class="post">
            <h1 class="title"><a href="posts/how-to-publish-static-html-blog-in-emacs-as-a-programmer/">How a programmer publish static HTML blog in Emacs</a></h1>
            <div class="meta">
                <div class="authordate">
                    <time class="timeago" datetime="2014-11-15T04:16:31+00:00">2014-11-15 04:16</time>
</div>
                <div class="stats">
                    
        
    <a href="posts/how-to-publish-static-html-blog-in-emacs-as-a-programmer/#disqus_thread" data-disqus-identifier="cache/posts/how-to-publish-static-html-blog-in-emacs-as-a-programmer.html">Comments</a>


                </div>
            
        <div itemprop="keywords" class="tags">
        <ul>
        Tags : 
           <li><a class="tag p-category" href="categories/emacs/" rel="tag">emacs</a></li>
           <li><a class="tag p-category" href="categories/en/" rel="tag">en</a></li>
           <li><a class="tag p-category" href="categories/ftp/" rel="tag">ftp</a></li>
        </ul>
</div>

            </div>
            <div class="body">
                <div>
<p>
I can publish my blog <b>in five seconds</b>, running only <b>one Emacs command</b>!
</p>

<p>
I give you a minimum solution at first, then I explain why and provide technical details.
</p>

<p>
Basic Emacs lisp knowledges are required.
</p>

<p>
Please note I'm <b>NOT</b> targeted at specific static site generator like <a href="http://getnikola.com/blog/">Nikola</a> or <a href="http://jekyllrb.com/">Jekyll</a>.
</p>

<div id="outline-container-orgda84227" class="outline-2">
<h3 id="orgda84227">Solution</h3>
<div class="outline-text-2" id="text-orgda84227">
<p>
Tested on <b>Linux and OSX</b>.
</p>

<p>
Requirements:
</p>
<ul class="org-ul">
<li>Org-mode bundled with Emacs 24.x</li>
<li>Nikola as the blog generator</li>
<li>FTP client <a href="http://www.ncftp.com/ncftp/">ncftp</a>
</li>
<li>Latest <a href="https://github.com/redguardtoo/org2nikola">org2nikola</a> (v0.0.9+)</li>
<li>Insert below code into ~/.emacs</li>
</ul>
<div class="org-src-container">

<pre><code class="lang-lisp">(defun org2nikola-after-hook-setup (title slug)
  (let ((url (concat "http://blog.yourdomain.net/posts/" slug ".html"))
        (nikola-dir (file-truename "~/projs/nikola-root"))
        (password "yourpassowrd")
        (username "yourusername")
        dir
        file
        lines
        rlt
        res
        cmd)
    (kill-new title)
    (kill-new url)
    (message "%s =&gt; kill-ring" url)
    (setq rlt (shell-command-to-string (format "cd %s; nikola build" nikola-dir)))
    (setq lines (split-string rlt "\n"))
    (dolist (l lines)
      (when (string-match "output\\(.*/\\)*\\([^/]*\\)$" l)
        (setq dir (match-string 1 l))
        (setq file (match-string 2 l))
        (setq cmd (format "ncftpput -b -u %s -p %s ftp.yourdomain.net /blog%s %s/output%s%s"
                          username password dir nikola-dir dir file))
        (message "cmd=%s" cmd)
        (shell-command cmd)
        ))
    ))

(add-hook 'org2nikola-after-hook 'org2nikola-after-hook-setup)
</code></pre>

</div>

<p>
You can write blog into org file, export and publicize it with command `M-x org2nikola-export-subtree`.
</p>
</div>
</div>

<div id="outline-container-org205236d" class="outline-2">
<h3 id="org205236d">Why</h3>
<div class="outline-text-2" id="text-org205236d">
<p>
I used <a href="https://wordpress.org">Wordpress</a> and <a href="https://github.com/punchagan/org2blog">Org2blog</a> for a very long time. Then I turned to static blog generator because:
</p>
<ul class="org-ul">
<li>Wordpress is slow to load web page</li>
<li>I waste too much time to "manage" Wordpress (applying security patch, fighting with spam comment …)</li>
<li>As a programmer, I need publish code snippets. Wordpress is <b>BAD</b> at rendering code.</li>
</ul>
<p>
Yes, only wordpress sucks. For Org2blog, I can only say good things. Actually, this article is inspired purely by <a href="https://github.com/punchagan">Puneeth Chaganti</a>'s excellent work on org2blog.
</p>
</div>
</div>

<div id="outline-container-org73375d3" class="outline-2">
<h3 id="org73375d3">Technical Details</h3>
<div class="outline-text-2" id="text-org73375d3">
</div>
<div id="outline-container-org8c92ca1" class="outline-3">
<h4 id="org8c92ca1">Generating HTML</h4>
<div class="outline-text-3" id="text-org8c92ca1">
<p>
As I said, Nikola is my blog generator which converts my org file into HTML.
</p>

<p>
But I prefer using <a href="http://orgmode.org/">Org-mode</a> to do the HTML rendering. Nikola only need handle remaining minor book keeping stuff (creating RSS feed, for example).
</p>

<p>
It's because I want to minimize the dependency. I may switch to other blog generator in the future. But my web site always has the <b>same look and feel</b> because the HTML is generated by Org-mode.
</p>

<p>
I learned this trick from Org2blog.
</p>

<p>
If we only use org-mode to create HTML, then extracting code snippet is really easy. All we need is to use regular expression to extract the content between HTML tag "&lt;pre&gt;".
</p>

<p>
Actually I don't even bother doing the extraction. I just replace all the "&lt;pre&gt;" tag with my own tag because I <b>assume</b> the HTML produced by org-mode is stable.
</p>

<p>
Here is the Emacs lisp code I borrowed from Org2blog:
</p>
<div class="org-src-container">

<pre><code class="lang-lisp">(defun org2nikola-replace-pre (html)
  "Replace pre blocks with sourcecode shortcode blocks.
shamelessly copied from org2blog/wp-replace-pre()"
  (save-excursion
    (let (pos code lang info params header code-start code-end html-attrs pre-class)
      (with-temp-buffer
        (insert html)
        (goto-char (point-min))
        (save-match-data
          (while (re-search-forward "&lt;pre\\(.*?\\)&gt;" nil t 1)

            ;; When the codeblock is a src_block
            (unless
                (save-match-data
                  (setq pre-class (match-string-no-properties 1))
                  (string-match "example" pre-class))
              ;; Replace the &lt;pre...&gt; text
              (setq lang (replace-regexp-in-string ".*src-\\([a-zA-Z0-9]+\\).*" "\\1" pre-class)  )

              (replace-match "")
              (setq code-start (point))

              ;; Go to end of code and remove &lt;/pre&gt;
              (re-search-forward "&lt;/pre.*?&gt;" nil t 1)
              (replace-match "")
              (setq code-end (point))
              (setq code (buffer-substring-no-properties code-start code-end))

              ;; Delete the code
              (delete-region code-start code-end)
              ;; Stripping out all the code highlighting done by htmlize
              (setq code (replace-regexp-in-string "&lt;.*?&gt;" "" code))
              ;; class linenums will add stripes which will destory the 3rd party skins
              (insert (concat "\n&lt;pre class=\"prettyprint lang-"
                              (org2nikola-fix-unsupported-language lang)
                              "\"&gt;\n"
                              code
                              "&lt;/pre&gt;\n"))
              )))

        ;; Get the new html!
        (setq html (buffer-substring-no-properties (point-min) (point-max))))
      ))
  html)
</code></pre>

</div>

<p>
The code snippet inside "&lt;pre&gt;" tag could be rendered by 3rd party javascript library <a href="https://code.google.com/p/google-code-prettify/">google-code-prettify</a> or <a href="http://alexgorbatchev.com/SyntaxHighlighter/">SyntaxHighlighter</a>.
</p>

<p>
BTW, the last straw that push me away the Wordpress is its wrapper of SyntaxHighlighter. SyntaxHighlighter is a beautiful and user-friendly library. But the wrapper forces me to tweak the php code in terrible editor from Wordpress.
</p>
</div>
</div>

<div id="outline-container-orgdb264c8" class="outline-3">
<h4 id="orgdb264c8">Create blog posts</h4>
<div class="outline-text-3" id="text-orgdb264c8">
<p>
Emacs creates HTML files and meta files.  Things created by Emacs will be copied into Nikola's folder.
</p>

<p>
Nikola's duty is simple. Basically it only copy my stuff from its input folder to its output folder when I trigger "nikola build" command.
</p>

<p>
The "nikola build" command will also dump the list of files to be uploaded into stdout.
</p>

<p>
The build message dumped:
</p>
<pre class="example">
Scanning posts....done!
.  render_archive:output/2014/index.html
.  render_sources:output/posts/jump-to-the-positions-before-and-after-m-x-imenu.wp
.  render_posts:cache/posts/jump-to-the-positions-before-and-after-m-x-imenu.html
.  render_indexes:output/index.html
.  render_indexes:output/index-17.html
.  render_tags:output/categories/en.html
.  render_tags:output/categories/emacs.html
.  render_tags:output/assets/js/tag_cloud_data.json
.  render_tags:output/categories/emacs.xml
.  generate_rss:output/rss.xml
.  render_pages:output/posts/jump-to-the-positions-before-and-after-m-x-imenu.html
.  render_pages:output/posts/why-emacs-is-better-editor-part-two.html
.  render_tags:output/categories/en.xml
</pre>

<p>
Only the files in sub-folder "output" need be uploaded.
</p>
</div>
</div>

<div id="outline-container-org5b5d9fb" class="outline-3">
<h4 id="org5b5d9fb">Preprocess nikola output</h4>
<div class="outline-text-3" id="text-org5b5d9fb">
<p>
It's all done by Emacs Lisp.
</p>

<p>
The final output contain lines like:
</p>
<div class="org-src-container">

<pre><code class="lang-sh">ncftpput -b -u yourname -p yourpassword ftp.yourdomain.net /blog/2014/ /home/yourname/nikola-root/output/2014/index.html
</code></pre>

</div>

<p>
As you can see, each line is a ftp upload command we need execute in shell.
</p>
</div>
</div>
<div id="outline-container-orge57b4a8" class="outline-3">
<h4 id="orge57b4a8">FTP upload</h4>
<div class="outline-text-3" id="text-orge57b4a8">
<p>
Ncftp is my choice of FTP client. It's solid and efficient.
</p>

<p>
Its command line tool "ncftpput" has a flag "-b". With the flag ncftpput will start a daemon at background and handles the ftp upload as a batch job submit. It means ftp connection will be reused and the user is not blocked by the upload operation. So the upload operation is <b>extremely fast</b>.
</p>

<p>
I use Emacs Lisp API `file-truename` to convert all relative path to absolute path to avoid any platform (OSX) issue.
</p>

<p>
BTW, you can `cat ~/.ncftp/spool/log` to check the FTP upload status.
</p>
</div>
</div>
</div>

<div id="outline-container-org35ef8cb" class="outline-2">
<h3 id="org35ef8cb">Summary</h3>
<div class="outline-text-2" id="text-org35ef8cb">
<p>
The workflow is simple.
</p>

<p>
Emacs and third party JS libraries are responsible for the look and feel of my website.
</p>

<p>
Blog generator like Nikola is just a thin layer to relay the HTML files created by Emacs.
</p>

<p>
Ncftp will upload HTML files. It's the best FTP client which could be easily integrated into Emacs.
</p>
</div>
</div>
</div>
            </div>
        </div>
        <div class="post">
            <h1 class="title"><a href="posts/jump-to-the-positions-before-and-after-m-x-imenu/">Jump to the positions before and after `M-x imenu`</a></h1>
            <div class="meta">
                <div class="authordate">
                    <time class="timeago" datetime="2014-11-15T02:15:32+00:00">2014-11-15 02:15</time>
</div>
                <div class="stats">
                    
        
    <a href="posts/jump-to-the-positions-before-and-after-m-x-imenu/#disqus_thread" data-disqus-identifier="cache/posts/jump-to-the-positions-before-and-after-m-x-imenu.html">Comments</a>


                </div>
            
        <div itemprop="keywords" class="tags">
        <ul>
        Tags : 
           <li><a class="tag p-category" href="categories/emacs/" rel="tag">emacs</a></li>
           <li><a class="tag p-category" href="categories/en/" rel="tag">en</a></li>
        </ul>
</div>

            </div>
            <div class="body">
                <div>
<p>
As a programmer, I use `M-x imenu` to jump to the callee when editing a code file. After a little code tweaking in the callee, I need jump back to caller as quickly as possible.
</p>

<div id="outline-container-org0f5ae1c" class="outline-2">
<h3 id="org0f5ae1c">Solution</h3>
<div class="outline-text-2" id="text-org0f5ae1c">
<p>
Insert below code to ~/.emacs:
</p>
<div class="org-src-container">

<pre><code class="lang-lisp">(defvar rimenu-position-pair nil "positions before and after imenu jump")
(add-hook 'imenu-after-jump-hook
          (lambda ()
            (let ((start-point (marker-position (car mark-ring)))
                  (end-point (point)))
              (setq rimenu-position-pair (list start-point end-point)))))

(defun rimenu-jump ()
  "jump to the closest before/after position of latest imenu jump"
  (interactive)
  (when rimenu-position-pair
    (let ((p1 (car rimenu-position-pair))
          (p2 (cadr rimenu-position-pair)))

      ;; jump to the far way point of the rimenu-position-pair
      (if (&lt; (abs (- (point) p1))
             (abs (- (point) p2)))
          (goto-char p2)
          (goto-char p1))
      )))
</code></pre>

</div>

<p>
Now you can use `M-x rimenu-jump` to jump.
</p>
</div>
</div>

<div id="outline-container-org13b840b" class="outline-2">
<h3 id="org13b840b">Technical details</h3>
<div class="outline-text-2" id="text-org13b840b">
<p>
Imenu will push the start point into mark-ring. After reaching the destination, it will call the imenu-after-jump-hook where I can store the end point. 
</p>

<p>
I store the start/end point into rimenu-position-pair and `M-x rimenu-jump` goes to the farthest one from the pair.
</p>

<p>
Here is the <a href="https://plus.google.com/110954683162859211810/posts/gcdj1ZZT2zQ">original discussion on G+</a>. Thanks to <a href="https://plus.google.com/+jorgeAAlfaroMurillo/posts">Jorge A. Alfaro Murillo</a> for enlightening me on the solution.
</p>
</div>
</div>
</div>
            </div>
        </div>
        <div class="post">
            <h1 class="title"><a href="posts/why-emacs-is-better-editor-part-two/">Why Emacs is a better editor, part two</a></h1>
            <div class="meta">
                <div class="authordate">
                    <time class="timeago" datetime="2014-11-01T11:06:17+00:00">2014-11-01 11:06</time>
</div>
                <div class="stats">
                    
        
    <a href="posts/why-emacs-is-better-editor-part-two/#disqus_thread" data-disqus-identifier="cache/posts/why-emacs-is-better-editor-part-two.html">Comments</a>


                </div>
            
        <div itemprop="keywords" class="tags">
        <ul>
        Tags : 
           <li><a class="tag p-category" href="categories/emacs/" rel="tag">emacs</a></li>
           <li><a class="tag p-category" href="categories/en/" rel="tag">en</a></li>
           <li><a class="tag p-category" href="categories/javascript/" rel="tag">javascript</a></li>
        </ul>
</div>

            </div>
            <div class="body">
                <div>
<p>
If you are impatient, jump to the "Quick Start" and paste my setup into your ~/.emacs. That's all you need to do!
</p>

<p>
No extra setup needed! Then keep using your js2-mode happily, as if nothing happened. ;) 
</p>

<div id="outline-container-org4e65bd8" class="outline-2">
<h3 id="org4e65bd8">Problem</h3>
<div class="outline-text-2" id="text-org4e65bd8">
<p>
In my previous article <a href="http://blog.binchen.org/posts/why-emacs-is-better-editor.html">Why Emacs is better editor - a case study for javascript developer</a>, I proved that Emacs is better than <a href="http://www.sublimetext.com/">Sublime Text</a>.
</p>

<p>
So for this so-called "Goto Symbol" feature, Emacs wins.
</p>

<p>
It's because we use a plugin <a href="https://github.com/mooz/js2-mode">js2-mode</a>. It's actually a javascript parser which creates the symbols from AST.
</p>

<p>
But in real world, regular expression is better, sometimes.
</p>

<p>
In modern MVC javascript frameworks (<a href="https://angularjs.org/">Angular</a>, for example), you will meet below code,
</p>
<div class="org-src-container">

<pre><code class="lang-javascript">app.controller('MyController', function ($scope, $http) {
  // ...
});
</code></pre>

</div>

<p>
As you can see, using regular expression to extract the string "MyController" is more versatile and simpler.
</p>
</div>
</div>

<div id="outline-container-org568b21b" class="outline-2">
<h3 id="org568b21b">Solution</h3>
<div class="outline-text-2" id="text-org568b21b">
<p>
My latest <a href="https://github.com/mooz/js2-mode/pull/169">contribution to js2-mode</a> solves this problem perfectly. It <b>combines the powers of AST and regular expression</b>.
</p>

<p>
The js2-mode will integrate this feature soon. I will notify you when next version is ready.
</p>

<p>
Let's cut off the boring technical details and see the demo,
</p>

<p>
For a simple <a href="https://gist.github.com/redguardtoo/558ea0133daa72010b73#file-hello-js">hello.js</a> with below content,
</p>
<div class="org-src-container">

<pre><code class="lang-javascript">function helloworld() {
  console.log('hello called');
}

function test() {
  console.log('test called');
}

app.controller('MyController', function ($scope, $http) {
  console.log('MyController registered');

  var that = this;

  $scope.test1 = function() {
    console.log('$scope.test called');
  };

  $scope.hello = function() {
    console.log('$scope.hello called');
  };

  $scope.fn1 = function () {

    function test() {
      console.log('hello world');
    };
    console.log('hello');
  };
});
</code></pre>

</div>

<p>
<b>Emacs:</b>
<img src="https://cloud.githubusercontent.com/assets/184553/4871228/3ebe6588-61a5-11e4-9e9f-e6eb8218e2ee.png" alt="3ebe6588-61a5-11e4-9e9f-e6eb8218e2ee.png"></p>

<p>
<b>Sublime3 (build 3047):</b> 
<img src="https://cloud.githubusercontent.com/assets/184553/4871347/c33b8fee-61ae-11e4-8072-671935b68d6b.png" alt="c33b8fee-61ae-11e4-8072-671935b68d6b.png"></p>

<p>
Please note Emacs displays <b>two functions with the same name "test" correctly</b>!
</p>

<p>
BTW, my previous "Why Emacs is better" article got many feedbacks from Sublime users.
</p>

<p>
One feedback is that my comparison is not fair because I'm <b>comparing Emacs plugin with naked Sublime</b>. Though I did some research before writing the article,
I could be wrong. Please enlighten me if you know such Sublime plugins.
</p>

<p>
Another valuable feedback is that native Sublime provides better experience <b>out of the box</b> for junior developers. I admit that's a good point. But Emacs provides many awesome choices <b>out of the box</b> if junior guys start from <a href="https://github.com/purcell">setups of the masters (like Steven Purcell)</a>.
</p>

<p>
Sublime users also argue that Sublime3 uses <a href="https://www.python.org/">Python</a>. Python is a <b>better programming language</b>. I'm qualified to answer this question because I wrote some large commercial Python application when I worked in Kodak R&amp;D. First version I used was v2.2. So I've got about <b>10 years experience</b> in Python. And I write lots of <a href="https://github.com/redguardtoo/">Emacs Lisp code</a> these days. My opinion is that both languages are good enough as DSL for text editors. In Python, you can use OO. In Emacs Lisp, you can treat function as object and there are <a href="https://www.gnu.org/software/emacs/manual/html_node/elisp/Defining-Macros.html">Macros</a> and <a href="https://www.gnu.org/software/emacs/manual/html_node/elisp/Advising-Functions.html">Advising</a>. Both languages have enough widgets to shoot yourself in the foot. Python is surely newbie-friendly. But <b>number of newbies</b> doesn't matter in high-end rival.
</p>
</div>
</div>

<div id="outline-container-orgcb873e0" class="outline-2">
<h3 id="orgcb873e0">Quick Start</h3>
<div class="outline-text-2" id="text-orgcb873e0">
<p>
I'm still discussing with the js2-mode maintainer Dmitry Gutov about the best way to merge my patch.
</p>

<p>
Dmitry Gutov updated the algorithm to parse the imenu items by walking the AST instead. It's better than my REGEX hacking because AST could show the context of the function.
</p>

<p>
But my patch is still useful for extract strings from modern JS framework, as I've shown you in Angular example. I'm just updating my pull request to be compatible with the new AST walk algorithm.
</p>

<p>
In the meantime, you can paste below code into your ~/.emacs before the patch is officially merged.
</p>
<div class="org-src-container">

<pre><code class="lang-lisp">;; below regex list could be used in both js-mode and js2-mode
(setq javascript-common-imenu-regex-list
      '(("Controller" "\.controller( *'\\([^']+\\)" 1)
        ("Filter" "\.filter( *'\\([^']+\\)" 1)
        ("Factory" "\.factory( *'\\([^']+\\)" 1)
        ("Service" "\.service( *'\\([^']+\\)" 1)
        ("Directive" "\.directive( *'\\([^']+\\)" 1)
        ("Event" "\.\$on( *'\\([^']+\\)" 1)
        ("Config" "\.config( *function *( *\\([^\)]+\\)" 1)
        ("Config" "\.config( *\\[ *'\\([^']+\\)" 1)
        ("OnChange" " *\$('\\([^']*\\)').*\.change *( *function" 1)
        ("OnClick" " *\$('\\([^']*\\)').*\.click *( *function" 1)
        ("Watch" "\.\$watch( *'\\([^']+\\)" 1)
        ("Function" "function\\s-+\\([^ ]+\\)(" 1)
        ("Function" " \\([^ ]+\\)\\s-*=\\s-*function\\s-*(" 1)))

;; {{ patching imenu in js2-mode
(setq js2-imenu-extra-generic-expression javascript-common-imenu-regex-list)

(defvar js2-imenu-original-item-lines nil
  "List of line infomration of original imenu items.")

(defun js2-imenu--get-line-start-end (pos)
  (let (b e)
    (save-excursion
      (goto-char pos)
      (setq b (line-beginning-position))
      (setq e (line-end-position)))
    (list b e)))

(defun js2-imenu--get-pos (item)
  (let (val)
    (cond
     ((integerp item)
      (setq val item))

     ((markerp item)
      (setq val (marker-position item))))

    val))

(defun js2-imenu--get-extra-item-pos (item)
  (let (val)
    (cond
     ((integerp item)
      (setq val item))

     ((markerp item)
      (setq val (marker-position item)))

     ;; plist
     ((and (listp item) (listp (cdr item)))
      (setq val (js2-imenu--get-extra-item-pos (cadr item))))

     ;; alist
     ((and (listp item) (not (listp (cdr item))))
      (setq val (js2-imenu--get-extra-item-pos (cdr item)))))

    val))

(defun js2-imenu--extract-line-info (item)
  "Recursively parse the original imenu items created by js2-mode.
The line numbers of items will be extracted."
  (let (val)
    (if item
      (cond
       ;; Marker or line number
       ((setq val (js2-imenu--get-pos item))
        (push (js2-imenu--get-line-start-end val)
              js2-imenu-original-item-lines))

       ;; The item is Alist, example: (hello . 163)
       ((and (listp item) (not (listp (cdr item))))
        (setq val (js2-imenu--get-pos (cdr item)))
        (if val (push (js2-imenu--get-line-start-end val)
                      js2-imenu-original-item-lines)))

       ;; The item is a Plist
       ((and (listp item) (listp (cdr item)))
        (js2-imenu--extract-line-info (cadr item))
        (js2-imenu--extract-line-info (cdr item)))

       ;;Error handling
       (t (message "Impossible to here! item=%s" item)
          )))
    ))

(defun js2-imenu--item-exist (pos lines)
  "Try to detect does POS belong to some LINE"
  (let (rlt)
    (dolist (line lines)
      (if (and (&lt; pos (cadr line)) (&gt;= pos (car line)))
          (setq rlt t)))
    rlt))

(defun js2-imenu--is-item-already-created (item)
  (unless (js2-imenu--item-exist
           (js2-imenu--get-extra-item-pos item)
           js2-imenu-original-item-lines)
    item))

(defun js2-imenu--check-single-item (r)
  (cond
   ((and (listp (cdr r)))
    (let (new-types)
      (setq new-types
            (delq nil (mapcar 'js2-imenu--is-item-already-created (cdr r))))
      (if new-types (setcdr r (delq nil new-types))
        (setq r nil))))
   (t (if (js2-imenu--item-exist (js2-imenu--get-extra-item-pos r)
                                 js2-imenu-original-item-lines)
          (setq r nil))))
  r)

(defun js2-imenu--remove-duplicate-items (extra-rlt)
  (delq nil (mapcar 'js2-imenu--check-single-item extra-rlt)))

(defun js2-imenu--merge-imenu-items (rlt extra-rlt)
  "RLT contains imenu items created from AST.
EXTRA-RLT contains items parsed with simple regex.
Merge RLT and EXTRA-RLT, items in RLT has *higher* priority."
  ;; Clear the lines.
  (set (make-variable-buffer-local 'js2-imenu-original-item-lines) nil)
  ;; Analyze the original imenu items created from AST,
  ;; I only care about line number.
  (dolist (item rlt)
    (js2-imenu--extract-line-info item))

  ;; @see https://gist.github.com/redguardtoo/558ea0133daa72010b73#file-hello-js
  ;; EXTRA-RLT sample:
  ;; ((function ("hello" . #&lt;marker 63&gt;) ("bye" . #&lt;marker 128&gt;))
  ;;  (controller ("MyController" . #&lt;marker 128))
  ;;  (hellworld . #&lt;marker 161&gt;))
  (setq extra-rlt (js2-imenu--remove-duplicate-items extra-rlt))
  (append rlt extra-rlt))

(with-eval-after-load 'js2-mode
  (defadvice js2-mode-create-imenu-index (around my-js2-mode-create-imenu-index activate)
    (let (extra-rlt)
      ad-do-it
      (setq extra-rlt
            (save-excursion
              (imenu--generic-function js2-imenu-extra-generic-expression)))
      (setq ad-return-value (js2-imenu--merge-imenu-items ad-return-value extra-rlt))
      ad-return-value)))
;; }}
</code></pre>

</div>
</div>
</div>
</div>
            </div>
        </div>
    
        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-19.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-17.html" rel="next">Older posts</a>
            </li>
        </ul></nav><script>var disqus_shortname="chenbin0";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script><footer id="footer"><p>Contents © 2020         <a href="mailto:chenbin.sh@gmail.com">Chen Bin</a> - Powered by         <a href="http://getnikola.com" rel="nofollow">Nikola</a>         </p>
            
        </footer>
</div>
    </section><script src="assets/js/all-nocdn.js" type="text/javascript"></script><script type="text/javascript">
         document.addEventListener('DOMContentLoaded', function() {
           var items = document.getElementsByClassName('timeago'), e, pd;
           for (var i = 0; i < items.length; i++) {
             e = items[i];
             pd = moment(new Date(e.getAttribute('datetime')));
             e.innerHTML = pd.fromNow();
             e.setAttribute('title', pd.format('LLLL'));
           }
         });
        </script>
</body>
</html>
