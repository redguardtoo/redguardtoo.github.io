<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="Linux, Programming, Emacs">
<meta name="viewport" content="width=device-width">
<title>Chen's blog (old posts, page 6) | Chen's blog</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link rel="alternate" type="application/rss+xml" title="RSS" href="rss.xml">
<link rel="canonical" href="http://blog.binchen.org/index-6.html">
<!--[if lt IE 9]><script src="/assets/js/html5.js"></script><![endif]-->
</head>
<body>
    <section class="social"><ul>
<li><a href="index.html" title="Home"><i class="icon-home"></i></a></li>
            <li><a href="archive.html" title="Archives"><i class="icon-folder-open-alt"></i></a></li>
            <li><a href="categories/index.html" title="Tags"><i class="icon-tags"></i></a></li>
            <li><a href="rss.xml" title="RSS"><i class="icon-rss"></i></a></li>
            <li><a href="stories/about.html" title="About me"><i class="icon-user"></i></a></li>
            <li><a href="https://twitter.com/chen_bin" title="My Twitter"><i class="icon-twitter"></i></a></li>
            <li><a href="https://github.com/redguardtoo" title="My Github"><i class="icon-github"></i></a></li>

        </ul></section><section class="page-content"><div class="content" rel="main">
            
        <div class="post">
            <h1 class="title"><a href="posts/toggle-http-proxy-in-emacs-w3m/">Toggle http proxy in emacs-w3m</a></h1>
            <div class="meta">
                <div class="authordate">
                    <time class="timeago" datetime="2013-01-04T17:50:00+00:00">2013-01-04 17:50</time>
</div>
                <div class="stats">
                    
        
    <a href="posts/toggle-http-proxy-in-emacs-w3m/#disqus_thread" data-disqus-identifier="cache/posts/toggle-http-proxy-in-emacs-w3m.html">Comments</a>


                </div>
            
        <div itemprop="keywords" class="tags">
        <ul>
        Tags : 
           <li><a class="tag p-category" href="categories/elisp/" rel="tag">elisp</a></li>
           <li><a class="tag p-category" href="categories/emacs/" rel="tag">emacs</a></li>
           <li><a class="tag p-category" href="categories/en/" rel="tag">en</a></li>
           <li><a class="tag p-category" href="categories/http/" rel="tag">http</a></li>
           <li><a class="tag p-category" href="categories/proxy/" rel="tag">proxy</a></li>
        </ul>
</div>

            </div>
            <div class="body">
                <div>
<p>
<a href="http://www.emacswiki.org/emacs/emacs-w3m">emacs-w3m</a> is a browser which handles all my basic web surfing needs.
</p>

<p>
For some reason, I need switch my http proxy frequently.
</p>

<p>
The solution is to set/unset the environment variable "http_proxy" in elisp code. Restarting the w3m session after change the environment variable is not needed at all.
</p>

<p>
Here is my code:
</p>

<div class="org-src-container">

<pre><code class="lang-lisp">(defun toggle-env-http-proxy ()
  "set/unset the environment variable http_proxy which w3m uses"
  (interactive)
  (let ((proxy "http://127.0.0.1:8000"))
    (if (string= (getenv "http_proxy") proxy)
        ;; clear the proxy
        (progn
          (setenv "http_proxy" "")
          (message "env http_proxy is empty now"))
      ;; set the proxy
      (setenv "http_proxy" proxy)
      (message "env http_proxy is %s now" proxy))))
</code></pre>

</div>
</div>
            </div>
        </div>
        <div class="post">
            <h1 class="title"><a href="posts/use-popfile-at-linux/">Use POPFile at Linux</a></h1>
            <div class="meta">
                <div class="authordate">
                    <time class="timeago" datetime="2012-12-28T09:18:54+00:00">2012-12-28 09:18</time>
</div>
                <div class="stats">
                    
        
    <a href="posts/use-popfile-at-linux/#disqus_thread" data-disqus-identifier="cache/posts/use-popfile-at-linux.html">Comments</a>


                </div>
            
        <div itemprop="keywords" class="tags">
        <ul>
        Tags : 
           <li><a class="tag p-category" href="categories/email/" rel="tag">email</a></li>
           <li><a class="tag p-category" href="categories/en/" rel="tag">en</a></li>
           <li><a class="tag p-category" href="categories/filter/" rel="tag">filter</a></li>
           <li><a class="tag p-category" href="categories/linux/" rel="tag">linux</a></li>
           <li><a class="tag p-category" href="categories/popfile/" rel="tag">popfile</a></li>
           <li><a class="tag p-category" href="categories/spam/" rel="tag">spam</a></li>
        </ul>
</div>

            </div>
            <div class="body">
                <div>
<p>
CREATED: <span class="timestamp-wrapper"><span class="timestamp">&lt;2012-12-28 Fri&gt;</span></span>
</p>

<p>
UPDATED: <span class="timestamp-wrapper"><span class="timestamp">&lt;2017-03-12 Sun&gt;</span></span>
</p>

<p>
<a href="http://getpopfile.org">POPFile</a> automatically sorts emails.
</p>

<div id="outline-container-orgf1e5a4e" class="outline-2">
<h3 id="orgf1e5a4e">Install POPFile</h3>
<div class="outline-text-2" id="text-orgf1e5a4e">
<p>
<a href="http://getpopfile.org/docs/download">Download and extract cross-platform version</a> to <code>~/bin/popfile/</code>.
</p>
</div>
</div>

<div id="outline-container-org0086468" class="outline-2">
<h3 id="org0086468">Install third party packages</h3>
<div class="outline-text-2" id="text-org0086468">
<p>
Run:
</p>
<div class="org-src-container">

<pre><code class="lang-sh">cpan DBD::SQLite DBI Date::Format Date::Parse HTML::Tagset HTML::Template IO::Socket::SSL Net::IDN::Encode Mozilla::CA Encode:IMAPUTF7
</code></pre>

</div>

<p>
When being asked by cpan, say you prefer installing local lib.
</p>

<p>
My cpan configuration <code>~/.cpan/CPAN/MyConfig.pm</code>,
</p>
<div class="org-src-container">

<pre><code class="lang-perl">$CPAN::Config = {
  'applypatch' =&gt; q[],
  'auto_commit' =&gt; q[0],
  'build_cache' =&gt; q[100],
  'build_dir' =&gt; q[/home/cb/.cpan/build],
  'build_dir_reuse' =&gt; q[0],
  'build_requires_install_policy' =&gt; q[yes],
  'bzip2' =&gt; q[/bin/bzip2],
  'cache_metadata' =&gt; q[1],
  'check_sigs' =&gt; q[0],
  'colorize_output' =&gt; q[0],
  'commandnumber_in_prompt' =&gt; q[1],
  'connect_to_internet_ok' =&gt; q[1],
  'cpan_home' =&gt; q[/home/cb/.cpan],
  'ftp_passive' =&gt; q[1],
  'ftp_proxy' =&gt; q[],
  'getcwd' =&gt; q[cwd],
  'gpg' =&gt; q[/usr/bin/gpg],
  'gzip' =&gt; q[/bin/gzip],
  'halt_on_failure' =&gt; q[0],
  'histfile' =&gt; q[/home/cb/.cpan/histfile],
  'histsize' =&gt; q[100],
  'http_proxy' =&gt; q[],
  'inactivity_timeout' =&gt; q[0],
  'index_expire' =&gt; q[90],
  'inhibit_startup_message' =&gt; q[0],
  'keep_source_where' =&gt; q[/home/cb/.cpan/sources],
  'load_module_verbosity' =&gt; q[none],
  'make' =&gt; q[/usr/bin/make],
  'make_arg' =&gt; q[],
  'make_install_make_command' =&gt; q[/usr/bin/make],
  'mbuild_arg' =&gt; q[--install-dirs site],
  'mbuild_install_arg' =&gt; q[./Build],
  'mbuild_install_build_command' =&gt; q[./Build],
  'mbuildpl_arg' =&gt; q[--installdirs site],
  'no_proxy' =&gt; q[],
  'pager' =&gt; q[/usr/bin/less],
  'patch' =&gt; q[/usr/bin/patch],
  'perl5lib_verbosity' =&gt; q[none],
  'prefer_external_tar' =&gt; q[1],
  'prefer_installer' =&gt; q[MB],
  'prefs_dir' =&gt; q[/home/cb/.cpan/prefs],
  'prerequisites_policy' =&gt; q[follow],
  'recommends_policy' =&gt; q[1],
  'scan_cache' =&gt; q[atstart],
  'shell' =&gt; q[/bin/bash],
  'show_unparsable_versions' =&gt; q[0],
  'show_upload_date' =&gt; q[0],
  'show_zero_versions' =&gt; q[0],
  'suggests_policy' =&gt; q[0],
  'tar' =&gt; q[/bin/tar],
  'tar_verbosity' =&gt; q[none],
  'term_is_latin' =&gt; q[1],
  'term_ornaments' =&gt; q[1],
  'test_report' =&gt; q[0],
  'trust_test_report_history' =&gt; q[0],
  'unzip' =&gt; q[/usr/bin/unzip],
  'urllist' =&gt; [q[http://mirror.optusnet.com.au/CPAN/]],
  'use_prompt_default' =&gt; q[0],
  'use_sqlite' =&gt; q[0],
  'version_timeout' =&gt; q[15],
  'wget' =&gt; q[/usr/bin/wget],
  'yaml_load_code' =&gt; q[0],
  'yaml_module' =&gt; q[YAML],
};
__END__
</code></pre>

</div>

<p>
<code>cpan</code> will append setup into <code>~/.bashrc</code>,
</p>
<div class="org-src-container">

<pre><code class="lang-sh">PATH="$HOME/perl5/bin${PATH:+:${PATH}}"; export PATH;
PERL5LIB="$HOME/perl5/lib/perl5${PERL5LIB:+:${PERL5LIB}}"; export PERL5LIB;
PERL_LOCAL_LIB_ROOT="$HOME/perl5${PERL_LOCAL_LIB_ROOT:+:${PERL_LOCAL_LIB_ROOT}}"; export PERL_LOCAL_LIB_ROOT;
PERL_MB_OPT="--install_base \"$HOME/perl5\""; export PERL_MB_OPT;
PERL_MM_OPT="INSTALL_BASE=$HOME/perl5"; export PERL_MM_OPT;
</code></pre>

</div>

<p>
Double check installed packages:
</p>
<div class="org-src-container">

<pre><code class="lang-sh">perl -MDBI -e 'print $MIME::DBI::VERSION'
</code></pre>

</div>

<p>
If there is any error:
</p>
<div class="org-src-container">

<pre><code class="lang-sh">perl -V
rm -rf ~/perl5/*
cpan DBD::SQLite DBI Date::Format Date::Parse HTML::Tagset HTML::Template IO::Socket::SSL Net::IDN::Encode MOZILLA::CA
</code></pre>

</div>
</div>
</div>

<div id="outline-container-org9d9396d" class="outline-2">
<h3 id="org9d9396d">Setup</h3>
<div class="outline-text-2" id="text-org9d9396d">
<p>
I only use IMAP. The purpose of tweak POP3 port is only to make the program executable without root permission.
</p>

<p>
See <a href="http://getpopfile.org/docs/howtos:mayneedroot">http://getpopfile.org/docs/howtos:mayneedroot</a> for details.
</p>

<p>
Run the below command to fix the root issue.
</p>
<div class="org-src-container">

<pre><code class="lang-sh">sed -i 's/pop3_port \+110/pop3_port 1110/g' ~/bin/popfile/popfile.cfg
</code></pre>

</div>


<p>
Davmail is a gateway to convert Outlook/Exchange service to IMAP/POP3). It's required if and only if you use Microsoft's Exchange/Outlook.
</p>

<p>
If you don't use Davmail and fetch mails directly, you'd better set <code>imap_expunge 1</code> to fix <a href="http://getpopfile.org/discussion/1/550/2144">Microsoft Office 365 issue</a>.
</p>

<p>
Please disable ssl if running local Davmail Server only. Or else, ssl should be enabled.
</p>

<p>
My popfile setup,
</p>
<div class="org-src-container">

<pre><code class="lang-ini">bayes_bad_sqlite_version 4.0.0
bayes_corpus corpus
bayes_database popfile.db
bayes_dbauth 
bayes_dbconnect dbi:SQLite:dbname=$dbname
bayes_dbuser 
bayes_hostname 192-168-1-3.tpgi.com.au
bayes_localhostname 
bayes_nihongo_parser kakasi
bayes_sqlite_journal_mode delete
bayes_sqlite_tweaks 4294967295
bayes_subject_mod_left [
bayes_subject_mod_pos 1
bayes_subject_mod_right ]
bayes_unclassified_weight 100
bayes_xpl_angle 0
config_pidcheck_interval 5
config_piddir ./
GLOBAL_debug 1
GLOBAL_last_update_check 1407715200
GLOBAL_message_cutoff 100000
GLOBAL_msgdir messages/
GLOBAL_ssl_verify_peer_certs 0
GLOBAL_timeout 60
GLOBAL_update_check 1
history_archive 0
history_archive_classes 0
history_archive_dir archive
history_history_days 2
html_cache_templates 0
html_column_characters 0
html_columns +inserted,+from,+to,-cc,+subject,-date,-size,+bucket
html_date_format 
html_language English
html_last_reset Sat Dec  1 11:06:48 2012
html_local 0
html_page_size 20
html_password b6b3637136ad630eba43aa5ee7106780
html_port 8888
html_search_filter_highlight 0
html_send_stats 1
html_session_dividers 1
html_show_bucket_help 1
html_show_training_help 0
html_skin simplyblue
html_strict_templates 0
html_test_language 0
html_wordtable_format 
imap_bucket_folder_mappings job--&gt;job--&gt;geek--&gt;geek--&gt;business--&gt;business--&gt;ad--&gt;ad--&gt;unclassified--&gt;INBOX--&gt;work--&gt;work--&gt;
imap_enabled 1
imap_expunge 1
imap_hostname localhost
imap_login binc1
imap_password password1
imap_port 1143
imap_training_mode 0
imap_uidnexts work--&gt;749--&gt;job--&gt;5914--&gt;INBOX--&gt;20736--&gt;geek--&gt;5009--&gt;ad--&gt;1296--&gt;business--&gt;15--&gt;
imap_uidvalidities job--&gt;98--&gt;work--&gt;107--&gt;ad--&gt;100--&gt;business--&gt;106--&gt;geek--&gt;99--&gt;INBOX--&gt;2--&gt;
imap_update_interval 1000
imap_use_ssl 0
imap_watched_folders INBOX--&gt;INBOX--&gt;
logger_format default
logger_level 0
logger_logdir ./
nntp_enabled 0
nntp_force_fork 1
nntp_headtoo 0
nntp_local 1
nntp_port 119
nntp_separator :
nntp_socks_port 1080
nntp_socks_server 
nntp_welcome_string NNTP POPFile (v1.1.3) server ready
pop3_enabled 0
pop3_force_fork 1
pop3_local 1
pop3_port 1110
pop3_secure_port 110
pop3_secure_server 
pop3_separator :
pop3_socks_port 1080
pop3_socks_server 
pop3_toptoo 0
pop3_welcome_string POP3 POPFile (v1.1.3) server ready
smtp_chain_port 25
smtp_chain_server 
smtp_enabled 0
smtp_force_fork 1
smtp_local 1
smtp_port 25
smtp_socks_port 1080
smtp_socks_server 
smtp_welcome_string SMTP POPFile (v1.1.3) welcome
xmlrpc_enabled 0
xmlrpc_local 1
xmlrpc_port 8081
</code></pre>

</div>

<p>
The only remaining issue is user name. If it contains "\", you should replace it with "\\" when inputting in Popfile!
</p>
</div>
</div>

<div id="outline-container-org7721e8b" class="outline-2">
<h3 id="org7721e8b">Run the program</h3>
<div class="outline-text-2" id="text-org7721e8b">
<p>
See <a href="http://getpopfile.org/docs/howtos:runlocation">http://getpopfile.org/docs/howtos:runlocation</a> for details.
</p>
<div class="org-src-container">

<pre><code class="lang-sh">cd ~/bin/popfile;perl popfile.pl
</code></pre>

</div>
</div>
</div>

<div id="outline-container-org01aea0d" class="outline-2">
<h3 id="org01aea0d">Start the POPFile automatically when bash login</h3>
<div class="outline-text-2" id="text-org01aea0d">
<p>
Insert below code in ~/.bashrc:
</p>
<div class="org-src-container">

<pre><code class="lang-sh">OS_NAME=`uname -s`
if [ $OS_NAME == Linux ]; then
   # start popfile
   if [ -f $HOME/bin/popfile/popfile.pl ]; then
      # @see http://getpopfile.org/docs/howtos:runlocation
      pop_pid=`ps -ef | grep perl | grep popfile.pl | gawk '{print $2}'`
      if [ "${pop_pid}" = "" ] ; then
         cd $HOME/bin/popfile
         perl popfile.pl &gt;&gt; /dev/null 2&gt;&amp;1 &amp;
      fi
      cd $HOME
   fi
fi
</code></pre>

</div>
</div>
</div>

<div id="outline-container-org447f91a" class="outline-2">
<h3 id="org447f91a">Start the POPFile systemd service as a user (OPTIONAL)</h3>
<div class="outline-text-2" id="text-org447f91a">
<p>
My user name is cb. Put popfile.service in <i>usr/lib/systemd/system</i>. Then run `systemctl enable popfile` to install service. Run `systemctl start popfile` to start the service. My Linux distribution is ArchLinux.
</p>

<p>
here is content of popfile.service.
</p>
<div class="org-src-container">

<pre><code class="lang-ini">[Unit]
Description=POPFile (Automatic Email Classification) Service

[Service]
WorkingDirectory=/home/cb/bin/popfile
ExecStart=/usr/bin/perl popfile.pl
User=cb

[Install]
WantedBy=multi-user.target
</code></pre>

</div>
</div>
</div>

<div id="outline-container-orgdfb9ac0" class="outline-2">
<h3 id="orgdfb9ac0">Backup</h3>
<div class="outline-text-2" id="text-orgdfb9ac0">
<p>
Please backup popfile.cfg and popfile.db.
</p>

<p>
See <a href="http://getpopfile.org/docs/howtos:backup">http://getpopfile.org/docs/howtos:backup</a> for details.
</p>
</div>
</div>

<div id="outline-container-orgbedc6d1" class="outline-2">
<h3 id="orgbedc6d1">Summary</h3>
<div class="outline-text-2" id="text-orgbedc6d1">
<ul class="org-ul">
<li>Portable</li>
<li>No root privilege needed</li>
<li>No X windows needed. I can manage mails in remote shell</li>
</ul>
</div>
</div>
</div>
            </div>
        </div>
        <div class="post">
            <h1 class="title"><a href="posts/emacs-lisp-bin-bu-nan-xue/">Emacs Lisp并不难学</a></h1>
            <div class="meta">
                <div class="authordate">
                    <time class="timeago" datetime="2012-11-29T21:00:00+00:00">2012-11-29 21:00</time>
</div>
                <div class="stats">
                    
        
    <a href="posts/emacs-lisp-bin-bu-nan-xue/#disqus_thread" data-disqus-identifier="cache/posts/emacs-lisp-bin-bu-nan-xue.html">Comments</a>


                </div>
            
        <div itemprop="keywords" class="tags">
        <ul>
        Tags : 
           <li><a class="tag p-category" href="categories/elisp/" rel="tag">elisp</a></li>
           <li><a class="tag p-category" href="categories/emacs/" rel="tag">emacs</a></li>
           <li><a class="tag p-category" href="categories/essential/" rel="tag">essential</a></li>
           <li><a class="tag p-category" href="categories/lisp/" rel="tag">lisp</a></li>
           <li><a class="tag p-category" href="categories/zh/" rel="tag">zh</a></li>
        </ul>
</div>

            </div>
            <div class="body">
                <div>
<p></p>
<p>作者:陈斌 (redguardtoo) </p> <p> 原创日期: <span class="timestamp-wrapper"> <span class="timestamp">2012-11-30 五</span></span> </p> <p> 本文的目的是把Lisp去神秘化. </p> <p> 我学的是Emacs Lisp(Emacs Lisp),开发环境也是Emacs.所以我举的例子都是只基于Elisp. </p> <p> 本文针对的读者是有相当经验的开发者,目的是尽可能简明扼要地突出重点. </p> <p> 我对于目前的主流开发语言都很熟悉,但是Lisp还只能算是入门水准,所以错过很多Lisp精彩之处是很可能的. </p> <p> 我所谓的重点,主要是指Lisp对于开发一个现实世界的产品有什么优点. </p>  <div id="outline-container-1" class="outline-3"> <h4 id="sec-1">所有的函数和数据可以在系统运行时改变</h4> <div class="outline-text-3" id="text-1">  <p>其意义是,假设你一个系统上线了,你可以随时改变正在运行的代码,不需要重启系统. </p> <p> 我的理解是,一个函数实际上就是带有字符串Key(该key就是函数名)的数据,运行某个函数就是在系统运行时根据Key找到对应的数据(或者代码,在Lips中是一回事)运行之. </p> <p> 例如,我可以在hook中申明某个函数将被调用,而这个函数的定义可以还不存在.系统在<em>运行时</em>才会去寻找这个函数.解释一下,hook可以认为是事件触发机制,就是在系统运行的某个时刻调用用户自定义的函数) </p> <p> 优点是灵活性很高.缺点是Lisp写的东西快不了. </p>
</div>  </div>  <div id="outline-container-2" class="outline-3"> <h4 id="sec-2">没有namespace,所有的函数默认都是可以全局访问的</h4> <div class="outline-text-3" id="text-2">  <p>正因为这两条,所以要多打字(每个函数都要手动输入名字前缀). </p> <p> 这点我完全可以接受,没有namespace就是多打点字而已.那些不了解历史或者没有用过C的初级程序员可能会大惊小怪.实际上没什么大不了的. </p> <p> 所有函数都可以访问在Emacs场景下有个巨大的优点,见下一条. </p>
</div>  </div>  <div id="outline-container-3" class="outline-3"> <h4 id="sec-3">defadivce可以改变系统中任意函数的行为.</h4> <div class="outline-text-3" id="text-3">  <p>defadvice可以重定义系统中的任意函数.原因如前文所说. </p>
</div>  </div>  <div id="outline-container-4" class="outline-3"> <h4 id="sec-4">循环语句和条件判断语句</h4> <div class="outline-text-3" id="text-4">  <p>和其他语言没什么不同,foreach之类的语法糖也不少. </p> <p> 我唯一不喜欢的是没有C中的return,break,和continue语句,这样的缺点是有可能让代码嵌套过深. </p> <p> 不过不是什么大不了的问题,Lisp也提供了一些替代语法. </p> <p> 另外其他所有语言提供了这些语法糖又怎么样呢,我遇到的超过50%的程序员还是一样瞎写. </p>
</div>  </div>  <div id="outline-container-5" class="outline-3"> <h4 id="sec-5">不同寻常的语法</h4> <div class="outline-text-3" id="text-5">  <p>Lisp语法是操作符号在前,被操作对象在后. </p> <p> 例如2+3+4,在Lisp的语法中是这样的: </p>   <pre class="src src-elisp">(+ 2 3 4)
</pre>   <p> 所有的语法都是这样的前缀表达式(<a href="http://zh.wikipedia.org/wiki/%E6%B3%A2%E5%85%B0%E8%A1%A8%E7%A4%BA%E6%B3%95">Polish Notation</a>),很多人不习惯这样的语法,但是它有一些突出优点: </p> <ol>
<li>这样的语法做语法解析特别容易,所以第三方支持工具很容易开发. 在大规模系统开发时,这点很有用.例如,分析大型项目的源代码时,你能唯一依靠的grep和正则表达式,ELisp简单严格的语法使得正则表达式很好写.  </li> <li>实际编程时少打很多运算符号,这对于有实战经验的程序员是巨大的优点.如果你和我说什么重要的是思想和设计模式,打字速度不重要,那么菜鸟请走开.  </li> <li>最重要的优点是,这种语法相当于一种过滤机制,能够接受这种语法的人通常都是头脑比较开放思维敏捷的人.说到底产品开发的决定性因素是人,所以这个能过滤人的优点是决定性的. </li> </ol>
</div>  </div>  <div id="outline-container-6" class="outline-3"> <h4 id="sec-6">函数可内嵌文档,且该文档可被Emacs帮助系统调用</h4> <div class="outline-text-3" id="text-6">  <p>现在能做到这点的系统也没几家.从细节我们可以看出Emacs和Elisp的完美之处. </p>
</div> </div> </div>
            </div>
        </div>
        <div class="post">
            <h1 class="title"><a href="posts/how-to-manage-and-use-tags-file-of-third-party-libraries-in-emacs/">How to use ctags with Emacs effectively</a></h1>
            <div class="meta">
                <div class="authordate">
                    <time class="timeago" datetime="2012-11-22T15:35:00+00:00">2012-11-22 15:35</time>
</div>
                <div class="stats">
                    
        
    <a href="posts/how-to-manage-and-use-tags-file-of-third-party-libraries-in-emacs/#disqus_thread" data-disqus-identifier="cache/posts/how-to-manage-and-use-tags-file-of-third-party-libraries-in-emacs.html">Comments</a>


                </div>
            
        <div itemprop="keywords" class="tags">
        <ul>
        Tags : 
           <li><a class="tag p-category" href="categories/ctags/" rel="tag">ctags</a></li>
           <li><a class="tag p-category" href="categories/emacs/" rel="tag">emacs</a></li>
           <li><a class="tag p-category" href="categories/en/" rel="tag">en</a></li>
        </ul>
</div>

            </div>
            <div class="body">
                <div>
<p>
<b>UPDATE</b> on <span class="timestamp-wrapper"><span class="timestamp">&lt;2018-02-24 Sat&gt;</span></span>:
I released <a href="https://github.com/redguardtoo/counsel-etags">counsel-etags</a>, a complete solution for Ctags/Emacs.
</p>

<p>
<b>ORIGINAL CONTENT</b>:
</p>

<p>
See <a href="http://emacswiki.org/emacs/EmacsTags">http://emacswiki.org/emacs/EmacsTags</a> for general usage of tags file. A file name of tags files is <code>TAGS</code> by default. But in Emacs manual the <code>tags file</code> is named <code>tags table</code>. Either <code>tags file</code> or <code>tags table</code> or <code>TAGS</code> is only different name for the same thing.
</p>

<p>
According wiki page, people usually use ctags to do two things,
</p>

<ul class="org-ul">
<li>Code navigation</li>
<li>Auto-complete/IntelliSense</li>
</ul>
<p>
In my opinion, ctags is OK for code navigation because it's integrated into Emacs well and ctags supports more programming language. But ctags only uses regular expression to analyze the code. So it's not as precise as professional tools like <a href="http://cscope.sourceforge.net/">cscope</a> or <a href="http://www.gnu.org/software/global">GNU Global</a>. According to my own experience, ctags plus grep is actually good enough for code navigation in big enterprise projects with mixed environments. If you are among a few talented geeks who are developing Linux Kernel in the most efficient way, you should use better tools like <a href="http://www.gnu.org/software/global">GNU Global</a>. See the head up from <a href="https://plus.google.com/113859563190964307534/posts/Ayr687eH451">Nick Alcock</a>. His summary of the Pro/Con of GNU Global is great.
</p>

<p>
IntelliSense is a different story. For programming languages like Javascript, ctags provide some IntelliSense with is better than nothing. C++ is a more complex language which is a litter harder for ctags to handle unless you are not using those "advanced" features of C++.
</p>

<p>
I found one missing piece from EmacsWiki is the tip on how to <b>manage tags file</b> easily when the TAGS is built from some code of third party libraries (<a href="http://http//en.wikipedia.org/wiki/Qt_(framework)">QT</a>, <a href="http://www.wxwidgets.org">wxWidgets</a>, <a href="http://www.gtk.org">GTK</a>, <a href="http://www.boost.org">Boost</a>, just name a few).
</p>

<p>
My typical work flow is:
</p>

<ul class="org-ul">
<li>Load the tags file for my own code.</li>
<li>Load other tags files built from third party libraries related to my current task.</li>
<li>Unload third party tags immediately if its not needed.</li>
</ul>
<p>
The purpose to load tags files is to look up API easily. For example, I use C++ library <a href="http://wxwidgets.org">wxWidgets</a> to develop my application. I want to use its API called <code>wxWindow::Maximize</code>. I type <code>M-x find-tag</code> and input the keyword <code>Maximize</code>. So I can check the function definition and know what parameters I need fill in to use "Maximize".
</p>

<p>
The reason to do the unload thing is to avoid function name conflict from some tags files. EmacsWiki has a section "Choosing Among Multiple Tags for the Same Name" to solve this problem. But unloading is more convenient. In theory, it would be annoying if I need repeat load and unload the same tags files. In reality, it seldom happens because if I need work on Javascript (so I unload C++ related TAGS), I will usually keep working on Javascript until the end of the day.
</p>

<div id="outline-container-orge69d0f5" class="outline-2">
<h3 id="orge69d0f5">Produce tags files for all the environments</h3>
<div class="outline-text-2" id="text-orge69d0f5">
<p>
For example, I produce tags files of Library A for Mac and Linux. I put tags file from Mac at directory "/home/cb/tags/Library_A/mac" and file from Linux at <code>/home/cb/tags/Library_A/linux</code>.
</p>
</div>
</div>

<div id="outline-container-orgd4322bf" class="outline-2">
<h3 id="orgd4322bf">Use git and github to manage the tags files</h3>
<div class="outline-text-2" id="text-orgd4322bf">
<p>
So I can have copies of the tags files at github server and my local computers. That's also a part of my strategy to setup the development environment. My projects on different computers usually use same external library.
</p>

<p>
EmacsWiki discusses how to update your tags file frequently because your own code are updated frequently. But the tags file from a big library like wxWidgets need not be updated to often because I only use limited old APIs in that library.
</p>
</div>
</div>

<div id="outline-container-org3d43f15" class="outline-2">
<h3 id="org3d43f15">Write emacs lisp code to load/unload these tags files</h3>
<div class="outline-text-2" id="text-org3d43f15">
<p>
Here is the code. In this example, if I need load tags file for <a href="http://www.wxwidgets.org">wxWidgets</a>, I call the function "add-wx-tags". If I need unload the tags file, I press "Ctrl-u" and call the same function "add-wx-tags". Since I use <a href="http://www.emacswiki.org/Smex">Smex</a>, calling function doesn't mean pressing many keys.
</p>
<div class="org-src-container">

<pre><code class="lang-lisp">; Set up tags built from third party libraries ===begin
; define tags alias like "wx-tags" here
(setq wx-tags (expand-file-name "~/tags/wx/osx/TAGS"))

; @see &lt;Selecting a Tags Table&gt; in Emacs manual for details.
; We only change the list "tags-table-list". It is documented officialy.
(defun insert-into-tags-table-list(e)
  (add-to-list 'tags-table-list e t))
(defun delete-from-tags-table-list (e)
  (setq tags-table-list (delete e tags-table-list)))
; This is a sample command, all you need is copy/paste this template
; for other new commands
(defun add-wx-tags (&amp;optional del)
  "Add or delete(C-u) wxWidgets tags into tags-table-list"
  (interactive "P")
  (let (mytags)
    ; here add your third party tags files
    ; Usually you need load/unload tags files combination in one command
    ; change below line to add them
    (setq mytags (list wx-tags))
    (if del (mapc 'delete-from-tags-table-list mytags)
      (mapc 'insert-into-tags-table-list mytags))))
</code></pre>

</div>

<p>
This solution only uses one standard variable <code>tags-table-list</code> in Emacs. So it will always work with any other Emacs plugins you install. And you can use all the old hotkeys and functions ("find-tag", for example) without any problem.
</p>

<p>
See <a href="http://www.gnu.org/software/emacs/manual/html_node/emacs/Select-Tags-Table.html">Emacs manual</a> for technical details.
</p>
</div>
</div>
</div>
            </div>
        </div>
        <div class="post">
            <h1 class="title"><a href="posts/my-personal-emacs-customization-customel/">My personal emacs customization (custom.el)</a></h1>
            <div class="meta">
                <div class="authordate">
                    <time class="timeago" datetime="2012-11-16T12:10:02+00:00">2012-11-16 12:10</time>
</div>
                <div class="stats">
                    
        
    <a href="posts/my-personal-emacs-customization-customel/#disqus_thread" data-disqus-identifier="cache/posts/my-personal-emacs-customization-customel.html">Comments</a>


                </div>
            
        <div itemprop="keywords" class="tags">
        <ul>
        Tags : 
           <li><a class="tag p-category" href="categories/emacs/" rel="tag">emacs</a></li>
           <li><a class="tag p-category" href="categories/en/" rel="tag">en</a></li>
           <li><a class="tag p-category" href="categories/personal/" rel="tag">personal</a></li>
        </ul>
</div>

            </div>
            <div class="body">
                <div>
<p>
custom.el is my personal emacs configuration. I use it with my publicized <a href="https://github.com/redguardtoo/emacs.d">Emacs configuration</a>.
</p>

<div class="org-src-container">

<pre><code class="lang-lisp">;; I'm in Australia now
;; I'm in Australia now
(setq system-time-locale "C")

;; {{ stardict
(setq sdcv-dictionary-simple-list '("朗道英汉字典5.0"))
(setq sdcv-dictionary-complete-list '("WordNet"))
;; }}

;; {{ elpa-mirror
(setq elpamr-default-output-directory "~/myelpa")
(setq elpamr-repository-name "myelpa")
(setq elpamr-repository-path "https://dl.dropboxusercontent.com/u/858862/myelpa/")
(setq elpamr-email "myname@mydomain.com")
;; }}

;; lock my package
(if (file-readable-p (expand-file-name "~/Dropbox/Public/myelpa/archive-contents"))
     (setq package-archives '(("myelpa" . "~/Dropbox/Public/myelpa/"))))

;; {{ Set up third party tags
(defun insert-into-tags-table-list(e)
  (add-to-list 'tags-table-list e t)
  )
(defun delete-from-tags-table-list (e)
  (setq tags-table-list (delete e tags-table-list))
  )

(defun add-wx-tags (&amp;optional del)
  "Add or delete(C-u) wxWidgets tags into tags-table-list"
  (interactive "P")
  (let (mytags)
    ; here add your third party tags
    (setq mytags (list "~/tags/wx/osx/TAGS"))
    (if del (mapc 'delete-from-tags-table-list mytags)
      (mapc 'insert-into-tags-table-list mytags)
      )
    )
  )
;; }}

;; (getenv "HOSTNAME") won't work because $HOSTNAME is not an env variable
;; (system-name) won't work because as Optus required, my /etc/hosts is changed
(defun my/at-office ()
  (interactive)
  (let ((my-hostname (with-temp-buffer
                       (shell-command "hostname" t)
                       (goto-char (point-max))
                       (delete-char -1)
                       (buffer-string))
                     ))
    (and (string= my-hostname "my-sydney-workpc")
         (not (or (string= my-hostname "sydneypc")
                  (string= my-hostname "ChenBinMacAir")
                  (string= my-hostname "eee")
                  )))
    ))

(defun my/use-office-style ()
  (interactive)
  (let ((dir (if (buffer-file-name)
                 (file-name-directory (buffer-file-name))
               "")))
    (string-match-p "CompanyProject" dir)
    ))

(defun my/setup-develop-environment ()
  (cond
   ((my/use-office-style)
    (message "Office code style!")
    (setq coffee-tab-width 4)
    (setq javascript-indent-level 4)
    (setq js-indent-level 4)
    (setq js2-basic-offset 4)
    (setq web-mode-indent-style 4))
   (t
    (message "My code style!")
    (setq coffee-tab-width 4)
    (setq javascript-indent-level 2)
    (setq js-indent-level 2)
    (setq js2-basic-offset 2)
    (setq web-mode-indent-style 2))
   ))

(add-hook 'js2-mode-hook 'my/setup-develop-environment)
(add-hook 'web-mode-hook 'my/setup-develop-environment)

(my/setup-develop-environment)

;; {{ gnus setup
(require 'nnir)

;; ask encyption password once
(setq epa-file-cache-passphrase-for-symmetric-encryption t)


;;@see http://www.emacswiki.org/emacs/GnusGmail#toc1
;; (add-to-list 'gnus-secondary-select-methods '(nntp "news.gmane.org"))
;; (add-to-list 'gnus-secondary-select-methods '(nntp "news.gwene.org"))
(if (my/at-office)
    (add-to-list 'gnus-secondary-select-methods '(nnml "optus"))
    (setq mail-sources
      '((pop :server "localhost"
         :port 1110
         :user "CP111111"
         :password "MyPassword"
         :stream network)))
    )


(setq gnus-select-method
             '(nnimap "gmail"
                      (nnimap-address "imap.gmail.com")
                      (nnimap-server-port 993)
                      (nnimap-stream ssl)
                      (nnir-search-engine imap)
                      (nnimap-authinfo-file "~/.authinfo.gpg")
                      ; @see http://www.gnu.org/software/emacs/manual/html_node/gnus/Expiring-Mail.html
                      ;; press 'E' to expire email
                      (nnmail-expiry-target "nnimap+gmail:[Gmail]/Trash")
                      (nnmail-expiry-wait 90)
                      ))

;;@see http://gnus.org/manual/gnus_397.html
;; (add-to-list 'gnus-secondary-select-methods
;;              )

(setq-default
  gnus-summary-line-format "%U%R%z %(%&amp;user-date;  %-15,15f  %B%s%)\n"
  gnus-user-date-format-alist '((t . "%Y-%m-%d %H:%M"))
  gnus-summary-thread-gathering-function 'gnus-gather-threads-by-references
  gnus-sum-thread-tree-false-root ""
  gnus-sum-thread-tree-indent ""
  gnus-sum-thread-tree-leaf-with-other "-&gt; "
  gnus-sum-thread-tree-root ""
  gnus-sum-thread-tree-single-leaf "|_ "
  gnus-sum-thread-tree-vertical "|")
(setq gnus-thread-sort-functions
      '(
        (not gnus-thread-sort-by-date)
        (not gnus-thread-sort-by-number)
        ))

;; we want to browse freely from gwene (RSS)
(setq gnus-safe-html-newsgroups "\\`nntp[+:]news\\.gwene\\.org[+:]")

; NO 'passive
(setq gnus-use-cache t)
(setq gnus-use-adaptive-scoring t)
(setq gnus-save-score t)
(add-hook 'mail-citation-hook 'sc-cite-original)
(add-hook 'message-sent-hook 'gnus-score-followup-article)
(add-hook 'message-sent-hook 'gnus-score-followup-thread)
; @see http://stackoverflow.com/questions/945419/how-dont-use-gnus-adaptive-scoring-in-some-newsgroups
(setq gnus-parameters
      '(("nnimap.*"
         (gnus-use-scoring nil)) ;scoring is annoying when I check latest email
        ))

(defvar gnus-default-adaptive-score-alist
  '((gnus-kill-file-mark (from -10))
    (gnus-unread-mark)
    (gnus-read-mark (from 10) (subject 30))
    (gnus-catchup-mark (subject -10))
    (gnus-killed-mark (from -1) (subject -30))
    (gnus-del-mark (from -2) (subject -15))
    (gnus-ticked-mark (from 10))
    (gnus-dormant-mark (from 5))))

;; Fetch only part of the article if we can.  I saw this in someone
;; else's .gnus
(setq gnus-read-active-file 'some)

;; Tree view for groups.  I like the organisational feel this has.
(add-hook 'gnus-group-mode-hook 'gnus-topic-mode)

;; Threads!  I hate reading un-threaded email -- especially mailing
;; lists.  This helps a ton!
(setq gnus-summary-thread-gathering-function
      'gnus-gather-threads-by-subject)

;; Also, I prefer to see only the top level message.  If a message has
;; several replies or is part of a thread, only show the first
;; message.  'gnus-thread-ignore-subject' will ignore the subject and
;; look at 'In-Reply-To:' and 'References:' headers.
(setq gnus-thread-hide-subtree t)
(setq gnus-thread-ignore-subject t)

; Personal Information
(setq user-full-name "My Name"
      user-mail-address (if (my/at-office) "myname@office.com" "myname@mydomain.com")
      )

;; Change email address for work folder.  This is one of the most
;; interesting features of Gnus.  I plan on adding custom .sigs soon
;; for different mailing lists.
;; Usage, FROM: chen bin &lt;work&gt;
(setq gnus-posting-styles
      '((".*"
         (name "My Name"
          (address "myname@mydomain.com"
                   (organization "")
                   (signature-file "~/.signature")
                   ("X-Troll" "Emacs is better than Vi")
                   )))))


(setq mm-text-html-renderer 'w3m)

;; http://www.gnu.org/software/emacs/manual/html_node/gnus/_005b9_002e2_005d.html
(setq gnus-use-correct-string-widths nil)
;; @see http://emacs.1067599.n5.nabble.com/gnus-compile-td221680.html
;;(gnus-compile)
; =Gnus Tips=
;; @see http://www.scottmcpeak.com/gnus.html
;; }}
</code></pre>

</div>
</div>
            </div>
        </div>
        <div class="post">
            <h1 class="title"><a href="posts/how-to-use-ftp-in-emacs/">How to use FTP in Emacs</a></h1>
            <div class="meta">
                <div class="authordate">
                    <time class="timeago" datetime="2012-11-11T13:05:00+00:00">2012-11-11 13:05</time>
</div>
                <div class="stats">
                    
        
    <a href="posts/how-to-use-ftp-in-emacs/#disqus_thread" data-disqus-identifier="cache/posts/how-to-use-ftp-in-emacs.html">Comments</a>


                </div>
            
        <div itemprop="keywords" class="tags">
        <ul>
        Tags : 
           <li><a class="tag p-category" href="categories/emacs/" rel="tag">emacs</a></li>
           <li><a class="tag p-category" href="categories/en/" rel="tag">en</a></li>
           <li><a class="tag p-category" href="categories/ftp/" rel="tag">ftp</a></li>
           <li><a class="tag p-category" href="categories/linux/" rel="tag">linux</a></li>
           <li><a class="tag p-category" href="categories/mac/" rel="tag">mac</a></li>
           <li><a class="tag p-category" href="categories/mount/" rel="tag">mount</a></li>
        </ul>
</div>

            </div>
            <div class="body">
                <div>
<p></p>
<p>Emacs's default <a href="http://www.emacswiki.org/AngeFtp">Ftp client</a> is a little outdated compared to other modern Ftp clients. </p> <p> What I want is a two panel file explorer with ftp client integrated (An excellent example is <a href="http://www.ghisler.com">Total Commander</a> on windows). </p> <p> In Emacs, I've got <a href="http://emacswiki.org/emacs/Sunrise_Commander">Sunrise Commander</a> which is close to Total Commander, but NO Ftp integration. </p> <p> I dig around the internet for a while and find that the perfect solution is mount the ftp server into my local file system with <a href="http://curlftpfs.sourceforge.net">CurlFtpFS</a>. </p> <p> The best part of this solution is CurlFtpFS supports both OS X and Linux. </p> <p> In order to install CurlFtpFS on OS X, you need use the package manager <a href="http://mxcl.github.com/homebrew/">Homebrew</a>. The only catch I met on OS X is that I need upgrade Fuse4X driver manually for some wired reason to avoid "incompatible with the kernel version" error. Upgrading is simple. Download dmg plus mouse click stuff only. See <a href="http://fuse4x.github.com/faq.html">FAQ</a> for details. </p> <p> For the usage of CurlFtpFS, see <a href="https://wiki.archlinux.org/index.php/Mount_FTP">HERE</a> for documentation. It's for Linux. But totally fine for OS X users. </p>
</div>
            </div>
        </div>
        <div class="post">
            <h1 class="title"><a href="posts/notes-on-using-gnus/">Practical guide to use Gnus with Gmail</a></h1>
            <div class="meta">
                <div class="authordate">
                    <time class="timeago" datetime="2012-10-12T17:14:00+00:00">2012-10-12 17:14</time>
</div>
                <div class="stats">
                    
        
    <a href="posts/notes-on-using-gnus/#disqus_thread" data-disqus-identifier="cache/posts/notes-on-using-gnus.html">Comments</a>


                </div>
            
        <div itemprop="keywords" class="tags">
        <ul>
        Tags : 
           <li><a class="tag p-category" href="categories/emacs/" rel="tag">emacs</a></li>
           <li><a class="tag p-category" href="categories/email/" rel="tag">email</a></li>
           <li><a class="tag p-category" href="categories/gmail/" rel="tag">gmail</a></li>
           <li><a class="tag p-category" href="categories/gnus/" rel="tag">gnus</a></li>
        </ul>
</div>

            </div>
            <div class="body">
                <p>
The article is moved to <a href="https://github.com/redguardtoo/mastering-emacs-in-one-year-guide/blob/master/gnus-guide-en.org">GitHub</a>.</p>
            </div>
        </div>
        <div class="post">
            <h1 class="title"><a href="posts/the-latest-version-of-yasnippet-is-not-compatible-with-auto-complete-enemacsyasnippetauto-complete/">The latest version of yasnippet is NOT compatible with auto-complete</a></h1>
            <div class="meta">
                <div class="authordate">
                    <time class="timeago" datetime="2012-09-28T20:54:00+00:00">2012-09-28 20:54</time>
</div>
                <div class="stats">
                    
        
    <a href="posts/the-latest-version-of-yasnippet-is-not-compatible-with-auto-complete-enemacsyasnippetauto-complete/#disqus_thread" data-disqus-identifier="cache/posts/the-latest-version-of-yasnippet-is-not-compatible-with-auto-complete-enemacsyasnippetauto-complete.html">Comments</a>


                </div>
            
        <div itemprop="keywords" class="tags">
        <ul>
        Tags : 
           <li><a class="tag p-category" href="categories/auto/" rel="tag">auto</a></li>
           <li><a class="tag p-category" href="categories/complete/" rel="tag">complete</a></li>
           <li><a class="tag p-category" href="categories/emacs/" rel="tag">emacs</a></li>
           <li><a class="tag p-category" href="categories/en/" rel="tag">en</a></li>
           <li><a class="tag p-category" href="categories/yasnippet/" rel="tag">yasnippet</a></li>
        </ul>
</div>

            </div>
            <div class="body">
                <div>
<p></p>
<p>Yes. The latest yasnippet (yasnippet-20120822.52) changed too many APIs and I cannot figure out how to work around it. Upgrading to the latest auto-complete (auto-complete-20120922.1815) won't solve the problem. </p> <p> See <a href="https://github.com/capitaomorte/yasnippet/issues/311">https://github.com/capitaomorte/yasnippet/issues/311</a> for the details. </p> <p> So here is the fix. You can use older version of yasnippet (yasnippet-20120718) and wait until the issue is fixed. </p> <p> Here is the link of older version, <a href="http://dl.dropbox.com/u/858862/yasnippet-20120718.tar.gz">http://dl.dropbox.com/u/858862/yasnippet-20120718.tar.gz</a>. </p>
</div>
            </div>
        </div>
        <div class="post">
            <h1 class="title"><a href="posts/why-facebook-app-for-android-pad-sucks/">Why Facebook app for android pad sucks?</a></h1>
            <div class="meta">
                <div class="authordate">
                    <time class="timeago" datetime="2012-09-28T19:50:00+00:00">2012-09-28 19:50</time>
</div>
                <div class="stats">
                    
        
    <a href="posts/why-facebook-app-for-android-pad-sucks/#disqus_thread" data-disqus-identifier="cache/posts/why-facebook-app-for-android-pad-sucks.html">Comments</a>


                </div>
            
        <div itemprop="keywords" class="tags">
        <ul>
        Tags : 
           <li><a class="tag p-category" href="categories/android/" rel="tag">android</a></li>
           <li><a class="tag p-category" href="categories/emacs/" rel="tag">emacs</a></li>
           <li><a class="tag p-category" href="categories/en/" rel="tag">en</a></li>
           <li><a class="tag p-category" href="categories/facebook/" rel="tag">facebook</a></li>
        </ul>
</div>

            </div>
            <div class="body">
                <div>
<p></p>
<p>I don't use facebook. I just record my roommates' complaining. </p> <p> Here are his points, </p>
<dl>
<dt>failed to take full advantage of big screen of android pad</dt>
<dd>The right blank margin could be used to display comments instead, as some application has done. </dd> <dt>scroll down/up to view the images sucks</dt>
<dd>Slow and hard to locate the exact item he wants. </dd> <dt>Performance may be not good enough</dt>
<dd>Especially when viewing the images, it's not as fluent as other applications. </dd> </dl>
</div>
            </div>
        </div>
        <div class="post">
            <h1 class="title"><a href="posts/python-code-to-migrate-the-mysql-database-enmysqldatabasepython/">python code to migrate the MySQL database</a></h1>
            <div class="meta">
                <div class="authordate">
                    <time class="timeago" datetime="2012-08-22T12:08:00+00:00">2012-08-22 12:08</time>
</div>
                <div class="stats">
                    
        
    <a href="posts/python-code-to-migrate-the-mysql-database-enmysqldatabasepython/#disqus_thread" data-disqus-identifier="cache/posts/python-code-to-migrate-the-mysql-database-enmysqldatabasepython.html">Comments</a>


                </div>
            
        <div itemprop="keywords" class="tags">
        <ul>
        Tags : 
           <li><a class="tag p-category" href="categories/database/" rel="tag">database</a></li>
           <li><a class="tag p-category" href="categories/en/" rel="tag">en</a></li>
           <li><a class="tag p-category" href="categories/mysql/" rel="tag">mysql</a></li>
           <li><a class="tag p-category" href="categories/python/" rel="tag">python</a></li>
        </ul>
</div>

            </div>
            <div class="body">
                <div>
<p>
The script reads configuration and requires python 2.4.
</p>

<div class="org-src-container">

<pre><code class="lang-python">#!/usr/bin/python
import sys
import os
import string
import time
import datetime
import getopt

#############
# CONFIG
#############
DB_NAME='mydb'
DB_PASSWORD='111111'
DB_USER='root'
DB_HOST='mylinux0'
SQL_DB_SCHEMA=os.path.abspath("db_schema.sql")
SQL_CREATE_TABLE=os.path.abspath("000.sql")
CLONE_TABLES=['MyJobs','MyUsers']

#############
# GLOBALS
#############
backup_db=False
migration=False
config=None
verbose=False
delete=False
remote=False

def sql_cmd(cmd):
    if remote:
        return 'mysql -h %s -u %s -p%s -e " %s " %s' % (DB_HOST,DB_USER,DB_PASSWORD,cmd,DB_NAME)
    return 'mysql -u %s -p%s -e " %s " %s' % (DB_USER,DB_PASSWORD,cmd,DB_NAME)

def sql_script(script):
    if remote:
        return 'mysql -h %s -u %s -p%s %s &lt; %s' % (DB_HOST,DB_USER,DB_PASSWORD,DB_NAME,script)
    return 'mysql -u %s -p%s %s &lt; %s' % (DB_USER,DB_PASSWORD,DB_NAME,script)


def make_sql_to_create_table():
    s=open(SQL_DB_SCHEMA).read()
    for t in CLONE_TABLES:
        s=s.replace(t,t+'2')
    open(SQL_CREATE_TABLE,'w').write(s)

def backup_database():
    fname="%s-%s.dump.gz" % (DB_NAME,time.strftime('%Y%m%d%H%M%S', time.gmtime()))
    if remote:
        cmd="mysqldump -h %s -u %s -p%s --compact %s|gzip -9 &gt; %s" % (DB_HOST,DB_USER,DB_PASSWORD,DB_NAME,fname)
    else:
        cmd="mysqldump -u %s -p%s --compact %s|gzip -9 &gt; %s" % (DB_USER,DB_PASSWORD,DB_NAME,fname)

    print "==WILL RUN [ %s ]" % (cmd)
    os.system(cmd)
    print "==DONE"

def delete_db_records():
    cmd=sql_cmd("delete from sources;delete from cameras;")
    print "==WILL RUN [ %s ]" % (cmd)
    os.system(cmd)
    print "==DONE"

def package():
    cmd="tar zcvf migrate-db.tar.gz *.sql migrate.py .migrate_*"
    print "==WILL RUN [ %s ]" % (cmd)
    os.system(cmd)
    print "==DONE"

def read_config(config):
    global DB_NAME
    global DB_PASSWORD
    global DB_USER
    global DB_HOST
    f=open(config,"r")
    for line in f:
        a=line.split("=")
        if len(a)!=2:
            continue
        n=a[0].strip()
        v=a[1].strip()
        if n=="DB_NAME":
            DB_NAME=v
        elif n=="DB_PASSWORD":
            DB_PASSWORD=v
        elif n=="DB_USER":
            DB_USER=v
        elif n=="DB_HOST":
            DB_HOST=v

def usage():
    print '''
USAGE: python migrate.py [OPTIONS]

OPTIONS:
    -h, --help
        print this help

    -b, --backup-database
        backup the old database before migration (recommended)

    -m, --migrate
        donot start migration

    -v, --verbose
        print database related information

    -p, --package
        packge all the scripts into migrate-db.tar.gz

    -d, --delete-db-records
        delete database records so we can restart migration

    -c, --config

SAMPLES:
    python migrate.py -b                        #back database and exit
    python migrate.py -m                        #start migration right now
    python migrate.py -b -m                     #backup the database and start the migration (recommended)
    python migrate.py -v                        #print database information and exit
    python migrate.py -c .migrate_staging -v    #print staging database information and exit
'''

def show_info():
    print '''
==Database Information
name:{name}
password:{password}
user:{user}
host:{host}
'''.format(name=DB_NAME, password=DB_PASSWORD,user=DB_USER,host=DB_HOST)

def confirm(prompt=None, resp=False):
    """prompts for yes or no response from the user. Returns True for yes and
    False for no.

    'resp' should be set to the default value assumed by the caller when
    user simply types ENTER.

    &gt;&gt;&gt; confirm(prompt='Create Directory?', resp=True)
    Create Directory? [y]|n:
    True
    &gt;&gt;&gt; confirm(prompt='Create Directory?', resp=False)
    Create Directory? [n]|y:
    False
    &gt;&gt;&gt; confirm(prompt='Create Directory?', resp=False)
    Create Directory? [n]|y: y
    True

    """

    if prompt is None:
        prompt = 'WARNING: DONOT run me twice and migration CANNOT be rolled back, GO?'

    if resp:
        prompt = '%s [%s]|%s: ' % (prompt, 'y', 'n')
    else:
        prompt = '%s [%s]|%s: ' % (prompt, 'n', 'y')

    while True:
        ans = raw_input(prompt)
        if not ans:
            return resp
        if ans not in ['y', 'Y', 'n', 'N']:
            print 'please enter y or n.'
            continue
        if ans == 'y' or ans == 'Y':
            return True
        if ans == 'n' or ans == 'N':
            return False

if __name__=="__main__":
    '''
    @see http://linux.byexamples.com/archives/366/python-how-to-run-a-command-line-within-python/
    '''
    try:
        opts, args = getopt.getopt(sys.argv[1:], "hbmvpdc:r", ["help", "backup-database","--migrate","--verbose","--package","--delete-db-records","--config=","--remote"])
    except getopt.GetoptError, err:
        print str(err) # will print something like "option -a not recognized"
        usage()
        exit(2)

    if len(opts)==0:
        usage()
        exit(2)

    for o, a in opts:
        if o in ("-h", "--help"):
            usage()
            sys.exit()
        elif o in ("-v", "--verbose"):
            verbose=True
        elif o in ("-c", "--config"):
            config=a
            print config
        elif o in ("-d", "--delete-db-records"):
            delete=True
        elif o in ("-p", "--package"):
            package()
            exit(0)
        elif o in ("-b", "--backup-database"):
            backup_db=True
        elif o in ("-m", "--migrate"):
            migration=True
        elif o in ("-r", "--remote"):
            remote=True
        else:
            assert False, "unhandled option"

    if config!=None:
        read_config(config)

    if delete:
        delete_db_records()
        sys.exit()

    if verbose:
        show_info()
        sys.exit()

    if backup_db:
        backup_database()

    if migration==False:
        exit(0)

    if confirm()==False:
        print "Aborting ..."
        exit(0)

    make_sql_to_create_table()

    print "==START MIGRATION"

    # test data base connection
    cmd=sql_cmd('show databases;use %s;' % (DB_NAME))
    print "==WILL RUN [ %s ]" % (cmd)
    os.system(cmd)
    print "==DONE"

    cmd=sql_script("000.sql")
    print "==WILL RUN [ %s ]" % (cmd)
    os.system(cmd)
    print "==DONE"

    os.system(sql_cmd("insert into migrate (Action) values ('001.sql')"))
    cmd=sql_script("001.sql")
    print "==WILL RUN [ %s ]" % (cmd)
    os.system(cmd)
    print "==DONE"

    os.system(sql_cmd("insert into migrate (Action) values ('002.sql')"))
    cmd=sql_script("002.sql")
    print "==WILL RUN [ %s ]" % (cmd)
    os.system(cmd)
    print "==DONE"

    os.system(sql_cmd("insert into migrate (Action) values ('003.sql')"))
    cmd=sql_script("003.sql")
    print "==WILL RUN [ %s ]" % (cmd)
    os.system(cmd)
    print "==DONE"

    os.system(sql_cmd("insert into migrate (Action) values ('004.sql')"))
    cmd=sql_script("004.sql")
    print "==WILL RUN [ %s ]" % (cmd)
    os.system(cmd)
    print "==DONE"

    os.system(sql_cmd("insert into migrate (Action) values ('005.sql')"))
    cmd=sql_script("005.sql")
    print "==WILL RUN [ %s ]" % (cmd)
    os.system(cmd)
    print "==DONE"

    os.system(sql_cmd("insert into migrate (Action) values ('006.sql')"))
    cmd=sql_script("006.sql")
    print "==WILL RUN [ %s ]" % (cmd)
    os.system(cmd)
    print "==DONE"

    os.system(sql_cmd("insert into migrate (Action) values ('100.sql')"))
    cmd=sql_script("100.sql")
    print "==WILL RUN [ %s ]" % (cmd)
    os.system(cmd)
    print "==DONE"

    cmd=sql_script("insert_sample_sources.sql")
    print "==WILL RUN [ %s ]" % (cmd)
    os.system(cmd)
    print "==DONE"

    cmd=sql_script("app_config.sql")
    print "==WILL RUN [ %s ]" % (cmd)
    os.system(cmd)
    print "==DONE"

    print "==END MIGRATION"
# vim: set expandtab tabstop=4 shiftwidth=4:
</code></pre>

</div>
</div>
            </div>
        </div>
    
        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-7.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-5.html" rel="next">Older posts</a>
            </li>
        </ul></nav><script>var disqus_shortname="chenbin0";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script><footer id="footer"><p>Contents © 2020         <a href="mailto:chenbin.sh@gmail.com">Chen Bin</a> - Powered by         <a href="http://getnikola.com" rel="nofollow">Nikola</a>         </p>
            
        </footer>
</div>
    </section><script src="assets/js/all-nocdn.js" type="text/javascript"></script><script type="text/javascript">
         document.addEventListener('DOMContentLoaded', function() {
           var items = document.getElementsByClassName('timeago'), e, pd;
           for (var i = 0; i < items.length; i++) {
             e = items[i];
             pd = moment(new Date(e.getAttribute('datetime')));
             e.innerHTML = pd.fromNow();
             e.setAttribute('title', pd.format('LLLL'));
           }
         });
        </script>
</body>
</html>
