<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="Linux, Programming, Emacs">
<meta name="viewport" content="width=device-width">
<title>Chen's blog | Chen's blog</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link rel="alternate" type="application/rss+xml" title="RSS" href="rss.xml">
<link rel="canonical" href="http://blog.binchen.org/">
<!--[if lt IE 9]><script src="/assets/js/html5.js"></script><![endif]-->
</head>
<body>
    <section class="social"><ul>
<li><a href="#" title="Home"><i class="icon-home"></i></a></li>
            <li><a href="archive.html" title="Archives"><i class="icon-folder-open-alt"></i></a></li>
            <li><a href="categories/index.html" title="Tags"><i class="icon-tags"></i></a></li>
            <li><a href="rss.xml" title="RSS"><i class="icon-rss"></i></a></li>
            <li><a href="stories/about.html" title="About me"><i class="icon-user"></i></a></li>
            <li><a href="https://twitter.com/chen_bin" title="My Twitter"><i class="icon-twitter"></i></a></li>
            <li><a href="https://github.com/redguardtoo" title="My Github"><i class="icon-github"></i></a></li>

        </ul></section><section class="page-content"><div class="content" rel="main">
            
        <div class="post">
            <h1 class="title"><a href="posts/suan-tai-chao-dan/">蒜苔炒蛋</a></h1>
            <div class="meta">
                <div class="authordate">
                    <time class="timeago" datetime="2021-10-15T12:24:19+00:00">2021-10-15 12:24</time>
</div>
                <div class="stats">
                    
        
    <a href="posts/suan-tai-chao-dan/#disqus_thread" data-disqus-identifier="cache/posts/suan-tai-chao-dan.html">Comments</a>


                </div>
            
        <div itemprop="keywords" class="tags">
        <ul>
        Tags : 
           <li><a class="tag p-category" href="categories/cuisine/" rel="tag">cuisine</a></li>
           <li><a class="tag p-category" href="categories/egg/" rel="tag">egg</a></li>
           <li><a class="tag p-category" href="categories/zh/" rel="tag">zh</a></li>
        </ul>
</div>

            </div>
            <div class="body">
                <div>
<p>
视频教程见<a href="https://www.youtube.com/watch?v=9N8A1AvrxJ0">老東北美食: 只要多做一步，蒜苔又嫩又入味</a>
</p>

<p>
要点,
</p>
<ul class="org-ul">
<li>蒜苔老的头掐掉, 开水焯一下后放入冷水,从中间撕成两半,切成四公分的段.</li>
<li>滚刀切葱段备用</li>
<li>炒蛋核桃块大小, 三分盐</li>
<li>油热后加葱和少许海鲜酱油.炒几下后加入蒜苔加盐花椒油翻炒</li>
<li>加蛋翻炒几下,略勾芡</li>
</ul>
<p>
注:
没有花椒油,所以我在油温较高时和葱段一起加入少许花椒粒,利用油温爆出花椒香味.
</p>

<div class="figure">
<p><img src="posts/suan-tai-chao-dan/image/suantai-egg.jpg" alt="suantai-egg.jpg"></p>
</div>
</div>
            </div>
        </div>
        <div class="post">
            <h1 class="title"><a href="posts/ma-po-dou-fu/">麻婆豆腐</a></h1>
            <div class="meta">
                <div class="authordate">
                    <time class="timeago" datetime="2021-10-13T08:10:31+00:00">2021-10-13 08:10</time>
</div>
                <div class="stats">
                    
        
    <a href="posts/ma-po-dou-fu/#disqus_thread" data-disqus-identifier="cache/posts/ma-po-dou-fu.html">Comments</a>


                </div>
            
        <div itemprop="keywords" class="tags">
        <ul>
        Tags : 
           <li><a class="tag p-category" href="categories/cuisine/" rel="tag">cuisine</a></li>
           <li><a class="tag p-category" href="categories/toufu/" rel="tag">toufu</a></li>
           <li><a class="tag p-category" href="categories/zh/" rel="tag">zh</a></li>
        </ul>
</div>

            </div>
            <div class="body">
                <div>
<p>
视频教程见<a href="https://www.youtube.com/watch?v=vm3jVXajBi8">大师的菜 麻婆豆腐</a>.
</p>

<p>
要点,
</p>
<ul class="org-ul">
<li>豆腐要嫩, 过开水去豆腥味, 加盐提味,一点酱油提色</li>
<li>牛肉末炒酥取出</li>
<li>加豆瓣酱,豆豉,辣椒面等.不能加姜,会压住其他味.炒到发香.加肉末,加高汤</li>
<li>汤最多到豆腐的50%</li>
<li>用炒勺的背面推豆腐保持豆腐完整</li>
<li>三次勾芡(第一次让味进入豆腐,第二次起到拉力作用,第三次彻底粘合,不要吐水出来)</li>
<li>最后用小火甚至微火,多烧一下才入味(要不断推豆腐,否则豆腐沾锅底)</li>
<li>起锅前加入蒜苗, 少许花椒粒烤热后磨成粉撒入</li>
</ul>
<div class="figure">
<p><img src="wp-content/mapotofu.jpg" alt="mapotofu.jpg"></p>
</div>
</div>
            </div>
        </div>
        <div class="post">
            <h1 class="title"><a href="posts/set-up-vmtouch-systemd-service/">Set up vmtouch systemd service</a></h1>
            <div class="meta">
                <div class="authordate">
                    <time class="timeago" datetime="2021-06-26T04:46:41+00:00">2021-06-26 04:46</time>
</div>
                <div class="stats">
                    
        
    <a href="posts/set-up-vmtouch-systemd-service/#disqus_thread" data-disqus-identifier="cache/posts/set-up-vmtouch-systemd-service.html">Comments</a>


                </div>
            
        <div itemprop="keywords" class="tags">
        <ul>
        Tags : 
           <li><a class="tag p-category" href="categories/emacs/" rel="tag">emacs</a></li>
           <li><a class="tag p-category" href="categories/en/" rel="tag">en</a></li>
           <li><a class="tag p-category" href="categories/linux/" rel="tag">linux</a></li>
           <li><a class="tag p-category" href="categories/systemd/" rel="tag">systemd</a></li>
           <li><a class="tag p-category" href="categories/vmtouch/" rel="tag">vmtouch</a></li>
        </ul>
</div>

            </div>
            <div class="body">
                <div>
<p>
"/etc/default/vmtouch" on Debian Testing,
</p>
<div class="org-src-container">

<pre><code class="lang-ini"># Change to yes to enable running vmtouch as a daemon
ENABLE_VMTOUCH=yes

# User and group to run as
VMTOUCH_USER_GROUP=cb:cb

# Whitespace separated list of files and directories for vmtouch to operate on
VMTOUCH_FILES="/home/cb/.emacs.d/lisp /home/cb/.emacs.d/elpa /home/cb/.emacs.d/site-lisp /home/cb/.mozilla/firefox/linux.default/*.sqlite /home/cb/.mozilla/firefox/linux.default/*.json"

# Options to pass to vmtouch itself. See vmtouch(8).
VMTOUCH_OPTIONS="-q -t"
</code></pre>

</div>
<p>
Run <code>sudo systemctl restart vmtouch</code> to restart the service.
</p>

<p>
"<i>home/cb</i>.emacs.d" is not touched because the package <a href="https://github.com/jorgenschaefer/elpy">elpy</a> will create a sub-directory "elpy" there. This sub-directory is huge. It contains many python libraries.
</p>
</div>
            </div>
        </div>
        <div class="post">
            <h1 class="title"><a href="posts/org-link-and-pdf-tools/">Org link and pdf-tools</a></h1>
            <div class="meta">
                <div class="authordate">
                    <time class="timeago" datetime="2021-05-05T11:34:28+00:00">2021-05-05 11:34</time>
</div>
                <div class="stats">
                    
        
    <a href="posts/org-link-and-pdf-tools/#disqus_thread" data-disqus-identifier="cache/posts/org-link-and-pdf-tools.html">Comments</a>


                </div>
            
        <div itemprop="keywords" class="tags">
        <ul>
        Tags : 
           <li><a class="tag p-category" href="categories/emacs/" rel="tag">emacs</a></li>
           <li><a class="tag p-category" href="categories/en/" rel="tag">en</a></li>
           <li><a class="tag p-category" href="categories/pdf/" rel="tag">pdf</a></li>
        </ul>
</div>

            </div>
            <div class="body">
                <div>
<p>
By default, <a href="https://orgmode.org/manual/External-Links.html">Org pdf link</a> uses <code>doc-view.el</code> to open pdf. So if you move focus over the link <code>docview:papers/last.pdf::NNN</code> in a org file and run <code>M-x org-open-at-point</code>, API <code>doc-view-goto-page</code> is called.
</p>

<p>
These days <a href="https://github.com/politza/pdf-tools">pdf-tools</a> is very popular.
If pdf-tools is installed and enabled, API call of <code>doc-view-goto-page</code> will fail.
</p>

<p>
Below code fixes this problem. It will automatically call correct API with or without pdf-tools.
</p>

<div class="org-src-container">

<pre><code class="lang-lisp">(defun my-org-docview-open-hack (orig-func &amp;rest args)
  (let* ((link (car args)) path page)
    (string-match "\\(.*?\\)\\(?:::\\([0-9]+\\)\\)?$" link)
    (setq path (match-string 1 link))
    (setq page (and (match-beginning 2)
                    (string-to-number (match-string 2 link))))
    (org-open-file path 1)
    (when page
      (cond
       ((eq major-mode 'pdf-view-mode)
        (pdf-view-goto-page page))
       (t
        (doc-view-goto-page page))))))
(advice-add 'org-docview-open :around #'my-org-docview-open-hack)
</code></pre>

</div>
</div>
            </div>
        </div>
        <div class="post">
            <h1 class="title"><a href="posts/use-magit-to-commit-efficiently-and-correctly/">Use Magit to commit efficiently and correctly</a></h1>
            <div class="meta">
                <div class="authordate">
                    <time class="timeago" datetime="2021-03-02T13:06:58+00:00">2021-03-02 13:06</time>
</div>
                <div class="stats">
                    
        
    <a href="posts/use-magit-to-commit-efficiently-and-correctly/#disqus_thread" data-disqus-identifier="cache/posts/use-magit-to-commit-efficiently-and-correctly.html">Comments</a>


                </div>
            
        <div itemprop="keywords" class="tags">
        <ul>
        Tags : 
           <li><a class="tag p-category" href="categories/emacs/" rel="tag">emacs</a></li>
           <li><a class="tag p-category" href="categories/en/" rel="tag">en</a></li>
           <li><a class="tag p-category" href="categories/git/" rel="tag">git</a></li>
           <li><a class="tag p-category" href="categories/magit/" rel="tag">magit</a></li>
        </ul>
</div>

            </div>
            <div class="body">
                <div>
<p>
I prefer using git cli because it's more light weight.
</p>

<p>
Here is my bash alias of <code>git commit</code>,
</p>
<div class="org-src-container">

<pre><code class="lang-sh">alias gc="git commit -m"
</code></pre>

</div>

<p>
The problem of my "cli-only" workflow is it can't detect my mistakes automatically.
</p>

<p>
I often forget to add new code file into git. So my final commit might miss files.
</p>

<div id="outline-container-orgb49333a" class="outline-2">
<h3 id="orgb49333a">Magit UI solution</h3>
<div class="outline-text-2" id="text-orgb49333a">
<p>
One solution is to use <a href="https://magit.vc/">Magit</a> to commit inside Emacs. After commit, I could double check the files inside the hooks provided by Magit.
</p>

<p>
My set up in Emacs,
</p>
<div class="org-src-container">

<pre><code class="lang-lisp">(defun my-lines-from-command-output (command)
  "Return lines of COMMAND output."
  (let* ((output (string-trim (shell-command-to-string command)))
         (cands (nonempty-lines output)))
    (delq nil (delete-dups cands))))

(defun my-hint-untracked-files ()
  "If untracked files and commited files share same extension, warn users."
  (let* ((exts (mapcar 'file-name-extension (my-lines-from-command-output "git diff-tree --no-commit-id --name-only -r HEAD")))
         (untracked-files (my-lines-from-command-output "git --no-pager ls-files --others --exclude-standard"))
         (lookup-ext (make-hash-table :test #'equal))
         rlt)
    ;; file extensions of files in HEAD commit
    (dolist (ext exts)
      (puthash ext t lookup-ext))
    ;; If untracked file has same file extension as committed files
    ;; maybe they should be staged too?
    (dolist (file untracked-files)
      (when (gethash (file-name-extension file) lookup-ext)
        (push (file-name-nondirectory file) rlt)))
    (when rlt
      (message "Stage files? %s" (mapconcat 'identity rlt " ")))))

(with-eval-after-load 'magit
  (defun my-git-check-status ()
    "Check git repo status."
    ;; use timer here to wait magit cool down
    (run-with-idle-timer 1 nil #'my-hint-untracked-files))
  (add-hook 'magit-post-commit-hook #'my-git-check-status)
  (add-hook 'git-commit-post-finish-hook #'my-git-check-status))
</code></pre>

</div>

<p>
Screenshot of step 1 in Emacs,
<img src="wp-content/magit-commit-step1.png" alt="magit-commit-step1.png"></p>

<p>
Screenshot of step 2 (final step) in Emacs (I was reminded of untracked files "bye.js" and "tree.js" at the bottom of UI),
<img src="wp-content/magit-commit-step2.png" alt="magit-commit-step2.png"></p>

<p>
BTW, my actual code in my <code>.emacs.d</code> is <a href="https://github.com/redguardtoo/emacs.d/commit/c62b2b9434ac8e01ed6bd6ee927e66f62df68194">a bit different</a>.
</p>
</div>
</div>
<div id="outline-container-org7c2daee" class="outline-2">
<h3 id="org7c2daee">CLI solution</h3>
<div class="outline-text-2" id="text-org7c2daee">
<p>
Another solution is doing the git thing in shell plus Emacs "-batch" option.
</p>

<p>
Here is my bash setup,
</p>
<div class="org-src-container">

<pre><code class="lang-sh">function gc {
    # check my emacs.d exist
    if [ -f "$HOME/.emacs.d/README.org" ] &amp;&amp; [ "$PWD" != "$HOME/.emacs.d" ]; then
        # magit hook does not work
        git commit -m "$@" &amp;&amp; emacs -batch -Q -l "$HOME/.emacs.d/init.el" --eval "(my-hint-untracked-files)"
    else
        git commit -m "$@"
    fi
}
</code></pre>

</div>

<p>
Please note running <code>magit-commit-create</code> in cli won't work. It's because <code>magit-run-git-async</code> in called and it might lock the git after the cli execution.
</p>

<p>
Screenshot in shell,
<img src="wp-content/magit-commit-in-shell.png" alt="magit-commit-in-shell.png"></p>
</div>
</div>
</div>
            </div>
        </div>
        <div class="post">
            <h1 class="title"><a href="posts/linux-audio-input-configuration/">Linux audio input configuration</a></h1>
            <div class="meta">
                <div class="authordate">
                    <time class="timeago" datetime="2020-11-15T11:07:34+00:00">2020-11-15 11:07</time>
</div>
                <div class="stats">
                    
        
    <a href="posts/linux-audio-input-configuration/#disqus_thread" data-disqus-identifier="cache/posts/linux-audio-input-configuration.html">Comments</a>


                </div>
            
        <div itemprop="keywords" class="tags">
        <ul>
        Tags : 
           <li><a class="tag p-category" href="categories/alsa/" rel="tag">alsa</a></li>
           <li><a class="tag p-category" href="categories/linux/" rel="tag">linux</a></li>
           <li><a class="tag p-category" href="categories/sound/" rel="tag">sound</a></li>
        </ul>
</div>

            </div>
            <div class="body">
                <div>
<p>
Run <code>sudo alsamixer</code> and press "F4" to choose audio input.
</p>

<p>
Make sure the right "Rear Mic" and "Capture" are enabled,
<img src="wp-content/linux-audio-input.png" alt="linux-audio-input.png"></p>

<p>
Run <code>alsamixer</code> and check "pulseaudio" configuration in the same way.
</p>

<p>
Then test audio,
</p>

<div class="org-src-container">

<pre><code class="lang-sh">arecord --duration=5 --format=dat test-mic.wav &amp;&amp; aplay test-mic.wav
</code></pre>

</div>
</div>
            </div>
        </div>
        <div class="post">
            <h1 class="title"><a href="posts/hardcore-spell-checking-in-emacs/">Hardcore spell checking in Emacs</a></h1>
            <div class="meta">
                <div class="authordate">
                    <time class="timeago" datetime="2020-05-17T06:20:55+00:00">2020-05-17 06:20</time>
</div>
                <div class="stats">
                    
        
    <a href="posts/hardcore-spell-checking-in-emacs/#disqus_thread" data-disqus-identifier="cache/posts/hardcore-spell-checking-in-emacs.html">Comments</a>


                </div>
            
        <div itemprop="keywords" class="tags">
        <ul>
        Tags : 
           <li><a class="tag p-category" href="categories/check/" rel="tag">check</a></li>
           <li><a class="tag p-category" href="categories/emacs/" rel="tag">emacs</a></li>
           <li><a class="tag p-category" href="categories/en/" rel="tag">en</a></li>
           <li><a class="tag p-category" href="categories/flyspell/" rel="tag">flyspell</a></li>
           <li><a class="tag p-category" href="categories/spell/" rel="tag">spell</a></li>
        </ul>
</div>

            </div>
            <div class="body">
                <div>
<p>
This article is not introduction of Emacs spell checking basics. It requires deep knowledge of Emacs Lisp and Fly Spell.
</p>

<p>
You could read my article <a href="https://blog.binchen.org/posts/what-s-the-best-spell-check-set-up-in-emacs">What's the best spell check setup in emacs</a> for basic knowledge.
</p>

<p>
This article introduces <b>new techniques to make Fly Spell more powerful and faster</b>.
</p>

<p>
The CLI programs aspell and hunspell can only parse plain text. They don't know any programming language syntax.
</p>

<p>
Fly Spell feeds the output of CLI program into its own Lisp predicate named <code>flyspell-generic-check-word-predicate</code> whose default value is nil.
</p>

<p>
When executing <code>(flyspell-mode 1)</code>, the <a href="https://github.com/emacs-mirror/emacs/blob/c6fb86b40bebf597fccbe4eba58ceea83bd9700f/lisp/textmodes/flyspell.el#L655">per mode predicate is assigned</a> to <code>flyspell-generic-check-word-predicate</code>.
</p>

<p>
For example, you can run <code>(get major-mode 'flyspell-mode-predicate)</code> to get predicate of current major mode, <code>(get 'web-mode 'flyspell-mode-predicate)</code> to get predicate of <code>web-mode</code>.
</p>

<p>
The predicate is a simple function without parameter. Here is my predicate for <code>web-mode</code>,
</p>
<div class="org-src-container">

<pre><code class="lang-lisp">(defun my-web-mode-flyspell-verify ()
  "Fly Spell predicate of `web-mode`."
  (let* ((font-face-at-point (get-text-property (- (point) 1) 'face))
         rlt)
    ;; If rlt is t, the word at point is POSSIBLY a typo, continue checking.
    (setq rlt t)
    ;; if rlt is nil, the word at point is definitely NOT a typo.
    ;; (setq rlt nil)
    rlt))
;; Attach my predicate to `web-mode`
(put 'web-mode 'flyspell-mode-predicate 'my-web-mode-flyspell-verify)
</code></pre>

</div>

<p>
If you read code of <a href="https://github.com/emacs-mirror/emacs/blob/c6fb86b40bebf597fccbe4eba58ceea83bd9700f/lisp/textmodes/flyspell.el#L435">flyspell-prog-mode</a>, you will find it set <code>flyspell-generic-check-word-predicate</code> to its own predicate <code>flyspell-generic-progmode-verify</code>,
</p>
<div class="org-src-container">

<pre><code class="lang-lisp">(defvar flyspell-prog-text-faces
  '(font-lock-string-face font-lock-comment-face font-lock-doc-face)
  "Faces corresponding to text in programming-mode buffers.")

(defun flyspell-generic-progmode-verify ()
  "Used for `flyspell-generic-check-word-predicate' in programming modes."
  (unless (eql (point) (point-min))
    ;; (point) is next char after the word. Must check one char before.
    (let ((f (get-text-property (1- (point)) 'face)))
      (memq f flyspell-prog-text-faces))))
</code></pre>

</div>

<p>
As you can see, <code>flyspell-generic-progmode-verify</code> is very simple. If the word at point is not inside comment or string, the predicate returns nil which means the word is not a typo.
</p>

<p>
So in theory I can write my own predicate by following <code>flyspell-generic-progmode-verify</code>.
</p>

<p>
But in reality it's not as simple as it seems. The predicate is written in Lisp so it's slow. If it contains too much code, Fly Spell process might block other actions in Emacs. Emacs could be un-responsive when editing text.
</p>

<p>
The solution is not to start Fly Spell process too frequently.
</p>

<p>
The <code>flyspell-mode</code> starts checking when <a href="https://github.com/emacs-mirror/emacs/blob/c6fb86b40bebf597fccbe4eba58ceea83bd9700f/lisp/textmodes/flyspell.el#L158">text in current buffer is modified</a>.
</p>

<p>
My solution is not to turn on <code>flyspell-mode</code>. Instead, I manage the spell checking by myself using APIs from flyspell.
</p>

<p>
I only spell check when user saving current buffer. The interval between spell check should not be less than 5 minutes. Spell check is done by calling API <code>flyspell-buffer</code>
</p>

<p>
Checking the whole buffer is still slow. Instead, we can check the text region in current window by calling <code>flyspell-region</code> instead. The api <code>window-total-height</code> returns the height of current Windows. So I can use below code to get the region to check,
</p>
<div class="org-src-container">

<pre><code class="lang-lisp">(let* (beg end (orig-pos (point)))
  (save-excursion
    (forward-line (- (window-total-height)))
    (setq beg (line-beginning-position))
    (goto-char orig-pos)
    (forward-line (window-total-height))
    (setq end (line-end-position)))
  (flyspell-region beg end))
</code></pre>

</div>

<p>
I also need respect the predicate embedded in the major mode in my own generic predicate. Since per mode predicate has already checked the font face, I should <a href="https://github.com/redguardtoo/wucuo/blob/49d2ae558068954eb8c4324b8ee7a6b2b0a00ef9/wucuo.el#L320">skip the font face check in generic predicate if per mode predicate exists</a>.
</p>

<p>
Above algorithms are implemented in <a href="https://github.com/redguardtoo/wucuo">wucuo</a>.
</p>

<p>
Usage,
</p>
<div class="org-src-container">

<pre><code class="lang-lisp">(add-hook 'prog-mode-hook 'wucuo-start)
(add-hook 'text-mode-hook 'wucuo-start)
</code></pre>

</div>

<p>
If <code>wucuo-flyspell-start-mode</code> is "fast" (default value), <code>flyspell-region</code> is used, visible region is checked when user saves current file.
</p>

<p>
If <code>wucuo-flyspell-start-mode</code> is "normal", <code>flyspell-buffer</code> is used, current buffer is checked when user saves current file.
</p>
</div>
            </div>
        </div>
        <div class="post">
            <h1 class="title"><a href="posts/audio-recording-on-linux/">Audio recording on Linux</a></h1>
            <div class="meta">
                <div class="authordate">
                    <time class="timeago" datetime="2020-05-07T12:04:13+00:00">2020-05-07 12:04</time>
</div>
                <div class="stats">
                    
        
    <a href="posts/audio-recording-on-linux/#disqus_thread" data-disqus-identifier="cache/posts/audio-recording-on-linux.html">Comments</a>


                </div>
            
        <div itemprop="keywords" class="tags">
        <ul>
        Tags : 
           <li><a class="tag p-category" href="categories/audio/" rel="tag">audio</a></li>
           <li><a class="tag p-category" href="categories/en/" rel="tag">en</a></li>
           <li><a class="tag p-category" href="categories/linux/" rel="tag">linux</a></li>
        </ul>
</div>

            </div>
            <div class="body">
                <div>
<ul class="org-ul">
<li>Run <code>sudo alsamixer</code> and turn off mic to reduce the noise</li>
<li>Run <code>alsamixer</code> to double check pulse setup</li>
<li>Make sure correct device is selected in <a href="https://www.audacityteam.org/">audacity</a>
</li>
<li>Restart <code>audacity</code> and test</li>
</ul>
<p>
My <code>alsamixer</code> setup,
<img src="wp-content/alsamixer-nq8.png" alt="alsamixer-nq8.png"></p>
</div>
            </div>
        </div>
        <div class="post">
            <h1 class="title"><a href="posts/use-magit-api-to-rebase-to-closest-branch/">Use Magit API to rebase to closest branch</a></h1>
            <div class="meta">
                <div class="authordate">
                    <time class="timeago" datetime="2020-04-14T13:54:28+00:00">2020-04-14 13:54</time>
</div>
                <div class="stats">
                    
        
    <a href="posts/use-magit-api-to-rebase-to-closest-branch/#disqus_thread" data-disqus-identifier="cache/posts/use-magit-api-to-rebase-to-closest-branch.html">Comments</a>


                </div>
            
        <div itemprop="keywords" class="tags">
        <ul>
        Tags : 
           <li><a class="tag p-category" href="categories/emacs/" rel="tag">emacs</a></li>
           <li><a class="tag p-category" href="categories/en/" rel="tag">en</a></li>
           <li><a class="tag p-category" href="categories/git/" rel="tag">git</a></li>
           <li><a class="tag p-category" href="categories/magit/" rel="tag">magit</a></li>
        </ul>
</div>

            </div>
            <div class="body">
                <div>
<p>
My workflow in Git is,
</p>

<ul class="org-ul">
<li>Create a new feature branch based on main branch</li>
<li>Add some small commits into feature branch</li>
<li>Rebase feature branch interactively</li>
</ul>
<p>
The final rebase step happens a lot.
</p>

<p>
So I could use Magit api <code>magit-rebase-interactive</code> to speed up it.
</p>

<p>
The key is to analyze output of <code>git log --decorate --oneline</code> to find the main branch commit.
</p>

<p>
Code,
</p>

<div class="org-src-container">

<pre><code class="lang-lisp">(defun my-git-extract-based (target)
  "Extract based version from TARGET."
  (replace-regexp-in-string "^tag: +"
                            ""
                            (car (nreverse (split-string target ", +")))))

(defun my-git-rebase-interactive (&amp;optional user-select-branch)
  "Rebase interactively on the closest branch or tag in git log output.
If USER-SELECT-BRANCH is not nil, rebase on the tag or branch selected by user."
  (interactive "P")
  (let* ((log-output (shell-command-to-string "git --no-pager log --decorate --oneline -n 1024"))
         (lines (split-string log-output "\n"))
         (targets (delq nil
                        (mapcar (lambda (e)
                                  (when (and (string-match "^[a-z0-9]+ (\\([^()]+\\)) " e)
                                             (not (string-match "^[a-z0-9]+ (HEAD " e)))
                                    (match-string 1 e))) lines)))
         based)
    (cond
     ((or (not targets) (eq (length targets) 0))
      (message "No tag or branch is found to base on."))
     ((or (not user-select-branch)) (eq (length targets) 1)
      ;; select the closest/only tag or branch
      (setq based (my-git-extract-based (nth 0 targets))))
     (t
      ;; select the one tag or branch
      (setq based (my-git-extract-based (completing-read "Select based: " targets)))))

    ;; start git rebase
    (when based
      (magit-rebase-interactive based nil))))
</code></pre>

</div>

<p>
Screencast:
</p>

<div class="figure">
<p><img src="wp-content/magit-rebase-api.gif" alt="magit-rebase-api.gif"></p>
</div>
</div>
            </div>
        </div>
        <div class="post">
            <h1 class="title"><a href="posts/make-emacs-faster-than-vim-in-git-mergetool/">Make Emacs faster than Vim in "git mergetool"</a></h1>
            <div class="meta">
                <div class="authordate">
                    <time class="timeago" datetime="2020-04-10T09:33:40+00:00">2020-04-10 09:33</time>
</div>
                <div class="stats">
                    
        
    <a href="posts/make-emacs-faster-than-vim-in-git-mergetool/#disqus_thread" data-disqus-identifier="cache/posts/make-emacs-faster-than-vim-in-git-mergetool.html">Comments</a>


                </div>
            
        <div itemprop="keywords" class="tags">
        <ul>
        Tags : 
           <li><a class="tag p-category" href="categories/emacs/" rel="tag">emacs</a></li>
           <li><a class="tag p-category" href="categories/en/" rel="tag">en</a></li>
           <li><a class="tag p-category" href="categories/git/" rel="tag">git</a></li>
           <li><a class="tag p-category" href="categories/mergetool/" rel="tag">mergetool</a></li>
        </ul>
</div>

            </div>
            <div class="body">
                <div>
<p>
My article <a href="https://blog.binchen.org/posts/emacs-is-the-best-merge-tool-for-git.html">Emacs is the best merge tool for Git</a> explains how to combine <a href="https://git-scm.com/docs/git-mergetool/2.20.0">git mergetool</a> with <a href="https://www.gnu.org/software/emacs/manual/html_node/ediff/">ediff-mode</a> in Emacs.
</p>

<p>
<a href="https://disqus.com/by/harrisonmccullough/">Harrison McCullough</a> suggested the work flow can be faster if emacs is replaced with emacsclient.
</p>

<p>
I did some research and found a perfect solution. It's even faster than Vim.
</p>

<div id="outline-container-org559cf0f" class="outline-2">
<h3 id="org559cf0f">Initial solution</h3>
<div class="outline-text-2" id="text-org559cf0f">
<p>
Please note emacsclient is only use for resolving conflicts.
</p>

<p>
Step 1, start emacs server by running <code>emacs -Q --daemon --eval "(setq startup-now t)" -l "/home/my-username/.emacs.d/init.el" --eval "(progn (require 'server) (server-start))"</code> in shell.
</p>

<p>
Step 2, insert below code into <code>~/.emacs.d/init.el</code> (see the comment why this advice is required):
</p>
<div class="org-src-container">

<pre><code class="lang-lisp">(defadvice server-save-buffers-kill-terminal (after server-save-buffers-kill-terminal-after-hack activate)
  ;; kill all buffers, so new ediff panel is re-created and `ediff-startup-hook-setup' is called again
  ;; besides, remove the buffers whose binding files are alredy merged in `buffer-list'
  (mapc 'kill-buffer (buffer-list)))
</code></pre>

</div>

<p>
Step 3, insert below code into <code>~/.gitconfig</code>:
</p>
<div class="org-src-container">

<pre><code class="lang-ini">[mergetool.ediff]
cmd = emacsclient -nw --eval \"(progn (setq ediff-quit-hook 'kill-emacs) (if (file-readable-p \\\"$BASE\\\") (ediff-merge-files-with-ancestor \\\"$LOCAL\\\" \\\"$REMOTE\\\" \\\"$BASE\\\" nil \\\"$MERGED\\\") (ediff-merge-files \\\"$LOCAL\\\" \\\"$REMOTE\\\" nil \\\"$MERGED\\\")))\"
</code></pre>

</div>
</div>
</div>
<div id="outline-container-org8bf4369" class="outline-2">
<h3 id="org8bf4369">My real world solution</h3>
<div class="outline-text-2" id="text-org8bf4369">
<p>
It's similar to initial solution. But some scripts are created for automation.
</p>

<p>
Step 1, read <a href="https://www.gnu.org/software/emacs/manual/html_node/emacs/Emacs-Server.html">Using Emacs as a Server</a> in the manual and create <code>~/.config/systemd/user/emacs.service</code> for <a href="https://en.wikipedia.org/wiki/Systemd">Systemd</a>:
</p>
<div class="org-src-container">

<pre><code class="lang-ini">[Unit]
Description=Emacs text editor
Documentation=info:emacs man:emacs(1) https://gnu.org/software/emacs/

[Service]
Type=forking
ExecStart=emacs -Q --daemon --eval "(setq startup-now t)" -l "/home/my-username/.emacs.d/init.el" --eval "(progn (require 'server) (server-start))" 
ExecStop=emacsclient --eval "(kill-emacs)"
Environment=SSH_AUTH_SOCK=%t/keyring/ssh
Restart=on-failure

[Install]
WantedBy=default.target
</code></pre>

</div>

<p>
Step 2, set up in <code>~/.gitconfig</code>:
</p>
<div class="org-src-container">

<pre><code class="lang-ini">[mergetool.emacs]
    cmd = ediff.sh "$LOCAL" "$REMOTE" "$BASE" "$MERGED"
[mergetool.emacsclient]
    cmd = MYEMACSCLIENT=emacsclient ediff.sh "$LOCAL" "$REMOTE" "$BASE" "$MERGED"
</code></pre>

</div>

<p>
Step 3, create <code>ediff.sh</code>:
</p>
<div class="org-src-container">

<pre><code class="lang-sh">#!/bin/sh
[ -z "$MYEMACSCLIENT" ] &amp;&amp; MYEMACSCLIENT="emacs"
# emacsclient won't work in git mergetool
# $1=$LOCAL $2=$REMOTE $3=$BASE $4=$MERGED
if [ "$MYEMACSCLIENT" = "emacs" ]; then
    $MYEMACSCLIENT -nw -Q --eval "(setq startup-now t)" -l "$HOME/.emacs.d/init.el" --eval "(progn (setq ediff-quit-hook 'kill-emacs) (if (file-readable-p \"$3\") (ediff-merge-files-with-ancestor \"$1\" \"$2\" \"$3\" nil \"$4\") (ediff-merge-files \"$1\" \"$2\" nil \"$4\")))"
else
    $MYEMACSCLIENT -nw --eval "(progn (setq ediff-quit-hook 'kill-emacs) (if (file-readable-p \"$3\") (ediff-merge-files-with-ancestor \"$1\" \"$2\" \"$3\" nil \"$4\") (ediff-merge-files \"$1\" \"$2\" nil \"$4\")))"
fi
</code></pre>

</div>

<p>
Step 4, run <code>git mergetool -t emacsclient</code> to resolve conflicts.
</p>

<p>
My <a href="https://github.com/redguardtoo/emacs.d/commit/f35e749d">init-ediff.el</a> in <a href="https://github.com/redguardtoo/emacs.d">emacs.d</a>.
</p>
</div>
</div>
</div>
            </div>
        </div>
    
        <nav class="postindexpager"><ul class="pager">
<li class="next">
                <a href="index-26.html" rel="next">Older posts</a>
            </li>
        </ul></nav><script>var disqus_shortname="chenbin0";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script><footer id="footer"><p>Contents © 2022         <a href="mailto:chenbin.sh@gmail.com">Chen Bin</a> - Powered by         <a href="http://getnikola.com" rel="nofollow">Nikola</a>         </p>
            
        </footer>
</div>
    </section><script src="assets/js/all-nocdn.js" type="text/javascript"></script><script type="text/javascript">
         document.addEventListener('DOMContentLoaded', function() {
           var items = document.getElementsByClassName('timeago'), e, pd;
           for (var i = 0; i < items.length; i++) {
             e = items[i];
             pd = moment(new Date(e.getAttribute('datetime')));
             e.innerHTML = pd.fromNow();
             e.setAttribute('title', pd.format('LLLL'));
           }
         });
        </script>
</body>
</html>
