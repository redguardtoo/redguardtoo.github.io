<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>Javascript code navigation in counsel-etags | Chen's blog</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../rss.xml">
<link rel="canonical" href="http://blog.binchen.org/posts/javascript-code-navigation-in-counsel-etags/">
<!--[if lt IE 9]><script src="/assets/js/html5.js"></script><![endif]--><meta name="author" content="Chen Bin">
<meta property="og:site_name" content="Chen's blog">
<meta property="og:title" content="Javascript code navigation in counsel-etags">
<meta property="og:url" content="http://blog.binchen.org/posts/javascript-code-navigation-in-counsel-etags/">
<meta property="og:description" content="Javascript code navigation is supported by counsel-etags out of box.



It supports new javascript syntax like arrow function because counsel-etags is only frontend.



It reads tags file created by b">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2019-07-22T12:07:16Z">
<meta property="article:tag" content="emacs">
<meta property="article:tag" content="en">
<meta property="article:tag" content="etags">
<meta property="article:tag" content="javascript">
</head>
<body>
    <section class="social"><ul>
<li><a href="../../index.html" title="Home"><i class="icon-home"></i></a></li>
            <li><a href="../../archive.html" title="Archives"><i class="icon-folder-open-alt"></i></a></li>
            <li><a href="../../categories/index.html" title="Tags"><i class="icon-tags"></i></a></li>
            <li><a href="../../rss.xml" title="RSS"><i class="icon-rss"></i></a></li>
            <li><a href="../../stories/about.html" title="About me"><i class="icon-user"></i></a></li>
            <li><a href="https://twitter.com/chen_bin" title="My Twitter"><i class="icon-twitter"></i></a></li>
            <li><a href="https://github.com/redguardtoo" title="My Github"><i class="icon-github"></i></a></li>

        </ul></section><section class="page-content"><div class="content" rel="main">
            
    <div class="post">
    
    <h1 class="p-name entry-title" itemprop="headline name">Javascript code navigation in counsel-etags</h1>

        <div class="meta">
            <div class="authordate">
                <time class="timeago" datetime="2019-07-22T12:07:16+00:00">2019-07-22 12:07</time>
            

            
          |  
        <a href="index.wp" id="sourcelink">Source</a>

            </div>
            
        <div itemprop="keywords" class="tags">
        <ul>
        Tags : 
           <li><a class="tag p-category" href="../../categories/emacs/" rel="tag">emacs</a></li>
           <li><a class="tag p-category" href="../../categories/en/" rel="tag">en</a></li>
           <li><a class="tag p-category" href="../../categories/etags/" rel="tag">etags</a></li>
           <li><a class="tag p-category" href="../../categories/javascript/" rel="tag">javascript</a></li>
        </ul>
</div>

        </div>
        <div class="body">
            <div>
<p>
Javascript code navigation is supported by <a href="https://github.com/redguardtoo/counsel-etags">counsel-etags</a> out of box.
</p>

<p>
It supports new javascript syntax like arrow function because <code>counsel-etags</code> is only frontend.
</p>

<p>
It reads tags file created by backend CLI program <a href="https://github.com/universal-ctags/ctags">Ctags</a>. Ctags uses regular expression to extract tag name from source code.
</p>

<p>
But there are some syntax which regular expression could not help.
</p>

<p>
For example, json object path can't be extracted by regular expression.
</p>

<p>
Given an object <code>a</code> in file A,
</p>
<div class="org-src-container">

<pre><code class="lang-javascript">var a = {
  b: {
    c: 3,
  }
};
</code></pre>

</div>

<p>
File B has code <code>let v1 = a.b.c;</code>, how can we jump to the definition of the field <code>c</code> from json path <code>a.b.c</code>?
</p>

<p>
The solution is to use Lisp to parse code in file A and generate extra navigation data which could be appended to tags file generated by Ctags.
</p>

<p>
The algorithm is simple,
</p>
<ul class="org-ul">
<li>Traverse all the field of object <code>a</code> in file A. Use API <code>js2-print-json-path</code> from <code>js2-mode</code> to get json path of current field.</li>
<li>The json path could be regarded as tags name. We've already got file name and line number. So there is enough information to create navigation data for tags file. Here is <a href="https://en.wikipedia.org/wiki/Ctags">tags file format</a>.</li>
</ul>
<p>
Necessary utilities are already provided by <code>counsel-etags v1.8.7</code>,
</p>
<ul class="org-ul">
<li>After tags files is generated by Ctags, the hook <code>counsel-etags-after-update-tags-hook</code> is executed. Users can append tags file in this hook</li>
<li>
<code>(counsel-etags-tag-line code-snippet tag-name line-number byte-offset)</code> return a line which could be appended into tags file</li>
</ul>
<p>
My current project uses a technology called <a href="https://www.styled-components.com/docs/basics">styled-components</a> which has an advanced feature <a href="https://www.styled-components.com/docs/advanced#theming">theming</a>.
</p>

<p>
It could dynamically change web application's appearance and is a critical technology for our application to support multiple customer. Application's theme is basically a file containing a huge json object. So it's important that developers can jump to the corresponding json object's field by json path.
</p>
<div id="outline-container-orga04d3f9" class="outline-2">
<h3 id="orga04d3f9">Screencast</h3>
<div class="outline-text-2" id="text-orga04d3f9">

<div class="figure">
<p><img src="../../wp-content/counsel-etags-plus-json-path.gif" alt="counsel-etags-plus-json-path.gif"></p>
</div>
</div>
</div>
<div id="outline-container-orgb36f4c0" class="outline-2">
<h3 id="orgb36f4c0">Code</h3>
<div class="outline-text-2" id="text-orgb36f4c0">
<div class="org-src-container">

<pre><code class="lang-lisp">(require 'counsel-etags)

(defun my-manual-update-tag-file (code-file tags-file)
  (let* ((dir (file-name-directory tags-file))
         (path (concat dir code-file))
         curline
         jp
         tagstr)
    (unless (featurep 'js2-mode) (require 'js2-mode))
    (with-temp-buffer
      (insert-file-contents path)
      (js2-init-scanner)
      (js2-do-parse)
      (goto-char (point-min))
      ;; find all js object property names
      (while (re-search-forward "\"?[a-z][a-zA-Z0-9]*\"?:" (point-max) t)
        (when (setq jp (js2-print-json-path))
          (setq curline (string-trim (buffer-substring-no-properties (line-beginning-position)
                                                                     (line-end-position))))
          (setq tagstr (concat tagstr
                               (counsel-etags-tag-line curline
                                                       jp
                                                       (count-lines 1 (point))
                                                       (point)))))
        ;; move focus to next search
        (goto-char (line-end-position))))
    (when tagstr
      (with-temp-buffer
        (insert-file-contents tags-file)
        (goto-char (line-end-position))
        (insert (format "\n\014\n%s,%d\n%s" code-file 0 tagstr))
        (write-region (point-min) (point-max) tags-file nil :silent)))))

(defun counsel-etags-after-update-tags-hook-setup (tags-file)
    (my-manual-update-tag-file "frontend/theming/themes/darkTheme.js" tags-file)
    (my-manual-update-tag-file "frontend/theming/themes/lightTheme.js" tags-file))
(add-hook 'counsel-etags-after-update-tags-hook 'counsel-etags-after-update-tags-hook-setup)
</code></pre>

</div>
</div>
</div>
</div>
        </div>
        
        <ul class="pager hidden-print">
<li class="previous">
                <a href="../dianyou-0-0-3-is-out/" rel="prev" title="dianyou 0.0.3 is out">Previous post</a>
            </li>
            <li class="next">
                <a href="../aspell-0-60-8-will-have-direct-support-for-camelcase-words/" rel="next" title="Aspell 0.60.8 will have direct support for camelCase words">Next post</a>
            </li>
        </ul>
<div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="chenbin0",
            disqus_url="http://blog.binchen.org/posts/javascript-code-navigation-in-counsel-etags/",
        disqus_title="Javascript code navigation in counsel-etags",
        disqus_identifier="cache/posts/javascript-code-navigation-in-counsel-etags.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


        
    


    </div>

        
       <script>var disqus_shortname="chenbin0";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script><footer id="footer"><p>Contents © 2022         <a href="mailto:chenbin.sh@gmail.com">Chen Bin</a> - Powered by         <a href="http://getnikola.com" rel="nofollow">Nikola</a>         </p>
            
        </footer>
</div>
    </section><script src="../../assets/js/all-nocdn.js" type="text/javascript"></script><script type="text/javascript">
         document.addEventListener('DOMContentLoaded', function() {
           var items = document.getElementsByClassName('timeago'), e, pd;
           for (var i = 0; i < items.length; i++) {
             e = items[i];
             pd = moment(new Date(e.getAttribute('datetime')));
             e.innerHTML = pd.fromNow();
             e.setAttribute('title', pd.format('LLLL'));
           }
         });
        </script>
</body>
</html>
